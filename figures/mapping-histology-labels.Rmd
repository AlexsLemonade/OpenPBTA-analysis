---
title: "Mapping histology labels for plots"
output:   
  html_notebook: 
    toc: true
    toc_float: true
author: Candace Savonen for ALSF - CCDL
date: 2021
---

The histology label variables included in `pbta-histologies.tsv` from data releases are not always useful for visualizing the full set of biospecimens due to the large number of different values.
Having too many different possible values makes the colors harder to distinguish.
In addition, there are some groups that are represented by only a very few samples; giving such groups a distinct color may be counterproductive.

The goal of this notebook is to use the currently existing `cancer_group` groups from `pbta-histologies.tsv`, to form group labels that can used for plotting purposes.

## The output table

The output of this notebook is a TSV file: `palettes/histology_label_color_table.tsv` that contains the following fields:

**Copied from `pbta-histologies.tsv`**:    
- `Kids_First_Biospecimen_ID` (from `pbta-histologies.tsv`)  
- All the original histology label variables (`cancer_group`, etc.)  
  
**Created in this notebook**:  
- `display_group` - the high-level cancer group labels that should be used for plotting   
- `hex_codes` the direct colors that should be used for plotting  

With this info, `histology_label_color_table.tsv` can be used by all plots and figures that summarize high level data  while displaying histology information. 

# How `display_group` is made:

- Currently, display_group is completed based on `cancer_group` which is a shorter form of harmonised_diagnsosis
Additionally,
- Other, Benign tumor and Dysplasia/Gliosis from cancer_group
- Neurofibroma/Plexiform;Other updated to Neurofibroma/Plexiform
- Non-germinomatous germ cell tumor;Teratoma updated to Teratoma
- Anaplastic (malignant) meningioma, Meningothelial meningioma and Clear cell meningioma updated to Meningioma
- Embryonal Tumor with Multilayered Rosettes updated to Embryonal tumor with multilayer rosettes

Each `cancer_group` counts as a display_group. 

# Usage

This notebook can be run via the command line from the top directory of the 
repository as follows:

```
Rscript -e "rmarkdown::render('figures/mapping-histology-labels.Rmd', clean = TRUE)"
```


```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

### Directories and Files

```{r}
# Path to input directory
input_dir <- file.path("..", "data")
output_dir <- "palettes"
```

# Read in metadata 

Which variables are we keeping for this table? 

```{r}
histology_variables <- 
  c("integrated_diagnosis", 
    "Notes", 
    "harmonized_diagnosis",
    "broad_histology", 
    "short_histology",
    "cancer_group")
```

Let's read in the current release's `pbta-histologies.tsv` file. 

```{r}
metadata <-
  readr::read_tsv(file.path(input_dir, "pbta-histologies.tsv"), guess_max = 10000)
```

Now we'll select histology variables we mentioned above 
```{r}
working_metadata <- metadata %>% 
  dplyr::select(Kids_First_Biospecimen_ID, sample_type, histology_variables) 
```

# Take a look at how many biospecimens per `cancer_group` group

Let's summarize `cancer_group`. 
Because the `Normal` samples don't have histologies, we'll look at just the `Tumor` samples at for this summary. 

```{r}
cancer_group_summary <- working_metadata %>% 
  dplyr::filter(sample_type == "Tumor") %>%
  dplyr::count(cancer_group) %>% 
  dplyr::arrange(n) 
```

Let's print out the summary. 

```{r}
cancer_group_summary %>% 
  knitr::kable()
```

There's handful of very small groups (many are n = 2). 

# Make new `display_group` for samples with a cancer_group value

```{r}
histology_table <- working_metadata %>% 
  dplyr::filter(!is.na(cancer_group)) %>%
  dplyr::mutate(
    # Put this as a character for later handling
    display_group = as.character(cancer_group)
    )
```

Print out the number of `display_group` (including `normal`)!

```{r}
display_group_df <- histology_table %>% 
  dplyr::count(display_group) %>% 
  dplyr::arrange(n)

knitr::kable(display_group_df)
```

Only keep display_groups that have >=5 counts
```{r}

display_group_df <- display_group_df %>%
  dplyr::filter(n >=5)

nrow(display_group_df)
```


Make this notebook stop if there are more than 38 histology groups

```{r}
if (nrow(display_group_df) > 38) {
  stop("There are more than 38 categories in `display_group`. We may want to re-evaluate the high-level histology groupings")
}
```

# Make `display_order`

Get ranks in order of big to small and make them into a new column in `display_group_df`. 


```{r}
display_order_df <- display_group_df %>% 
  dplyr::mutate(display_group = forcats::fct_reorder(display_group, n, .desc = TRUE),
                display_order = as.numeric(display_group)) # save the factor order for text table export
```

Add on the `display_order` column using `inner_join`.

```{r}
histology_table <- histology_table %>%
  # Join on the display orders
  dplyr::inner_join(display_order_df, by = "display_group") 
```

# Add hex codes 

These hex codes were retrieved from http://phrogz.net/css/distinct-colors.html with the settings on default for 38 colors.

```{r}
color_palette <- 
  c("#330000", "#f27979", "#332726", "#b2362d", "#f2bab6", "#66211a", "#806560", "#ff6c40", "#331100", "#bf8060", "#4c3426", "#7f3700", "#ff7700", "#f2d2b6", "#99754d", "#e58a00", "#331f00", "#664100", "#e5bb73", "#8c7f69", "#403a30", "#f2c200", "#998a00", "#fff280", "#fff700", "#313300", "#61661a", "#c4cc99", "#8ab32d", "#aaff00", "#89f279", "#004d03", "#1a331b", "#00f220", "#b6f2c4", "#00993d", "#4d6657", "#40805b"
)
```

Declare how many colors we need. 

```{r}
n_colors <- nrow(display_group_df)
```

Make a named list color key where histologies are the names. 

```{r}
# Set seed so the colors are consistent upon re-run
set.seed(2021)

# Sample from the 18 colors
subset_colors <- sample(color_palette, n_colors)
names(subset_colors) <- display_group_df$display_group
```

Use `pie` function to preview what these look like.

```{r}
pie(rep(1, n_colors), 
    col = subset_colors, 
    labels = names(subset_colors))
```

Add the hex codes to the `histology_table`. 

```{r}
histology_table <- histology_table %>%
  # Add the hex_codes
  dplyr::mutate(hex_codes = dplyr::recode(display_group, !!!subset_colors)) %>% 
  # Restore capitalization so its pretty for labeling
  dplyr::mutate(display_group = stringr::str_to_sentence(display_group)
                )
```

## Save to TSV 

```{r}
readr::write_tsv(histology_table, file.path(output_dir, "histology_label_color_table.tsv"))
```

# Session Info

```{r}
sessionInfo()
```

