# S. Spielman for ALSF CCDL 2022
#
# Makes pdf panels for reporting TP53 and telomerase results in main text

library(tidyverse)

# Establish base dir
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

# Declare output directory
output_dir <- file.path(root_dir, "figures", "pdfs", "fig4", "panels")
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Data directory
data_dir <- file.path(root_dir, "data")

# Analysis directory
analyses_dir <- file.path(root_dir, "analyses")
tp53_dir <- file.path(analyses_dir, "tp53_nf1_score")
telomerase_dir <- file.path(analyses_dir, "telomerase-activity-prediction")

# Palette directory
palette_dir <- file.path(root_dir, "figures", "palettes")

# Read in clinical data and associated palette
histologies_df <- read_tsv(file.path(data_dir, "pbta-histologies.tsv"),
                           guess_max = 10000)
histologies_palette_df <- read_tsv(file.path(palette_dir, "broad_histology_cancer_group_palette.tsv"))
binary_palette_df <- readr::read_tsv(file.path(palette_dir, "binary_color_palette.tsv"))

# Read in tp53 data for ROC
tp53_roc_stranded       <- read_tsv(file.path(tp53_dir, "results", "stranded_TP53_roc_threshold_results.tsv"))
tp53_roc_stranded_shuff <- read_tsv(file.path(tp53_dir, "results", "stranded_TP53_roc_threshold_results_shuffled.tsv"))


# Read in tp53 data file for violin plots
tp53_compare <- read_tsv(file.path(tp53_dir, "results", "tp53_altered_status.tsv"))
stranded_expression <- read_rds(file.path(data_dir,"pbta-gene-expression-rsem-fpkm-collapsed.stranded.rds"))


# Read in EXTEND scores. We read Stranded FPKM here. 
extend_scores <- read_tsv(file.path(telomerase_dir, "results", "TelomeraseScores_PTBAStranded_FPKM.txt"))

# Read in TMB for highlighting points in boxplots
tmb_coding_df <- read_tsv(file.path(data_dir, "pbta-snv-consensus-mutation-tmb-coding.tsv"))
                            

#### Define output PDF panels ----------------------------------------------------------------
tp53_roc_pdf                        <- file.path(output_dir, "tp53_stranded_roc_panel.pdf")
tp53_scores_altered_pdf             <- file.path(output_dir, "tp53_scores_by_altered_panel.pdf") 
tp53_expression_altered_pdf         <- file.path(output_dir, "tp53_expression_by_altered_panel.pdf") 
tp53_telomerase_scores_boxplot_pdf        <- file.path(output_dir, "tp53_telomerase_boxplots_panel.pdf") 
tp53_telomerase_scores_boxplot_legend_pdf <- file.path(output_dir, "tp53_telomerase_boxplots_panel_legend.pdf")
#forest_plot_pdf                     <- file.path(output_dir, "forest_survival_tp53_telomerase_hgg_panel.pdf") 



### ROC curve ---------------------------------------------------------------------------------

# Create data frame that will plot ROC
roc_df <- bind_rows(tp53_roc_stranded, tp53_roc_stranded_shuff) %>%
  mutate(auroc = round(auroc, 2),
         shuffled = ifelse(shuffled, 'TP53 Shuffle', 'TP53'),
         Classifier = paste0(shuffled, ' (AUROC = ', auroc,')'))

# prep in binary color palette
binary_scale <- binary_palette_df$hex_codes[binary_palette_df$color_names != "na_color"]


# Make the ROC curve
roc_plot <- ggplot(roc_df) + 
  aes(
    x = fpr,  
    y = tpr
  ) +
  geom_step(
    aes(color = Classifier), 
    size = 0.75
  ) + 
  geom_segment(
    aes(x = 0, y = 0, xend = 1, yend = 1), 
    color = "black"
  ) +
  coord_fixed() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_continuous(labels = scales::percent) +
  scale_color_manual(values = binary_scale) +
  labs(
    x = "False Positive Rate",
    y = "True Positive Rate") + 
  ggpubr::theme_pubr() +
  theme(legend.text = element_text(size = rel(0.7)),
        legend.title = element_text(size = rel(0.7)),
        axis.text = element_text(size = rel(0.75)),
        axis.title = element_text(size = rel(0.75))
  )
ggsave(tp53_roc_pdf, roc_plot, width = 5, height = 5) 




 ### TP53 scores and expression violin plots -----------------------------------------------------------
# We do not use color palettes since the color mappings will necessarily change across figures.
# We use ggplot instead of ggpubr because of jitter styling (ggpubr jitter point placement is deterministic)


# Function to plot both TP53 violin plots (score across altered and expression across altered)
plot_tp53 <- function(df, pvalue_y) {
  # df: Assumes two columns: the variable of interest (either tp53_score, tp53_expression) is named tp53, and column tp53_altered with three values
  # pvalue_y: y-axis coordinate of p-value annotation. Note that the x-axis coordinate is always the same
  
  # Perform test for variable without `other`
  df_2cat <- filter(df, tp53_altered != "other")
  # Prepare for use with `stat_pvalue_manual()`
  wilcox_df <- ggpubr::compare_means(tp53 ~ tp53_altered, 
                             data = df_2cat,
                             method = "wilcox.test") %>%
    mutate(y.position = pvalue_y)
  
  # Prepare stats df for median +/ IQR
  stats_df <- df %>%
    group_by(tp53_altered) %>%
    summarize(
      y = median(tp53, na.rm=TRUE),
      ymin = quantile(tp53, 0.25, na.rm=TRUE),
      ymax = quantile(tp53, 0.75, na.rm=TRUE)
    )
  
  # Plot, with seed for jitter
  set.seed(4)
  ggplot(df) +
    aes(x = tp53_altered, 
        y = tp53) +
    geom_violin() + 
    geom_jitter(alpha = 0.25, # very light alpha to accomodate `other` category
                width = 0.1, 
                size = 1) + 
    # Add median +/- IQR pointrange
    geom_pointrange(data = stats_df, 
                    aes(
                      x = tp53_altered,
                      y = y,
                      ymin = ymin,
                      ymax = ymax
                    ),
                    color = "firebrick", size = rel(0.6)
    ) +
    # Add p-value annotation with ggpubr
    ggpubr::stat_pvalue_manual(
      wilcox_df, 
      label = "Wilcoxon P-value = {p.adj}"
    ) +
    ggpubr::theme_pubr() 
}

# change `loss` --> `lost` for grammatical consistency
tp53_compare <- tp53_compare %>%
  mutate(tp53_altered = case_when(
    tp53_altered == "loss" ~ "lost", 
    TRUE ~ tp53_altered
  ))

# Prepare expression data
# subset to TP53
subset_stranded <- t(stranded_expression)[,"TP53"]
# Join STRANDED expression with tp53 alteration
# Note that because this is stranded only, it has fewer data points.
stranded_tp53 <- as.data.frame(subset_stranded) %>%
  rename(tp53_expression=subset_stranded) %>%
  rownames_to_column(var = "Kids_First_Biospecimen_ID_RNA") %>%
  # easier to work with
  as_tibble() %>%
  inner_join(tp53_compare, by = "Kids_First_Biospecimen_ID_RNA") %>%
  # keep only columns we need
  select(Kids_First_Biospecimen_ID_RNA, tp53_expression, tp53_altered) %>%
  distinct()


# Make the figures
tp53_scores_plot <- tp53_compare %>%
  rename(tp53 = tp53_score) %>%
  ### ggplot
  plot_tp53(pvalue_y = 1.05) +
  # add labels for this plot
  labs(
    x = "TP53 altered status",
    y = "TP53 score"
  )


tp53_expression_plot <- stranded_tp53 %>%
  rename(tp53 = tp53_expression) %>%
  ### ggplot
  plot_tp53(pvalue_y = 80) +
  # add labels for this plot
  labs(
    x = "TP53 altered status",
    y = "TP53 expression (FPKM)"
  )


# Export figures
ggsave(tp53_scores_altered_pdf, tp53_scores_plot, width = 6, height = 4)
ggsave(tp53_expression_altered_pdf, tp53_expression_plot, width = 6, height = 4)




## TP53 and telomerase scores boxplots across cancer groups with mutators emphasized -------------------------------------------


# Define cancer groups to show in boxplots
cancer_groups_to_plot <- c(
  "Diffuse midline glioma",
  "Low-grade glioma astrocytoma",
  "Craniopharyngioma",
  "High-grade glioma astrocytoma",
  "Ganglioglioma",
  "Medulloblastoma",
  "Meningioma",
  "Ependymoma",
  "Schwannoma",
  "Dysembryoplastic neuroepithelial tumor"
)

# Cancer group wrap number of characters for labeling x-axis in boxplots
cg_wrap <- 20

# Create combined data frame of mutator information, tp53 scores, and telomerase scores (NormEXTENDScores)
# Join tmb_coding_df with tp53_compare first, because both have DNA identifiers. 
# Since tp53_compare also has the RNA identifier,then we can join with extend_scores
tp53_telo_mutator_df <- tmb_coding_df %>%
  # columns of interest
  select(Kids_First_Biospecimen_ID_DNA = Tumor_Sample_Barcode, # consistent naming for joining
         tmb) %>%
  # add a column about mutator
  mutate(
    mutator = case_when(
      tmb < 10 ~ "Normal",
      tmb >= 10 & tmb < 100 ~ "Hypermutant",
      tmb >= 100 ~ "Ultra-hypermutant")
  ) %>%
  # join with tp53_compare
  inner_join(
    select(tp53_compare,
           Kids_First_Biospecimen_ID_DNA,
           Kids_First_Biospecimen_ID_RNA,
           tp53_score),
    by = "Kids_First_Biospecimen_ID_DNA"
  ) %>%
  # rename RNA column for joining
  rename(Kids_First_Biospecimen_ID = Kids_First_Biospecimen_ID_RNA) %>%
  # join with extend_scores using RNA column
  inner_join(
    select(extend_scores, 
           Kids_First_Biospecimen_ID = SampleID, # rename for joining
           telo_score = NormEXTENDScores
    )
  )

  
# Prepare combined data for visualization
plot_df <- tp53_telo_mutator_df %>%
  # add in histology information
  inner_join(
    select(histologies_df,
           Kids_First_Biospecimen_ID,
           cancer_group)
  ) %>%
  # add in palette information
  inner_join(
    select(histologies_palette_df,
           cancer_group,
           cancer_group_display, 
           cancer_group_hex)
  ) %>%
  # filter to cancer groups of interest
  filter(cancer_group %in% cancer_groups_to_plot) %>%
  # duplicate the tp53 scores column so we can eventually order can groups by it
  mutate(tp53_forordering = tp53_score) %>%
  # we want a single column for all scores so we can facet by scores
  # first, change naming for facet labels:
  rename(`Telomerase score` = telo_score,
         `TP53 score` = tp53_score) %>%
  gather(contains("score"), 
         key = "score_type", 
         value = "score") %>%
  # order TP53 on top
  mutate(score_type = fct_relevel(score_type, "TP53 score")) %>%
  # wrap cancer group label
  mutate(cancer_group_display = str_wrap(cancer_group_display, cg_wrap))


# Define colors to use
legend_colors <- c(Normal      = "grey40",
                   Hypermutant = "orange",
                   `Ultra-hypermutant` = "red")
# Other plot parameters which need to be re-introduced in legend:
normal_alpha <- 0.7
normal_size <- 1.75
mutator_size <- 2.25
normal_pch <- 19
mutator_pch <- 21
jitter_width <- 0.15 # not in legend but often in main plot

# Boxplot with overlayed jitter with colors "mapped" to `mutator`
set.seed(14) # reproducible jitter to ensure we can see all N=6 points in BOTH facets
tp53_telo_tmb_boxplot <- ggplot(plot_df) +
  aes(
    x = fct_reorder(cancer_group_display, tp53_forordering), # order cancer groups by tp53 score
    y = score
  ) +
  geom_boxplot(
    outlier.shape = NA, # no outliers
    color = "grey20",    # dark grey color
    size = 0.4 
  ) +
  # Separate out jitters so that the mutant layers are ON TOP OF normal
  geom_jitter(
    data = plot_df[plot_df$mutator == "Normal",],
    width = jitter_width, 
    alpha = normal_alpha,
    size = normal_size,
    pch = normal_pch,
    color = legend_colors["Normal"]
  ) +
  geom_jitter(
    data = plot_df[plot_df$mutator == "Hypermutant",],
    width = jitter_width, 
    pch = mutator_pch,
    size = mutator_size,
    fill = legend_colors["Hypermutant"]
  ) +  
  geom_jitter(
    data = plot_df[plot_df$mutator == "Ultra-hypermutant",],
    width = jitter_width, 
    pch = mutator_pch,
    size = mutator_size,
    fill = legend_colors["Ultra-hypermutant"]
  ) +  
  labs(x = "Cancer group", 
       y = "Score") +
  facet_wrap(~score_type, nrow = 2) +
  # do we want an hline at 0.5? Might be useful guiding line but also add unnecessary visual noise
  # geom_hline(yintercept = 0.5) +
  ggpubr::theme_pubr() +
  theme(
    axis.text.x = element_text(angle = 45, hjust=1, size = rel(0.8))
  )

# Export plot
ggsave(tp53_telomerase_scores_boxplot_pdf,
       tp53_telo_tmb_boxplot,
       width = 9, height = 6)

# Make a legend for the grey/orange/red since this was not done with normal mapping
# We have to make a "fake" plot for this to extraxt the legend from
tp53_plot_legend_df <- plot_df %>%
  mutate(mutator_factor = factor(mutator, levels=names(legend_colors)))

tp53_plot_for_legend <- ggplot(tp53_plot_legend_df) + 
  aes(x = cancer_group, y = tmb, shape = mutator_factor, fill = mutator_factor, color = mutator_factor, size = mutator_factor, alpha = mutator_factor) +
  geom_point(size =3) + 
  scale_size_manual(name = "Mutator", values = c(normal_size, mutator_size, mutator_size))+
  scale_shape_manual(name = "Mutator", values = c(normal_pch, mutator_pch, mutator_pch)) +
  scale_alpha_manual(name = "Mutator", values = c(normal_alpha, 1, 1))+
  scale_color_manual(name = "Mutator",values = c(unname(legend_colors["Normal"]), "black", "black")) + # for reasons (?) this apparently needs unname(). weird since fill doesnt
  scale_fill_manual(name = "Mutator", values = c("black", legend_colors["Hypermutant"], legend_colors["Ultra-hypermutant"])) +
  # theme to remove gray background. this strategy works
  theme_classic()


legend <- cowplot::get_legend(tp53_plot_for_legend)

# Export legend
pdf(tp53_telomerase_scores_boxplot_legend_pdf, width = 6, height = 3)
cowplot::ggdraw(legend)
dev.off()



