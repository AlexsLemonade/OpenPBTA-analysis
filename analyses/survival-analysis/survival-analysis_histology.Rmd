---
title: "Survival analysis by TP53 and telomerase activity"
output: html_notebook
---

This notebook will do the following survival analysis

1. Univariate analysis 
- HGG vs. non-HGG

2. Multivariate analysis
- TP53 classifier score, EXTEND score and cancer group
- TP53 classifier score, EXTEND score and HGG group

3. Plots
- Bivariate distribution of TP53 classifier score and EXTEND score in density plot stratified by HGAT status

## Setup

#### Packages and functions

Read in set up script.

```{r Set up library}
library(survival)
library(dplyr)
library(ggplot2)
library(ggpubr)
```

#### Set up files and directories

Set up output directories. 

```{r Set up directories}
data_dir <- file.path("..", "..", "data")
analysis_dir <- file.path("..", "..", "analyses")
figure_dir <- file.path("..", "..", "figures")

results_dir <- "results"
plots_dir <- "plots"
```

Make output directories.

```{r Make output directories}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

## Declare the direcotry for all the data to be used 

```{r define data path}
metadata_file <- file.path(data_dir, "pbta-histologies.tsv")
# only use stranded since tp53 scores for polyA did not have good accuracy
tp53_file <- file.path(analysis_dir, 
                        "tp53_nf1_score/results/tp53_altered_status.tsv")
tel_stranded_file <- file.path(analysis_dir,
                         "telomerase-activity-prediction/results/TelomeraseScores_PTBAStranded_FPKM.txt")
tel_polya_file <- file.path(analysis_dir, "telomerase-activity-prediction/results/TelomeraseScores_PTBAPolya_FPKM.txt")
```

## Import the metadata

```{r Read in metadata}
# get primary tumor and remove cell lines
histologies_rna <- readr::read_tsv(metadata_file, guess_max = 10000) %>%
  dplyr::filter(composition=="Solid Tissue" & 
                  tumor_descriptor == "Initial CNS Tumor" &
                  experimental_strategy == "RNA-Seq" & 
                  RNA_library == "stranded") %>%
  dplyr::rename(Kids_First_Biospecimen_ID_RNA = Kids_First_Biospecimen_ID) %>% 
  dplyr::select(Kids_First_Participant_ID, Kids_First_Biospecimen_ID_RNA, cancer_group, OS_status, OS_days, PFS_days) %>%
  distinct() %>%
  dplyr::arrange(Kids_First_Biospecimen_ID_RNA)

# read in tp53 scores
tp53_scores <- readr::read_tsv(tp53_file) %>%
  select(Kids_First_Biospecimen_ID_DNA, Kids_First_Biospecimen_ID_RNA, sample_id, tp53_score) %>%
  dplyr::arrange(Kids_First_Biospecimen_ID_RNA)

# read in telomerase scores
tel_scores_stranded <- readr::read_tsv(tel_stranded_file) %>%
  dplyr::rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                telomerase_score = NormEXTENDScores) %>%
  dplyr::arrange(Kids_First_Biospecimen_ID_RNA)

tel_scores_polya <- readr::read_tsv(tel_polya_file) %>%
  dplyr::rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                telomerase_score = NormEXTENDScores) %>%
  dplyr::arrange(Kids_First_Biospecimen_ID_RNA) 

# combine telomerase dfs
tel_scores <- bind_rows(tel_scores_stranded, tel_scores_polya)

# combine tp53 scores and telomerase score to the dataframe
meta_indep <- histologies_rna %>%
  # add tp53 and telomerase scores by matching Kids_First_Biospecimen_ID_RNA
  left_join(tp53_scores, by = "Kids_First_Biospecimen_ID_RNA") %>%
  left_join(tel_scores, by = "Kids_First_Biospecimen_ID_RNA") %>% 
  dplyr::arrange(Kids_First_Biospecimen_ID_RNA) %>%
  dplyr::distinct(Kids_First_Participant_ID, .keep_all=TRUE) %>%
    #remove samples without survival data
  filter(!is.na(OS_days)) %>%
  # recode the categories - 
  # DECEASED maps to a survival event status of 1, LIVING maps to a censored observation with value 0
  dplyr::mutate(OS_status_fixed = case_when(
    OS_status == "LIVING" ~ 0,
    OS_status == "DECEASED" ~1
 )) %>% 
  dplyr::mutate(OS_years = OS_days / 365.25)

nrow(meta_indep)
```
 
### Categorical variable cancer group and HGG or not 
```{r}
# separate into HGG or non-HGG
meta_indep <- meta_indep %>% 
  dplyr::mutate(hgg_group = case_when(
    cancer_group %in% c("High-grade glioma astrocytoma", "Diffuse midline glioma", "Diffuse intrinsic pontine glioma") ~ "HGAT",
    !cancer_group %in% c("High-grade glioma astrocytoma", "Diffuse midline glioma", "Diffuse intrinsic pontine glioma") ~ "non-HGAT"
  ))

# make non-HGAT the reference level
meta_indep$hgg_group <- factor(meta_indep$hgg_group, levels = c("non-HGAT", "HGAT"))

# select cancer groups with higher Ns - removed LGG and Ganglioglioma because LGG only has one deceased and all ganglio pts are living
cancer_groups_of_interest <- c("Medulloblastoma", "Ependymoma", "High-grade glioma astrocytoma", "Atypical Teratoid Rhabdoid Tumor", "Craniopharyngioma", "Diffuse midline glioma")

meta_cg_subset <- meta_indep %>%
  filter(cancer_group %in% cancer_groups_of_interest)
```

## Log Rank analysis 
### Generate output for categorical files 
```{r}
# define the independent variable that we are using for analyzing survival
ind_var <- "cancer_group"

# define model
model <- paste0("survival::Surv(time = OS_years, event = OS_status_fixed) ~ ", ind_var)

# run survival analysis
fit <- survival::survdiff(formula(model),
                          data = meta_cg_subset)
# Obtain p value for Chi-Squared stat
fit$p.value <- pchisq(fit$chisq, df = length(fit$n) - 1, lower = FALSE)

print(fit)
# save the output
saveRDS(fit, file.path(results_dir, paste0("log_rank_survival_per_", ind_var, ".RDS")))

# generate plots fit
fit_plot <- survfit(formula(model), data = meta_cg_subset)

# output the plot
pdf(file.path(plots_dir, paste0("logrank_survival_per_", ind_var, ".pdf")))
plot_logrank <- survminer::ggsurvplot(fit_plot,
                                      data=meta_cg_subset,
                                      xlim = c(0, 14),
                                      break.time.by = 1,
                                      pval = TRUE, 
                                      conf.int = TRUE,
                                      risk.table = TRUE, # Add risk table
                                      linetype = "strata", # Change line type by groups
                                      surv.median.line = "hv", # Specify median survival
                                      ggtheme = theme_bw())
print(ggpar(plot_logrank[[1]], font.legend=6, legend="right"))
print(ggpar(plot_logrank[[2]], font.legend=6))

dev.off()

print(ggpar(plot_logrank[[1]], font.legend=6, legend="right"))
print(ggpar(plot_logrank[[2]], font.legend=6))


```

## Multivariate analysis 
### Comparison made is `tp53_score*telomerase_score*hgg_group` 
"Hazard ratio above 1 indicates a covariate that is positively associated with the event probability, and thus negatively associated with the length of survival.

In summary,

HR = 1: No effect
HR < 1: Reduction in the hazard
HR > 1: Increase in Hazard" 

The Cox regression results can be interpreted as follow:
_Statistical significance._ The column marked “z” gives the Wald statistic value. It corresponds to the ratio of each regression coefficient to its standard error (z = coef/se(coef)). The wald statistic evaluates, whether the beta (β) coefficient of a given variable is statistically significantly different from 0. From the output above, we can conclude that the variable sex have highly statistically significant coefficients.

_The regression coefficients._ The second feature to note in the Cox model results is the the sign of the regression coefficients (coef). A positive sign means that the hazard (risk of death) is higher, and thus the prognosis worse, for subjects with higher values of that variable. The variable sex is encoded as a numeric vector. 1: male, 2: female. The R summary for the Cox model gives the hazard ratio (HR) for the second group relative to the first group, that is, female versus male. The beta coefficient for sex = -0.53 indicates that females have lower risk of death (lower survival rates) than males, in these data.

_Hazard ratios._ The exponentiated coefficients (exp(coef) = exp(-0.53) = 0.59), also known as hazard ratios, give the effect size of covariates. For example, being female (sex=2) reduces the hazard by a factor of 0.59, or 41%. Being female is associated with good prognostic.

_Confidence intervals of the hazard ratios._ The summary output also gives upper and lower 95% confidence intervals for the hazard ratio (exp(coef)), lower 95% bound = 0.4237, upper 95% bound = 0.816.

_Global statistical significance of the model._ Finally, the output gives p-values for three alternative tests for overall significance of the model: The likelihood-ratio test, Wald test, and score logrank statistics. These three methods are asymptotically equivalent. For large enough N, they will give similar results. For small N, they may differ somewhat. The Likelihood ratio test has better behavior for small sample sizes, so it is generally preferred.


Below, HR = exp(coeff) 

([ref](http://www.sthda.com/english/wiki/cox-proportional-hazards-model))
```{r}
# define multi-variates that we are using for analyzing survival
ind_var <- "tp53_score*telomerase_score*hgg_group"

# define model
model <- paste0("survival::Surv(time = OS_years, event = OS_status_fixed) ~ ", ind_var)

fit <- survival::coxph(
      formula(model),
      data = meta_indep,
    )
# generate output
table <- broom::tidy(fit) 

# Save the table data in a TSV
readr::write_tsv(table, file.path(results_dir, paste0("cox_reg_results_per_", ind_var, ".tsv")))

print(table)

# printout the plot
forest_coxph <- survminer::ggforest(fit, data = meta_indep)
print(forest_coxph)


```


### Further we want to separate into cancer groups and see how tp53 and telomerase affect survival in each group
```{r}
## define multi-variates that we are using for analyzing survival
ind_var <- "tp53_score*telomerase_score"

# define model
model <- paste0("survival::Surv(time = OS_years, event = OS_status_fixed) ~ ", ind_var)

for(each in cancer_groups_of_interest){
  # find the meta file
  meta_df <- meta_cg_subset %>%
    filter(cancer_group == each)
  
  fit <- survival::coxph(
      formula(model),
      data = meta_df,
    )
# generate output
table <- broom::tidy(fit) 

# Save the table data in a TSV
readr::write_tsv(table, file.path(results_dir, paste0("cox_reg_results_per_", ind_var,"_", each, ".tsv")))

print(table)

# printout the plot
forest_coxph <- survminer::ggforest(fit, data = meta_df,
                                    main = paste0("Hazard Ratio for ", each))
print(forest_coxph)
}

```




## Bivariate density plot of tp53 score and telomerase activity score stratified by HGG group
```{r}

tp53_vs_telomerase <- ggplot(meta_indep, aes(x = tp53_score, y = telomerase_score))
tp53_vs_telomerase + 
  geom_density_2d(aes(color = hgg_group)) +
  labs(subtitle = "Density stratified by HGG group") +
  xlim(-0.1,1.2) +
  theme_bw()

```


## Session Info

```{r Print session info}
sessionInfo()
```