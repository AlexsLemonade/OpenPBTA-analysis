---
title: "Survival analysis by TP53 and telomerase activity"
output: html_notebook
---

This notebook will do the following survival analysis
1. Univariate analysis 
- TP53 classifier score (as a continuous variable)
- EXTEND score (as a continuous variable)
- Cancer group, removing cancer groups with less than 10 samples
- HGG vs. non-HGG

2. Multivariate analysis
- TP53 classifier score, EXTEND score and whatever disease label we determine is appropriate

3. Plots
- Probably a forest plot will be generated to display the information.

## Setup

#### Packages and functions

Read in set up script.

```{r Set up library}
library(survival)
library(dplyr)
library(ggplot2)
library(ggpubr)
```

#### Set up files and directories

Set up output directories. 

```{r Set up directories}
data_dir <- file.path("..", "..", "data")
analysis_dir <- file.path("..", "..", "analyses")
figure_dir <- file.path("..", "..", "figures")

results_dir <- "results"
plots_dir <- "plots"
```

Make output directories.

```{r Make output directories}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

## Declare the direcotry for all the data to be used 

```{r define data path}
metadata_file <- file.path(data_dir, "pbta-histologies.tsv")
indep_file <- file.path(data_dir,
                         "independent-specimens.rnaseq.primary-plus-stranded.tsv")
tp53_file <- file.path(analysis_dir, 
                        "tp53_nf1_score/results/tp53_altered_status.tsv")
# only use stranded since tp53 scores for polyA did not have good accuracy
tel_stranded_file <- file.path(analysis_dir,
                         "telomerase-activity-prediction/results/TelomeraseScores_PTBAStranded_FPKM.txt")
# color palette
 color_file <- file.path(figure_dir, "palettes/broad_histology_cancer_group_palette.tsv")
```

## Import the metadata

```{r Read in metadata}
# read in histologies file
indep_rna <- readr::read_tsv(indep_file)

# remove cell lines by selecting only solid tissue
histologies <- readr::read_tsv(metadata_file, guess_max = 10000) %>%
 dplyr::filter(composition=="Solid Tissue" & tumor_descriptor == "Initial CNS Tumor") %>%
 select(sample_id, broad_histology, cancer_group, molecular_subtype, OS_status, OS_days, PFS_days) %>%
 distinct()

# read in tp53 scores
tp53_scores <- readr::read_tsv(tp53_file) %>%
 select(Kids_First_Biospecimen_ID_DNA, Kids_First_Biospecimen_ID_RNA, sample_id, tp53_score)

# read in telomerase scores
tel_scores <- readr::read_tsv(tel_stranded_file) %>%
 mutate(Kids_First_Biospecimen_ID_RNA = SampleID,
        telomerase_score = NormEXTENDScores) %>%
 select(Kids_First_Biospecimen_ID_RNA, telomerase_score)

# remove samples without RNA-Seq since both classifiers' results use RNA-Seq
# independent use primary plus rna-seq samples
meta_indep <- tp53_scores %>%
  left_join(tel_scores) %>%
  left_join(histologies) %>%
  dplyr::filter(Kids_First_Biospecimen_ID_RNA %in% indep_rna$Kids_First_Biospecimen_ID) %>%
  # recode the categories
  dplyr::mutate(OS_status_fixed = case_when(
    OS_status == "LIVING" ~ 0,
    OS_status == "DECEASED" ~1
 ))

```
 
## Cox Regression 

### TP53 scores & Telomerase score - results
```{r Run Cox regression model for tp53 and telomerase}
# run the model with different covariates
for(ind_var in c("tp53_score", "telomerase_score")){
  model <- paste0("survival::Surv(time = OS_days, event = OS_status_fixed) ~ ", ind_var)
  
  fit <- survival::coxph(
        formula(model),
        data = meta_indep
      )
  # generate output
  table <- broom::tidy(fit) 
  
  # Save the table data in a TSV
  readr::write_tsv(table, file.path(results_dir, paste0("cox_reg_results_per_", ind_var, ".tsv")))
  
  print(table)
  
   # output the plot
  pdf(file.path(plots_dir, paste0("coxph_survival_per_", ind_var, ".pdf")))
  plot_coxph <- survminer::ggsurvplot(survfit(fit),
                                      data=meta_indep,
                                      xlim = c(0, 5000),
                                      break.time.by = 500,
                                      pval = TRUE, 
                                      conf.int = TRUE,
                                      risk.table = TRUE, # Add risk table
                                      linetype = "strata", # Change line type by groups
                                      surv.median.line = "hv", # Specify median survival
                                      ggtheme = theme_bw())
  print(ggpar(plot_coxph[[1]], font.legend=6, legend="right"))
  print(ggpar(plot_coxph[[2]], font.legend=6))

  dev.off()

  print(ggpar(plot_coxph[[1]], font.legend=6, legend="right"))
  print(ggpar(plot_coxph[[2]], font.legend=6))
}

```

## Log Rank analysis 

### Categorical variable cancer group and HGG or not 
```{r}
# separate into HGG or non-HGG
meta_indep <- meta_indep %>% 
  dplyr::mutate(hgg_group = case_when(
    cancer_group %in% c("High-grade glioma astrocytoma", "Diffuse midline glioma", "Diffuse intrinsic pontine glioma") ~ "HGAT",
    !cancer_group %in% c("High-grade glioma astrocytoma", "Diffuse midline glioma", "Diffuse intrinsic pontine glioma") ~ "non-HGAT"
  ))

# filter to contain only samples in short histology that that have >=10 samples
meta_indep <- meta_indep %>% 
  dplyr::group_by(cancer_group) %>% 
  dplyr::mutate(n_cg = n()) %>% 
  dplyr::mutate(cancer_group_over10 = case_when(
    n_cg >= 10 ~ cancer_group
  ))

```

### Generate output for categorical files 
```{r}
ind_var_list <- c("hgg_group", "cancer_group_over10")

for(i in 1:length(ind_var_list)){
  ind_var <- ind_var_list[i]

  # define model
  model <- paste0("survival::Surv(time = OS_days, event = OS_status_fixed) ~ ", ind_var)
  
  # run survival analysis
  fit <- survival::survdiff(formula(model),
                            data = meta_indep)
  # Obtain p value for Chi-Squared stat
  fit$p.value <- pchisq(fit$chisq, df = length(fit$n) - 1, lower = FALSE)
  
  print(fit)
  # save the output
  saveRDS(fit, file.path(results_dir, paste0("log_rank_survival_per_", ind_var, ".RDS")))
  
  # generate plots fit
  fit_plot <- survfit(formula(model), data = meta_indep)
  
  # output the plot
  pdf(file.path(plots_dir, paste0("logrank_survival_per_", ind_var, ".pdf")))
  plot_logrank <- survminer::ggsurvplot(fit_plot,
                                        data=meta_indep,
                                        xlim = c(0, 5000),
                                        break.time.by = 500,
                                        pval = TRUE, 
                                        conf.int = TRUE,
                                        risk.table = TRUE, # Add risk table
                                        linetype = "strata", # Change line type by groups
                                        surv.median.line = "hv", # Specify median survival
                                        ggtheme = theme_bw())
  print(ggpar(plot_logrank[[1]], font.legend=6, legend="right"))
  print(ggpar(plot_logrank[[2]], font.legend=6))

  dev.off()

  print(ggpar(plot_logrank[[1]], font.legend=6, legend="right"))
  print(ggpar(plot_logrank[[2]], font.legend=6))
}

```

## Session Info

```{r Print session info}
sessionInfo()
```