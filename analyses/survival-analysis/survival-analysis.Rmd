---
title: "Survival Analysis"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---

**Purpose:** 

### Summary of Findings:

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/survival-analysis/survival-analysis.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

Read in set up script.

```{r}
if (!("survminer" %in% installed.packages())) {
  install.packages("survminer")
}
library(survminer)

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

#### Set up files and directories

Set up output directories. 

```{r}
data_dir <- file.path("..", "..", "data")
results_dir <- "results"
plots_dir <- "plots"
```

Make output directories.

```{r}
if(!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if(!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Declare input file paths. 

```{r}
metadata_file <- file.path(data_dir, "pbta-histologies.tsv")
```

## Import the data

```{r}
metadata <- readr::read_tsv(metadata_file)
```

Reformat the `OS_days` variable. 

```{r}
metadata$OS_status <- factor(metadata$OS_status, levels = c("LIVING", "DECEASED"))
metadata$OS_status_num <- as.numeric(metadata$OS_status)
```

Kaplan-Meier

```{r}
kap_fit <- survival::survfit(survival::Surv(OS_days, OS_status_num) ~ short_histology,
               data = metadata)
```

Cox Regression 

```{r}
cox_fit <- survival::coxph(survival::Surv(OS_days, OS_status_num) ~ short_histology,
                           data = metadata)
```

Log-Rank 

```{r}
logrank_fit <- survival::survdiff(survival::Surv(OS_days, OS_status_num) ~ short_histology,
                                  data = metadata)
```

## Plot the models

```{r}
GGally::ggsurv(kap_fit)
```

```{r}
GGally::ggsurv(cox_fit)
```

```{r}
GGally::ggsurv(logrank_fit)
```

## Session Info

```{r}
sessionInfo()
```
