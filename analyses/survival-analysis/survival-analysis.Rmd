---
title: "Survival Analysis"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---

**Purpose:** 

Set up basic survival analyses models which can be applied to various other data. 

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/survival-analysis/survival-analysis.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

Read in set up script.

```{r}
if (!("survminer" %in% installed.packages())) {
  install.packages("survminer")
}
library(survminer)

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

#### Set up files and directories

Set up output directories. 

```{r}
data_dir <- file.path("..", "..", "data")
results_dir <- "results"
plots_dir <- "plots"
```

Make output directories.

```{r}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Declare input file paths. 

```{r}
metadata_file <- file.path(data_dir, "pbta-histologies.tsv")
tmb_file <- file.path(data_dir, "pbta-snv-consensus-mutation-tmb.tsv")
```

Declare output file paths. 

```{r}
kap_meier_plot_file <- file.path(plots_dir, "survival_curve_gender.pdf")
logrank_table_file <- file.path(results_dir, "logrank_gender.tsv")
cox_table_file <- file.path(results_dir, "cox_regression_tmb.tsv")
```

## Import the metadata

```{r}
metadata <- readr::read_tsv(metadata_file)
```

Reformat the `OS_days` variable. 
The `survival` R packages want overall survival status to be in the form of a 
numeric variable where `0  = Living` and `1 = Deceased`. 

```{r}
metadata$OS_status <- factor(metadata$OS_status, levels = c("LIVING", "DECEASED"))
metadata$OS_status_num <- as.numeric(metadata$OS_status)
```

## Usage 

This is the template model that you can follow for all survival analyses here. 
What will change is the independent variables `<INDEPENDENT_VARIABLES>` you use 
to try to predict survival. 
Depending on what type of variable you are using for your independent variables, 
this will influence what statistical model is appropriate `<STAT_MODEL_FUNCTION>`.

```
<STAT_MODEL_FUNCTION>(survival::Surv(OS_days, OS_status_num) ~ <INDEPENDENT_VARIABLES>,
                 data = metadata)
```

## Kaplan-Meier

[Kaplan-Meier](https://en.wikipedia.org/wiki/Kaplan%E2%80%93Meier_estimator)

```{r}
kap_fit <- survival::survfit(
  survival::Surv(metadata$OS_days, metadata$OS_status_num) ~ reported_gender,
  data = metadata
)

kap_fit
```
`survminer` package comes with a convenient plotting function which uses `ggplot2`
arguments. 

```{r}
survminer::ggsurvplot(kap_fit,
  data = metadata, risk.table = TRUE,
  pval = TRUE, conf.int = TRUE,
  xlim = c(0, 2000),
  break.time.by = 500,
  ggtheme = theme_minimal(),
  risk.table.y.text.col = T,
  risk.table.y.text = FALSE
)

# We can save the plot like a normal ggplot
ggplot2::ggsave(kap_meier_plot_file)
```

## Log-Rank 

For testing whether two survival curves are different, we can use Log-Rank which
can be implemented using `survival::survdiff` function. 
In this example, we will test for survival curve differences between for 
`reported_gender` categories. 

```{r}
# First let's filter out data that does not have reported_gender available
metadata_filt <- metadata %>%
  dplyr::filter(reported_gender != "Not Available")
```

Use the `survdiff` function to test the differences between the `Male` and `Female` 
curves.

```{r}
logrank_fit <- survival::survdiff(
  survival::Surv(metadata_filt$OS_days, metadata_filt$OS_status_num) ~ reported_gender,
  data = metadata_filt
)
```

Make a pretty table of the results.

```{r}
# Here we can get rid of the variable label `reported_gender` since we only have
# one variable
logrank_table <- data.frame(
  group = gsub("reported_gender=", "", names(logrank_fit$n)),
  # We'll pull out the stats we want for this table
  Freq = logrank_fit$n,
  Observed = logrank_fit$obs,
  Expected = logrank_fit$exp,
  Chi.Sq = logrank_fit$chisq
) %>%
  # Drop the automatic groups variable
  dplyr::select(-Freq.groups)

# Print out the table here
logrank_table %>%
  knitr::kable()
```

Save the table data in a TSV.  

```{r}
readr::write_tsv(logrank_table, logrank_table_file)
```

## Cox Regression 

Cox Regression is a model suited for survival analysis where your independent 
variables are continuous. 
For this example, we'll use Tumor Mutation Burden as our continuous variable. 

```{r}
# Read in the data
tmb <- readr::read_tsv(tmb_file)
```

```{r}
tmb_combine <- metadata %>%
  dplyr::inner_join(tmb, by = c("Kids_First_Biospecimen_ID" = "Tumor_Sample_Barcode"))
```

Plug this into a Cox Regression model using the function `survival::coxph`. 

```{r}
cox_fit <- survival::coxph(
  survival::Surv(tmb_combine$OS_days, tmb_combine$OS_status_num) ~ tmb,
  data = tmb_combine
)
```

Take the output from this and make a table. 

```{r}
cox_table <- summary(cox_fit)$coefficients %>%
  as.data.frame()

# Print out the table here
cox_table %>%
  knitr::kable()
```

Save the table data in a TSV.  

```{r}
readr::write_tsv(cox_table, cox_table_file)
```

## Session Info

```{r}
sessionInfo()
```
