---
title: "Compare survival with survivalAnalysis results"
authors: Stephanie Spielman (CCDL)
output: html_notebook
---

## Setup

#### Packages and functions

<!-- https://cran.r-project.org/web/packages/survivalAnalysis/vignettes/multivariate.html -->
 
```{r libraries}
library(survival)
library(survivalAnalysis)
library(ggpubr)
library(ggplot2)
library(dplyr)
```

#### Set up files and directories

Set up output directories. 

```{r Set up directories}
data_dir <- file.path("..", "..", "data")
analysis_dir <- file.path("..", "..", "analyses")
figure_dir <- file.path("..", "..", "figures")

tp53_dir <- file.path(analysis_dir, "tp53_nf1_score")
telomerase_dir <- file.path(analysis_dir, "telomerase-activity-prediction")

results_dir <- "results"
plots_dir <- "plots"
util_dir <- "util"
```

Make output directories and source the util function file.

```{r Make output directories}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Set up file paths.

```{r define data path}
metadata_file <- file.path(data_dir, "pbta-histologies.tsv")

# only use stranded since tp53 scores for polyA did not have good accuracy
tp53_file <- file.path(tp53_dir, 
                        "results", 
                        "tp53_altered_status.tsv")

tel_stranded_file <- file.path(telomerase_dir,
                               "results",
                               "TelomeraseScores_PTBAStranded_FPKM.txt")

tel_polya_file <- file.path(telomerase_dir,
                               "results",
                               "TelomeraseScores_PTBAPolya_FPKM.txt")

# Output plot files
logrank_cancergroup_plot_file <- file.path(plots_dir,
                                           "logrank_survival_per_cancer_group.pdf")

hr_tp53_tel_hgg_plot_file <- file.path(plots_dir,
                                           "hr_tp53_tel_hgg_group.pdf")

```

## Import the metadata

```{r Read in metadata}
# get primary tumor and remove cell lines
histologies_rna <- readr::read_tsv(metadata_file, guess_max = 10000) %>%
  filter(composition=="Solid Tissue" & 
                  tumor_descriptor == "Initial CNS Tumor" &
                  experimental_strategy == "RNA-Seq" & 
                  RNA_library == "stranded") %>%
  rename(Kids_First_Biospecimen_ID_RNA = Kids_First_Biospecimen_ID) %>% 
  select(Kids_First_Participant_ID, Kids_First_Biospecimen_ID_RNA, cancer_group, OS_status, OS_days, PFS_days, molecular_subtype) %>%
  distinct() %>%
  arrange(Kids_First_Biospecimen_ID_RNA) 

# read in tp53 scores
tp53_scores <- readr::read_tsv(tp53_file) %>%
  select(Kids_First_Biospecimen_ID_DNA, Kids_First_Biospecimen_ID_RNA, sample_id, tp53_score) %>%
  arrange(Kids_First_Biospecimen_ID_RNA)

# read in and combine telomerase scores and add in library column
tel_scores_stranded <- readr::read_tsv(tel_stranded_file) %>%
  rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                telomerase_score = NormEXTENDScores) %>%
  arrange(Kids_First_Biospecimen_ID_RNA) %>%
  mutate(library = "stranded")

tel_scores_polya <- readr::read_tsv(tel_polya_file) %>%
  rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                telomerase_score = NormEXTENDScores) %>%
  arrange(Kids_First_Biospecimen_ID_RNA) %>%
  mutate(library = "polya")

# combine telomerase dfs
tel_scores <- bind_rows(tel_scores_stranded, tel_scores_polya)

# combine tp53 scores and telomerase score to the dataframe
# note that we do not need to recode categories since the survival_models.R functions will take care of it
meta_indep <- histologies_rna %>%
  # add tp53 and telomerase scores by matching Kids_First_Biospecimen_ID_RNA
  left_join(tp53_scores, by = "Kids_First_Biospecimen_ID_RNA") %>%
  left_join(tel_scores, by = "Kids_First_Biospecimen_ID_RNA") %>% 
  arrange(Kids_First_Biospecimen_ID_RNA) %>%
  distinct(Kids_First_Participant_ID, .keep_all=TRUE) %>%
  # remove samples without survival data
  tidyr::drop_na(OS_days) %>%
  # convert to years
  mutate(OS_years = OS_days / 365.25)

# Show the data we will use for analysis
meta_indep
```

### Create subsets of data for different models

We create two new tibbles from `meta_indep`:

+ `meta_indep_hgg` which contains a new column `hgg_group` that contains levels (in order) `non-HGAT` and `HGAT` indicating whether it's an HGG sample
+ `meta_indep_cancers` which is subsetted to only certain cancer groups of interest that have suitable sample sizes which we find here.

```{r hgg_split}
# Define HGG groups
hgg_cancer_groups <- c("High-grade glioma astrocytoma", "Diffuse midline glioma", "Diffuse intrinsic pontine glioma") 
hgg_levels <- c("non-HGAT", "HGAT")

# separate into HGG or non-HGG and make the new column a factor
meta_indep_hgg <- meta_indep %>% 
   mutate(hgg_group = ifelse(cancer_group %in% hgg_cancer_groups,
                             hgg_levels[2], # second is HGAT 
                             hgg_levels[1]), # first is non-HGAT
          hgg_group = factor(hgg_group, levels = hgg_levels), # ensures non-HGAT is the reference level
          OS_status = ifelse(OS_status == "LIVING", 0, 1)) # recode status
```

```{r find_cancer_groups_to_use}
# Define cancer groups of interest with higher Ns
# We want to only include groups that have at least THREE in deceased category. 
# Find them here:
cancer_groups_of_interest_df <- meta_indep %>%
  tidyr::drop_na() %>%
  count(cancer_group,OS_status) %>%
  tidyr::spread(OS_status, n, 
                # any missing values (indicating 0 deceased or 0 living) should be 0, not NA
                fill = 0) %>%
  filter(DECEASED >= 3)

# show result: there are five groups to keep
cancer_groups_of_interest_df

meta_indep_cancer_groups <- meta_indep %>%
  filter(cancer_group %in% cancer_groups_of_interest_df$cancer_group) %>%
  mutate(OS_status = ifelse(OS_status == "LIVING", 0, 1))
    
# How many patients got removed?
nrow(meta_indep) - nrow(meta_indep_cancer_groups)
```

## Cox Regressions with independent variables 

 
Here, we run a survival analyses for several _independent_ predictors, one at a time.

+ `tp53_score` (continuous)
+ `telomerase_score` (continuous)
+ `hgg_group` (categorical)
+ `molecular_subtype` within HGG (categorical)
+ `cancer_group` (categorical)


#### TP53 results match between packages

```{r cox_tp53}
#### survival result
survival::coxph(
  survival::Surv(OS_years, OS_status) ~ tp53_score,
  data = meta_indep_cancer_groups
) 
    

#### survivalAnalysis result
survivalAnalysis::analyse_multivariate(meta_indep_cancer_groups, 
                                      vars(OS_years, OS_status),
                                      covariates = vars(tp53_score)) 

```
#### Telomerase results match between packages

```{r cox_telo}
#### survival result
survival::coxph(
  survival::Surv(OS_years, OS_status) ~ telomerase_score,
  data = meta_indep_cancer_groups
) 
    

#### survivalAnalysis result
survivalAnalysis::analyse_multivariate(meta_indep_cancer_groups, 
                                      vars(OS_years, OS_status),
                                      covariates = vars(telomerase_score))
```



#### HGG group results match between packages


trying a lung:
```{r}




```

```{r cox_hgg}
#### survival result
survival::survfit(
  survival::Surv(OS_years, OS_status) ~ hgg_group,
  data = meta_indep_hgg
) -> x
    
    
#### survivalAnalysis result: does not run due to convergence problems, but the above runs? which is wild.
survivalAnalysis::analyse_survival(meta_indep_hgg, 
                                   vars(OS_years, OS_status),
                                   by = hgg_group) -> y


```

####  HGG group


```{r cox_hgg_subtype}
hgg_df <- meta_indep_hgg %>%
  filter(hgg_group == "HGAT")

fit_save_cox2(hgg_df, vars(molecular_subtype), results_dir)

# Plot forest for HGG subtypes
fp_hgg_subtypes <- analyse_survival(hgg_df, vars(OS_years, OS_status), by=molecular_subtype) %>%
  forest_plot(use_one_hot=TRUE,
              endpoint_labeller = c(OS_years="OS"),
              orderer = ~order(HR),
              labels_displayed = c("endpoint", "factor", "n"),
              ggtheme = ggplot2::theme_bw(base_size = 10),
              relative_widths = c(2, 1.5, 1)) 

print(fp_hgg_subtypes)

save_pdf(plot = fp_hgg_subtypes,
           folder = plots_dir,
           fileBaseName = "HR_hgg_subtypes")
```

#### Cancer group


```{r cox_cancer_group}
fit_save_cox2(meta_indep_cancer_groups, vars(cancer_group), results_dir)
```

## Log Rank analysis of cancer groups

Here, we perform a log-rank analysis specifically for the `cancer_group` predictor. We also visualize the result and export the PDF. Note that we do not use the `survival_analysis` function here because of conflicting variables needed for visualization. 

In the resulting model, we do not see a signficant difference between survival for MB and ependymoma. We also do not see a signficant different between ATRT and HGAT. However, we see a difference between (MB and ependymoma) and (ATRT and HGAT)

```{r cancer_group_log_rank, fig.width = 14, fig.height = 6}
# Run model
cg_fit_logrank <- survival::survdiff(
  formula(
    "survival::Surv(time = OS_years, event = OS_status) ~ cancer_group"
  ),
  data = meta_indep_cancer_groups
)

# Obtain p value for Chi-Squared stat
cg_fit_logrank$p.value <- pchisq(cg_fit_logrank$chisq, df = length(cg_fit_logrank$n) - 1, lower = FALSE)

# Export model as RDS so P-value is included (P-values are not preserved from broom::tidy())
readr::write_rds(cg_fit_logrank$model, 
                 file.path(
                   results_dir, 
                   "log_rank_survival_per_cancer_group.RDS"
                   )
                 )

# Visualize
fit_plot_df <- survfit(
  formula(cg_fit_logrank), 
  data = meta_indep_cancer_groups)

plot_logrank <- survminer::ggsurvplot(fit_plot_df,
                                      data=meta_indep_cancer_groups,
                                      xlim = c(0, 14),
                                      break.time.by = 1,
                                      pval = TRUE, 
                                      conf.int = TRUE,
                                      risk.table = TRUE, # Add risk table
                                      linetype = "strata", # Change line type by groups
                                      surv.median.line = "hv", # Specify median survival
                                      ggtheme = ggpubr::theme_pubr(), # pubr theme
                                      legend = "right", # legend on the right
                                      # place p-value in more visible location
                                      pval.coord  = c(12, 0.9)) 

plot_logrank

# Save to file
pdf(logrank_cancergroup_plot_file, 
    width = 14,height = 6)
print(plot_logrank)
dev.off()
```

## Multivariate analysis 

### Comparison made is `tp53_score*telomerase_score*hgg_group` 

Initially, it was planned to assess `tp53_score*telomerase_score*cancer_group` here, but the removal of LGG, Ganglioglioma, and Craniopharyngioma patients resulted in removal of 329 patients, and hence affects telomerase and tp53 predictions. Therefore this model will not be explored.

<!--Therefore, I think we should keep this as-is, but add the interaction, so that we can assess for all possible patients within the PBTA.-->

Background on hazard ratios and output, from [ref](http://www.sthda.com/english/wiki/cox-proportional-hazards-model):

>"Hazard ratio above 1 indicates a covariate that is positively associated with the event probability, and thus negatively associated with the length of survival.
>
>In summary,
>
>HR = 1: No effect
>HR < 1: Reduction in the hazard
>HR > 1: Increase in Hazard" 
>
>The Cox regression results can be interpreted as follow:
_Statistical significance._ The column marked "z" gives the Wald statistic value. It corresponds to the ratio of each regression coefficient to its standard error (z = coef/se(coef)). The wald statistic evaluates, whether the beta (Î²) coefficient of a given variable is statistically significantly different from 0. From the output above, we can conclude that the variable sex have highly statistically significant coefficients.
>
>_The regression coefficients._ The second feature to note in the Cox model results is the the sign of the regression coefficients (coef). A positive sign means that the hazard (risk of death) is higher, and thus the prognosis worse, for subjects with higher values of that variable. The variable sex is encoded as a numeric vector. 1: male, 2: female. The R summary for the Cox model gives the hazard ratio (HR) for the second group relative to the first group, that is, female versus male. The beta coefficient for sex = -0.53 indicates that females have lower risk of death (lower survival rates) than males, in these data.
>
>_Hazard ratios._ The exponentiated coefficients (exp(coef) = exp(-0.53) = 0.59), also known as hazard ratios, give the effect size of covariates. For example, being female (sex=2) reduces the hazard by a factor of 0.59, or 41%. Being female is associated with good prognostic.
>
>_Confidence intervals of the hazard ratios._ The summary output also gives upper and lower 95% confidence intervals for the hazard ratio (exp(coef)), lower 95% bound = 0.4237, upper 95% bound = 0.816.
>
>_Global statistical significance of the model._ Finally, the output gives p-values for three alternative tests for overall significance of the model: The likelihood-ratio test, Wald test, and score logrank statistics. These three methods are asymptotically equivalent. For large enough N, they will give similar results. For small N, they may differ somewhat. The Likelihood ratio test has better behavior for small sample sizes, so it is generally preferred.
>
> Below, HR = exp(coeff) 


Note we can't use the `survival_analysis()` function here because of the multivariate nature of the terms; that function requires only ONE independent variable. Therefore we use a separate function for the multivariate models, defined in `util/survival_multivariate2.R`. This function visualizes and prints the model results, and exports the fitted model as a TSV table. This function does not currently export the _plot_.


#### TP53 score * Telomerase score * HGG group * molecular_subtype

```{r multivar-fit-3terms}
# without function
covariates <- vars(tp53_score, telomerase_score, hgg_group)

# just adding this to be similar to previous function, but structure in the survivalAnalysis package is now different
cov <- "tp53_score*telomerase_score*hgg_group"

covariate_names <- c(tp53_score="TP53 score",
                     telomerase_score="Telomerase activity",
                     `hgg_group:non-HGAT`="non-HGAT")

ref_dict = c(hgg_group="non-HGAT")

result1 <- analyse_multivariate(meta_indep_hgg,
                     vars(OS_years, OS_status),
                       covariates = covariates,
                       covariate_name_dict = covariate_names,
                     reference_level_dict = ref_dict)

result1$summary
print(result1$summaryAsFrame)

forest_plot1 <- forest_plot(result1,
            factor_labeller = covariate_names,
            endpoint_labeller = c(OS_years="OS"),
            orderer = ~order(HR),
            labels_displayed = c("endpoint", "factor", "n"),
            ggtheme = ggplot2::theme_bw(base_size = 12),
            relative_widths = c(1.5, 1.5, 1),
            HR_x_breaks = c(0.25, 0.5, 0.75, 1, 1.5, 2))

forest_plot1

save_pdf(plot = forest_plot1, 
         folder = plots_dir, 
         fileBaseName = paste0("HR_", cov))
```

#### TP53 score * Telomerase score * HGG group - new function

```{r multivar-fit-3terms new function}
covariates <- vars(tp53_score, telomerase_score, hgg_group)

# just adding this to be similar to previous function, but structure in the survivalAnalysis package is now different
cov <- "tp53_score*telomerase_score*hgg_group"

covariate_names <- c(tp53_score="TP53 score",
                     telomerase_score="Telomerase activity",
                     `hgg_group:non-HGAT`="non-HGAT")

ref_dict = c(hgg_group="non-HGAT")

cg <- ""

fit_plot_save_cox_multivariate2(df = meta_indep_hgg, 
                          terms = covariates,
                          covariate_dict = covariate_names,
                          ref_dict = ref_dict,
                          output_dir = results_dir,
                          plot_dir = plots_dir)
```

#### TP53 score * Telomerase score, for each cancer group.


```{r multivar-fit-2terms}
# Define covariates
cov <- "tp53_score*telomerase_score"

covariates <- vars(tp53_score, telomerase_score)

covariate_names <- c(tp53_score="TP53 score",
                     telomerase_score="Telomerase activity")

for (cg in unique(meta_indep_cancer_groups$cancer_group)) {
   tryCatch({
     cat("==============", cg, "==================")
  # filter to cancer group of interest
  fit_data <- meta_indep %>% 
    filter(cancer_group == cg) %>%
    mutate(OS_status = ifelse(OS_status == "LIVING", 0, 1)) 
  
  # Define filename where model will be saved
  file_name <- paste0("SurvivalAnalysis_cox_reg_results_per_tp53_score-by-telomerase_score_",
                     stringr::str_replace_all(cg," ","-"), ".tsv")  # Define filename where model will be saved
  
  fileBaseName <- paste0("HR_", cg, "_", cov)

    # Fit model
  fit_plot_save_cox_multivariate2(fit_data, 
                          terms = covariates, 
                          covariate_dict = covariate_names,
                          ref_dict = NULL,
                          output_dir = results_dir,
                          filename = NULL,
                          plot_dir = plots_dir)
   }, error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}

```




