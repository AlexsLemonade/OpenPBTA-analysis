---
title: "Tumor Mutation Burden Comparison of Calculations"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---

#### Objectives

Compare D3b and CCDL TMB calculations as a response to this [GitHub comment](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/729#issuecomment-658259843). 

This includes CCDL TMB calculations that used mutation sets with FoCR-defined nonsynonymous filter and maftools-defined nonsynonymous filter. 
These TMB datasets compared here are obtained by running:

```
bash analyses/snv-callers/explore_variant_classifications/run_explorations.sh
```

### Summary of findings: 

Mutation counts seem to be fairly related but the bed sizes are very different and that seems to be what's causing the differences in TMB calculations ranges.
CCDL TMB is a much larger range (0 - ~300), while D3B TMB is smaller range (0 - ~5) because the BED size for CCDL TMB is much smaller than the BED size for D3B TMB. 
Biggest differences in mutation counts is in (mostly) HGAT samples. 
They are the bigget outliers as well (we've seen this before).

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

    - [Usage](#usage)
- [Setup](#setup)
    - [Packages and functions](#packages-and-functions)
- [Set up consensus data](#set-up-consensus-data)
- [Percent Differences in TMB](#percent-differences-in-tmb)
- [How different are the mutation counts?](#how-different-are-the-mutation-counts)
- [Calculate percent difference in BED size](#calculate-percent-difference-in-bed-size)
- [Session Info](#session-info)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/tmb-compare/compare-tmb-calculations.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

```{r}
# magrittr pipe
`%>%` <- dplyr::`%>%`
```

Declare names of input and output directories.

```{r}
data_dir <- file.path("..", "..", "data")
scratch_dir <- file.path("..", "..", "scratch")
```

Custom function for plotting the TMB. 

```{r}
source(file.path("util", "cdf-plot-function.R"))
```

## Set up consensus data

Read in the three consensus TMB files. 

This is the main TMB that is used in other downstream results. 

```{r}
tmb_ccdl_maftools <- data.table::fread(file.path(
  "..",
  "snv-callers",
  "results",
  "consensus",
  "pbta-snv-mutation-tmb-coding.tsv"
))
```

This is the FoCR-defined filter TMB results. 

```{r}
tmb_ccdl_focr <- data.table::fread(file.path(
  "..",
  "snv-callers",
  "results",
  "focr_filter",
  "pbta-snv-mutation-tmb-coding.tsv"
))
```

This is the d3b calculated results. 

```{r}
tmb_d3b <- data.table::fread(file.path(
  "TMB_d3b_code",
  "outputs",
  "pbta-snv-consensus-TMB_intarget.txt"
))
```

Combine the three datasets into one data.frame. 

```{r}
all_tmb <- tmb_ccdl_maftools %>% 
  dplyr::inner_join(tmb_ccdl_focr, by = "Tumor_Sample_Barcode", 
                    suffix = c("_maftools", "_focr")) %>% 
  dplyr::inner_join(tmb_d3b, by = "Tumor_Sample_Barcode") %>% 
  dplyr::rename(tmb_d3b = TMB, 
                mutation_count_d3b = count)
```

## Percent Differences in TMB

```{r}
all_tmb <- all_tmb %>% 
  dplyr::mutate(perc_diff_focr = abs(tmb_focr - tmb_d3b) / max(tmb_focr, tmb_d3b), 
                perc_diff_maf = abs(tmb_maftools - tmb_d3b) / max(tmb_maftools, tmb_d3b))
```

This is the same regardless of which definition (maftools/FoCR) is used. 

```{r}
all_tmb %>% 
  dplyr::filter(perc_diff_focr > .05)

all_tmb %>% 
  dplyr::filter(perc_diff_maf > .05)
```

Most are HGAT samples, but probably because they are outliers. 

## How different are the mutation counts?

Select the counts columns only. 

```{r}
counts_only <- all_tmb %>% 
  dplyr::select(mutation_count_focr, mutation_count_maftools, mutation_count_d3b)

# Print this out
counts_only
```

Plot this. 

```{r}
counts_only %>%
  GGally::ggpairs(mapping = ggplot2::aes(alpha = 0.05)) +
  ggplot2::theme_classic()
```

Counts look *mostly* the same, but those outliers make the plots not super useful. 

Let's take a closer look at the samples with larger differences in counts. 
We'll compare things with `mutation_count_maftools` since that is what is in the current consensus file. 

```{r}
all_tmb %>%
  dplyr::transmute(
    Tumor_Sample_Barcode,
    ccdl_filter_diff = mutation_count_maftools - mutation_count_focr,
    d3b_diff = mutation_count_maftools - mutation_count_d3b) %>% 
  dplyr::arrange(desc(ccdl_filter_diff))
```

Those same HGAT samples are the ones with the biggest differences in counts. 

## Calculate percent difference in BED size

Both CCDL TMBs use the same bed regions so it doesn't matter if we use `region_size_focr` or `region_size_maftools`. 

```{r}
all_tmb %>%
  dplyr::rename(ccdl_bed_size = region_size_focr, d3b_bed_size = bedlength) %>%
  dplyr::group_by(ccdl_bed_size, d3b_bed_size, experimental_strategy) %>%
  dplyr::tally()
```

So the bed sizes are very different and that seems to be what's causing the differences in TMB calculations. 

## Session Info

```{r}
sessionInfo()
```
