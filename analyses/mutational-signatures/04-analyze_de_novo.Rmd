---
title: "De novo mutational signature extraction from WGS data"
author: "S. Spielman"
date: "2021"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
    df_print: paged
editor_options:
  chunk_output_type: inline
---


<br><br><br><br>

#### Packages and paths


```{r}
# Load libraries
library(sigfit)
`%>%` <- dplyr::`%>%`

# Path to input data
path_to_input_rds <- file.path("..", "..", "scratch", "mutational-signatures", "extraction")

# Result path
path_to_results <- "results"
if (!dir.exists(path_to_results)) {
  dir.create(path_to_results, recursive = TRUE)
}

# De novo signatures and exposures list (condensed from sigfit output) file
de_novo_signatures_file <- file.path(path_to_results, "de_novo_signatures.RDS")
de_novo_exposures_file <- file.path(path_to_results, "de_novo_exposures.RDS")

# Load cosmic data from sigfit
data("cosmic_signatures_v3")
cosmic_names <- row.names(cosmic_signatures_v3)
```

<br><br>
First, we need to extract the signatures and exposures from the *de novo* extraction RDS files. We save each into a list `de_novo_signatures` and `de_novo_extractions` separately, and write each list to file. If _both_ files already exist, we can simply read it in the lists.

```{r parse_signatures}
if (file.exists(de_novo_signatures_file) & file.exists(de_novo_exposures_file))
{
  de_novo_signatures <- readr::read_rds(de_novo_signatures_file)
  de_novo_exposures <- readr::read_rds(de_novo_exposures_file)

} else {
    
  # Collect the de novo extracted signatures into a single list
  # This takes a few minutes to parse.
  de_novo_signatures <- list()
  de_novo_exposures <- list()
  for (this_model in c("poisson" , "multinomial"))
  {
    for (this_seed in 1:5){
  
      this_name <- glue::glue("seed_{this_seed}_model_{this_model}")
      filename <- file.path(path_to_input_rds, 
                            glue::glue("{this_name}.RDS"))
      #cat(filename)
      if (file.exists(filename)) {
        fit <- readr::read_rds(filename)
        for (k in 2:5){
          sig_name <- glue::glue("{k}_{this_name}")
          de_novo_signatures[[ sig_name ]] <- sigfit::retrieve_pars(fit[[k]], par = "signatures") 
          de_novo_exposures[[ sig_name ]] <- sigfit::retrieve_pars(fit[[k]], par = "exposures") 
        }
      }
    }
    
  }
  # We save this list to a result file
  readr::write_rds(de_novo_signatures, de_novo_signatures_file)
  readr::write_rds(de_novo_exposures, de_novo_exposures_file)
}
```

<br><br>
Based on goodness of fit analyses, we expect these *k* to be optimal for the given seed and inference model (noting that we do see strong sensitivity to this starting condition).

```{r gof_k}
gof <- tibble::tribble(
  ~model,     ~seed,      ~best_k,
  #-----------------
  "poisson",1,3,
  "multinomial",1,3,
  "poisson",2,4,
  "multinomial",2,4,
  "poisson",3,3,
  "multinomial",3,3,
  "poisson",4,3,
  "multinomial",4,3,  
  "poisson",5,3,
  "multinomial",5,3  
)
```


<br><br>
Now, we can determine which signatures were extracted and map back to COSMIC names using cosine similarity to determine matching signatures:

```{r determine_sigs}

# Will find the COSMIC equivalent using cosine similarity
map_match <- function(x) {
  sort( # Can sort since we just want to see cosmic matches
    as.numeric( # none of this "optimal assigment ==> 1" business
      match_signatures(x, cosmic_signatures_v3)
    )
  )
}

purrr::map(de_novo_signatures, map_match) -> cosmic_matches
```

<br><br>
Now, we create a table of results for which COSMIC SBS signatures were extracted. **Full results for each combination of k, model, and random seed:**
```{r sigs_full}
tibble::tibble(
  name = names(cosmic_matches), 
  cosmic_sig_index = unname(cosmic_matches[1:length(cosmic_matches)])
  ) %>%
  tidyr::unnest(cosmic_sig_index) %>%
  dplyr::mutate(cosmic_sig = cosmic_names[cosmic_sig_index]) -> unnested_sigs

unnested_sigs %>%
  dplyr::group_by(name) %>%
  dplyr::summarize(cosmic_sigs = toString(cosmic_sig)) %>%
  dplyr::mutate(cosmic_sigs = stringr::str_replace_all(cosmic_sigs, "SBS", "")) %>%
  dplyr::mutate(seed  = stringr::str_extract(name, "_\\d_"),
                seed  = stringr::str_replace_all(seed, "_", ""),
                k     = stringr::str_extract(name, "^\\d"), 
                model = stringr::str_extract(name, "[a-z]+$")) %>%
  dplyr::select(-name) -> full_sigs

full_sigs %>%
  tidyr::spread(seed, cosmic_sigs) %>%
  knitr::kable() 
```

<br><br> 
Although not very robust to starting conditions, the results are robust to the inference model, so we will just look at `poisson` going forward. **Now, here's the table specifically for the results whose k was selected by cosine similarity goodness-of-fit**, among *k in [2:5]* for each the given random seed, using 3000 iterations:

```{r sigs_selected}
gof %>%
  dplyr::rename(k = best_k) %>%
  dplyr::mutate(k = as.character(k), seed = as.character(seed)) %>%
  dplyr::left_join(full_sigs) %>%
  dplyr::filter(model == "poisson") %>%
  dplyr::select(-model) %>% 
  dplyr::distinct() %>%
  knitr::kable()
```
<br><br><br>

Clearly, this analysis is extremely sensitive to starting conditions. Even so, we see a few repeated SBS signatures coming up:


+ [SBS5](https://cancer.sanger.ac.uk/signatures/sbs/sbs5/) is age and clock-like, and "SBS5 may be contaminated by SBS16."
+ [SBS11](https://cancer.sanger.ac.uk/signatures/sbs/sbs11/) "exhibits a mutational pattern resembling that of alkylating agents. Patient histories indicate an association between previous treatment with the alkylating agent temozolomide and SBS11 mutations."
+ **[SBS14](https://cancer.sanger.ac.uk/signatures/sbs/sbs14/)** "is one of seven mutational signatures associated with defective DNA mismatch repair and microsatellite instability (MSI) and is often found in the same samples as other MSI associated signatures: SBS6, SBS15, SBS20, SBS21, SBS26 and SBS44."
+ **[SBS15](https://cancer.sanger.ac.uk/signatures/sbs/sbs15/)** "is one of seven mutational signatures associated with defective DNA mismatch repair and microsatellite instability (MSI) and is often found in the same samples as other MSI associated signatures: SBS6, SBS14, SBS20, SBS21, SBS26 and SBS44."
+ [SBS23](https://cancer.sanger.ac.uk/signatures/sbs/sbs23/) has unknown aetiology.
+ [SBS40](https://cancer.sanger.ac.uk/signatures/sbs/sbs40/) is correlated with age (not of clear relevance to pediatric tumors).
+ [SBS42](https://cancer.sanger.ac.uk/signatures/sbs/sbs42/) is correlated with occupational exposure to haloalkanes (seems unlikely to be relevant for pediatric tumors?).


**The two bolded** signatures are commonly associated with one another due to putative shared mechanisms of "defective DNA mismatch repair and microsatellite instability (MSI)."
