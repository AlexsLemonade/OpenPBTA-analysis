---
title: "Explore de novo mutational signatures"
author: Anna R. Poetsch; adapted by J. Taroni for ALSF CCDL
date: 2020
output:
  html_notebook:
    toc: yes
    toc_float: yes
params:
  is_ci: FALSE
---

## Determine Signatures de novo  

This notebook is included, because the previous strategies imply that there are mutagenic mechanisms in operation that are unlikely to be a major factor in this dataset, such as smoking and UV light.
This is happening due to overfitting problems when fitting existing signatures. 
De novo signature calling is used to provide an alternative for discussion. 
It is determined, which signatures can be extracted from the data themselves. 
These signatures are then fitted back to the known signatures that are used for the fitting approach above. 

The signatures were extracted with `scripts/de_novo_signature_fitting.R`.
You can see the parameters we used in `run_mutational_signatures.sh`.

```{r}
library(deconstructSigs)
library(sigfit)

# Assigning params$is_ci to running_in_ci avoids a locked binding error
running_in_ci <- params$is_ci

# Are we testing? In case of a non 0/1 number, we recast as logical, 
# and then ensure logical.
if (running_in_ci %in% c(0,1)) running_in_ci <- as.logical(running_in_ci)
if (!(is.logical(running_in_ci))) {
  stop("\n\nERROR: The parameter `is_ci` should be FALSE/TRUE (or 0/1).")
}

```

```{r}
# Read in all the results from the range of k as chosen in 
# run_mutational_signatures.sh
sigfit_results <- readr::read_rds(file.path("results", 
                                            "denovo_sigfit_signatures.RDS"))
```

TODO: Add some analyses in support of picking `nsignatures=10` ?

```{r}
if (running_in_ci) {
  # if we're running in CI, then the de novo signatures will only be run for
  # k = 10
  nsig10_results <- sigfit_results
} else {
  # Go with k = 10 per @arpoe
  nsig10_results <- sigfit_results[["nsignatures=10"]]
}

# Write to file
readr::write_rds(nsig10_results, 
                 file.path("results", 
                           "sigfit_signatures_10_results.RDS"), 
                 compress = "gz")
```

```{r}
signatures <- retrieve_pars(nsig10_results, par = "signatures")
readr::write_rds(signatures, 
                 file.path("results", 
                           "sigfit_signatures_10_signatures.RDS"), 
                 compress = "gz")
```


```{r}
exposures <- retrieve_pars(nsig10_results, par = "exposures")
readr::write_rds(exposures, 
                 file.path("results", 
                           "sigfit_signatures_10_exposures.RDS"), 
                 compress = "gz")
```


```{r}
reconstructions <- retrieve_pars(nsig10_results, par = "reconstructions")
readr::write_rds(reconstructions, 
                 file.path("results", 
                           "sigfit_signatures_10_reconstructions.RDS"), 
                 compress = "gz")
```

## Session Info

```{r}
sessionInfo()
```

