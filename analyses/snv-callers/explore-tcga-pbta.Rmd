---
title: "TCGA Plot Caller Comparisons"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---

Purpose: Why are TCGA and PBTA data so different? 

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/snv-callers/compare_snv_callers_plots-tcga.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

Read in set up script.

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

source(file.path("..", "snv-callers", "util", "tmb_functions.R"))
```

Set up directories. 

```{r}
scratch_dir <- file.path("..", "..", "scratch")
data_dir <- file.path("..", "..", "data")
```

```{r}
pbta_metadata <- readr::read_tsv(file.path(data_dir, "pbta-histologies.tsv")) 
tcga_metadata <- readr::read_tsv(file.path(data_dir, "pbta-tcga-manifest.tsv")) %>% 
  dplyr::rename(short_histology = broad_histology)
```

## Connect to databases

Note what columns we will join by.

```{r}
join_cols = c("Chromosome",
              "Start_Position",
              "End_Position", 
              "Reference_Allele",
              "Allele",
              "Tumor_Sample_Barcode", 
              "Variant_Classification", 
              "t_depth",
              "t_ref_count", 
              "t_alt_count", 
              "n_depth", 
              "n_ref_count", 
              "n_alt_count", 
              "VAF")
```

Set up tables from the database but only call the columns we need.

```{r}
# Start up connection
con <- DBI::dbConnect(RSQLite::SQLite(), 
                      file.path(scratch_dir, "tcga_snv_db.sqlite"))

tcga_strelka <- dplyr::tbl(con, "strelka") %>% 
  dplyr::select(join_cols) %>% 
  as.data.frame() %>% 
  dplyr::mutate(experimental_strategy = "WXS", short_histology = "brain")

tcga_lancet <- dplyr::tbl(con, "lancet") %>% 
  dplyr::select(join_cols) %>% 
  as.data.frame() %>% 
  dplyr::mutate(experimental_strategy = "WXS", short_histology = "brain")

tcga_mutect <- dplyr::tbl(con, "mutect") %>% 
  dplyr::select(join_cols) %>% 
  as.data.frame() %>% 
  dplyr::mutate(experimental_strategy = "WXS", short_histology = "brain")
```

```{r}
# Start up connection
con <- DBI::dbConnect(RSQLite::SQLite(), 
                      file.path(scratch_dir, "snv_db.sqlite"))

pbta_strelka <- dplyr::tbl(con, "strelka") %>% 
  dplyr::select(join_cols, "VAF") %>% 
  as.data.frame() %>% 
  dplyr::inner_join(
  pbta_metadata %>% 
    dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                  experimental_strategy, short_histology))

pbta_lancet <- dplyr::tbl(con, "lancet") %>% 
  dplyr::select(join_cols, "VAF") %>% 
  as.data.frame() %>% 
  dplyr::inner_join(
  pbta_metadata %>% 
    dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                  experimental_strategy, short_histology))

pbta_mutect <- dplyr::tbl(con, "mutect") %>% 
  dplyr::select(join_cols, "VAF") %>% 
  as.data.frame() %>% 
  dplyr::inner_join(
  pbta_metadata %>% 
    dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                  experimental_strategy, short_histology))
```

## Is this a tumor sequencing depth problem for certain callers? 

```{r}
lancet <- dplyr::bind_rows(list(tcga = tcga_lancet,  
                                pbta = pbta_lancet), .id = "dataset") %>% 
  dplyr::mutate(dataset = as.factor(dataset))

lancet %>% 
  dplyr::group_by(Tumor_Sample_Barcode, dataset) %>% 
  dplyr::summarize(n_mut = dplyr::n(), 
                   med_depth = median(n_depth)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = med_depth, y = n_mut, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::facet_wrap(~dataset)
```

```{r}
mutect <- dplyr::bind_rows(list(tcga = tcga_mutect, 
                                pbta = pbta_mutect), .id = "dataset") %>% 
  dplyr::mutate(dataset = as.factor(dataset))

mutect %>% 
  dplyr::group_by(Tumor_Sample_Barcode, dataset) %>% 
  dplyr::summarize(n_mut = dplyr::n(), 
                   med_depth = median(n_depth)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = med_depth, y = n_mut, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::facet_wrap(~dataset)
```

```{r}
strelka <- dplyr::bind_rows(list(tcga = tcga_strelka, 
                                pbta = pbta_strelka), .id = "dataset") %>% 
  dplyr::mutate(dataset = as.factor(dataset))

strelka  %>% 
  dplyr::group_by(Tumor_Sample_Barcode, dataset) %>% 
  dplyr::summarize(n_mut = dplyr::n(), 
                   med_depth = median(n_depth)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = med_depth, y = n_mut, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::facet_wrap(~dataset)
```


## Is this a WXS vs WGS problem? 

```{r}
pbta_mutect <- pbta_mutect %>% dplyr::inner_join(
  pbta_metadata %>% 
    dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                  experimental_strategy)) %>% 
  dplyr::filter(experimental_strategy == "WXS")

mutect <- dplyr::bind_rows(list(tcga = tcga_mutect,  
                      pbta = pbta_mutect), .id = "dataset") %>% 
  dplyr::mutate(dataset = as.factor(dataset))

mutect %>% 
  dplyr::group_by(Tumor_Sample_Barcode, dataset) %>% 
  dplyr::summarize(n_mut = dplyr::n(), 
                   med_depth = median(n_depth)) %>% 
  ggplot2::ggplot(ggplot2::aes(x = med_depth, y = n_mut, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::facet_wrap(~dataset)
```

## Is this a caller specific problem?? 

```{r}
# Calculate coding only TMBs and write to file
pbta_lancet_coding_df <- calculate_tmb(pbta_lancet,
  bed_wgs = file.path(scratch_dir, "intersect_cds_lancet_strelka_mutect_WGS.bed"),
  bed_wxs = file.path(scratch_dir, "intersect_cds_lancet_WXS.bed")
  )

# Calculate coding only TMBs and write to file
tcga_lancet_coding_df <- calculate_tmb(tcga_lancet,
  bed_wgs = file.path(scratch_dir, "intersect_cds_lancet_strelka_mutect_WGS.bed"),
  bed_wxs = file.path(scratch_dir, "intersect_cds_lancet_WXS.bed")
  )

lancet_tmb <- dplyr::bind_rows(list(pbta = pbta_lancet_coding_df, 
                                    tcga = tcga_lancet_coding_df), .id = "dataset")

lancet_tmb %>% 
  ggplot2::ggplot(ggplot2::aes(x = short_histology, y = tmb, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::theme(
      axis.text.x = ggplot2::element_text(angle = 55, hjust = 1)) + 
  ggplot2::ylim(c(0,10))
```

```{r}
# Calculate coding only TMBs and write to file
pbta_mutect_coding_df <- calculate_tmb(pbta_mutect,
  bed_wgs = file.path(scratch_dir, "intersect_cds_lancet_strelka_mutect_WGS.bed"),
  bed_wxs = file.path(scratch_dir, "intersect_cds_WXS.bed")
  )

# Calculate coding only TMBs and write to file
tcga_mutect_coding_df <- calculate_tmb(tcga_mutect,
  bed_wgs = file.path(scratch_dir, "intersect_cds_lancet_strelka_mutect_WGS.bed"),
  bed_wxs = file.path(scratch_dir, "intersect_cds_WXS.bed")
  )

mutect_tmb <- dplyr::bind_rows(list(pbta = pbta_mutect_coding_df, 
                                    tcga = tcga_mutect_coding_df), .id = "dataset")

mutect_tmb %>% 
  ggplot2::ggplot(ggplot2::aes(x = short_histology, y = tmb, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::theme(
      axis.text.x = ggplot2::element_text(angle = 55, hjust = 1)) + 
  ggplot2::ylim(c(0,25))
```

```{r}
# Calculate coding only TMBs and write to file
pbta_strelka_coding_df <- calculate_tmb(pbta_strelka,
  bed_wgs = file.path(data_dir, "intersect_cds_lancet_strelka_mutect_WGS.bed"),
  bed_wxs = file.path(scratch_dir, "intersect_cds_WXS.bed")
  )

# Calculate coding only TMBs and write to file
tcga_strelka_coding_df <- calculate_tmb(tcga_strelka,
  bed_wgs = file.path(scratch_dir, "intersect_cds_lancet_strelka_mutect_WGS.bed"),
  bed_wxs = file.path(scratch_dir, "intersect_cds_WXS.bed")
  )

strelka_tmb <- dplyr::bind_rows(list(pbta = pbta_strelka_coding_df, 
                                    tcga = tcga_strelka_coding_df), .id = "dataset")

strelka_tmb %>% 
  ggplot2::ggplot(ggplot2::aes(x = short_histology, y = tmb, color = dataset)) + 
  ggplot2::geom_point() + 
  ggplot2::theme(
      axis.text.x = ggplot2::element_text(angle = 55, hjust = 1)) + 
  ggplot2::ylim(c(0,25))
```

## Is this just a disease specific thing and has nothing to do with age? 


```{r}


```

## Session Info

```{r}
sessionInfo()
```
