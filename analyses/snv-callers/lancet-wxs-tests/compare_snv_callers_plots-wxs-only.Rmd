---
title: "Plot Caller Comparisons: WXS only"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2020
---

### Purpose: 
With the TCGA data (which is all WXS), we were noticing Lancet was returning 
particularly low VAF SNVs. This runs a quick analysis on the WXS PBTA samples so 
we could try to parse whether this was a WXS thing or a TCGA thing. 

### Conclusion: 
Lancet was also doing poorly with PBTA WXS samples. 

```{r}
# magrittr pipe
`%>%` <- dplyr::`%>%`

scratch_dir <- file.path("..", "..", "..", "scratch")
```

Set up this function. 

```{r}
upset_plot <- function(callers_per_mutation_df) {
callers_per_mutation_df %>% 
  dplyr::group_by(caller_combo) %>%
  dplyr::tally() %>% 
  ggplot2::ggplot(ggplot2::aes(x = reorder(caller_combo, -n), y = n)) +
  ggplot2::geom_bar(
        position = "dodge", stat = "identity") +
  ggplot2::theme_classic() +
  ggupset::scale_x_mergelist(sep = "-") +
  ggupset::axis_combmatrix(sep = "-") +
  ggplot2::xlab("") +
  ggplot2::ylab("")
}
```

## Connect to database

Connect to SQLite database.

```{r}
# Start up connection
con <- DBI::dbConnect(RSQLite::SQLite(), 
                      file.path(scratch_dir, "v11_snv_db.sqlite"))
```

Note what columns we will join by.

```{r}
join_cols = c("Chromosome",
              "Start_Position",
              "Reference_Allele",
              "Allele",
              "Tumor_Sample_Barcode", 
              "Variant_Classification")
```

Set up tables from the database but only call the columns we need. 
Note that we are only keeping the WXS samples. 

```{r}
strelka <- dplyr::tbl(con, "strelka") %>% 
  dplyr::select(join_cols, "VAF") %>% 
    dplyr::inner_join(
    dplyr::tbl(con, "samples") %>% 
      dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                    experimental_strategy, short_histology)) %>% 
    dplyr::filter(experimental_strategy == "WXS")

lancet <- dplyr::tbl(con, "lancet") %>% 
  dplyr::select(join_cols, "VAF") %>% 
    dplyr::inner_join(
    dplyr::tbl(con, "samples") %>% 
      dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                    experimental_strategy, short_histology)) %>% 
    dplyr::filter(experimental_strategy == "WXS")

mutect <- dplyr::tbl(con, "mutect") %>% 
  dplyr::select(join_cols, "VAF") %>% 
    dplyr::inner_join(
    dplyr::tbl(con, "samples") %>%  
      dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                    experimental_strategy, short_histology)) %>% 
    dplyr::filter(experimental_strategy == "WXS")

# Note that we will drop Vardict, but because of the join script, we will keep it in for now. 
vardict <- dplyr::tbl(con, "vardict") %>% 
  dplyr::select(join_cols, "VAF") %>% 
    dplyr::inner_join(
    dplyr::tbl(con, "samples") %>% 
      dplyr::select(Tumor_Sample_Barcode = Kids_First_Biospecimen_ID,
                    experimental_strategy, short_histology)) %>% 
    dplyr::filter(experimental_strategy == "WXS")
```

Because `DBI` does not support full_join, we had to use a series of `left_join` and
`union_all` calls in order to get a full join of all the callers. 

```{r}
# This script will do the full join of the data for us
source(file.path("util", "full_join_callers.R"))

# Bring out the data.frame
all_caller_df <- all_caller %>%
  as.data.frame

# Take a peek at what this looks like
head(all_caller_df)
```

```{r}
# Set up the data as a data.frame
vaf_df <- all_caller_df %>% 
  dplyr::select("VAF_lancet", "VAF_strelka", "VAF_vardict", "VAF_mutect",
                "Variant_Classification") %>%
  dplyr::mutate(VAF_consensus = VAF_strelka) %>% 
  dplyr::filter(!is.na(VAF_lancet) | !is.na(VAF_strelka) | !is.na(VAF_mutect)) %>% 
  dplyr::select(-VAF_vardict)
 
# Determine which mutations are part of the consensus
consensus_index <- vaf_df %>%
  dplyr::select(-c(VAF_consensus, Variant_Classification)) %>%
  rowSums(is.na(.)) > 0

# Make non consensus VAF into an NA
vaf_df$VAF_consensus[consensus_index] <- NA

# Make this long form for plotting and 
long_vaf_df <- vaf_df %>% 
  dplyr::mutate(index = factor(1:nrow(.))) %>% 
  tidyr::gather(key = "caller", value = "vaf", -index, -Variant_Classification) %>% 
  dplyr::mutate(caller = gsub("VAF_", "", caller)) %>% 
  dplyr::filter(!is.na(vaf))
```

Get median vaf for each mutation with each caller combination. 

```{r}
# Take out the consensus VAF for this combination
long_caller_df <- long_vaf_df %>% 
  dplyr::filter(caller != "consensus")

# Determine the combination of callers for each mutation
callers_per_mutation <- tapply(
    long_caller_df$caller,
    long_caller_df$index,
    paste0,
    collapse = "-"
  ) %>% 
  as.data.frame() %>%
  tibble::rownames_to_column("index")

# Determine Median VAF for each mutation 
vaf_med <- tapply(
    long_caller_df$vaf,
    long_caller_df$index,
    median
  ) %>% 
  as.data.frame() %>%
  tibble::rownames_to_column("index")

# Join the median VAF and the callers that call that mutation into one data.frame
callers_per_mutation <- callers_per_mutation %>%
  dplyr::inner_join(vaf_med, by = "index") %>%
  dplyr::left_join(long_caller_df %>% 
                      dplyr::select(Variant_Classification, index), 
                   by = "index") %>%
  # Make column names more sensible
  dplyr::rename(caller_combo = "..x", median_vaf = "..y") 
```

## Upset graph

Make the upset plot. 

```{r}
upsettr_plot <- callers_per_mutation %>%
  upset_plot() + 
  ggplot2::ggtitle("WXS samples only")

# Print this out here
upsettr_plot
```

## VAF distributions

Make a violin plot of each caller. 

```{r}
long_vaf_df %>%
  ggplot2::ggplot(ggplot2::aes(x = caller, y = vaf, color = caller)) +
  ggplot2::geom_violin() +
  ggplot2::theme_classic() +
  colorblindr::scale_color_OkabeIto() + 
  ggplot2::ggtitle("WXS samples only")
```

## Session Info

```{r}
sessionInfo()
```
