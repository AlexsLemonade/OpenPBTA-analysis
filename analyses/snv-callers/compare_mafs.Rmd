---
title: "Compare Variant Caller"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---

Purpose: After running the initial analyses of each variant caller, this notebook 
combines the output from those calculations and compares them. 

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/tmb-calculations/compare_variant_callers.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

Read in set up script.

```{r}
if (!("ggupset" %in% installed.packages())) {
  install.packages("ggupset", repos='http://cran.us.r-project.org')
}
```

Set up output directories. 

```{r}
base_results_dir <- "results"
base_plots_dir <- "plots"
```

Make new directories for the comparison analysis.

```{r}
compare_results_dir <- file.path(base_results_dir, "comparisons")
compare_plots_dir <- file.path(base_plots_dir, "comparisons")

# Make caller specific plots folder
if (!dir.exists(compare_results_dir)) {
  dir.create(compare_results_dir)
}
# Make caller specific plots folder
if (!dir.exists(compare_plots_dir)) {
  dir.create(compare_plots_dir)
}
```

## Import data 

```{r}
caller_names <- c("strelka2", "mutect2", "lancet", "vardict")

dir(base_results_dir)
```

Get the lists of each type of file. 

```{r}
# Get the lists of each type of file
vaf_files <- list.files(base_results_dir, pattern = "_vaf.tsv$", recursive = TRUE, 
                        full.names = TRUE) 
tmb_files <- list.files(base_results_dir, pattern = "_tmb.tsv$", recursive = TRUE, 
                        full.names = TRUE) 
region_annot_files <- list.files(base_results_dir, pattern = "_region.tsv$", recursive = TRUE, 
                        full.names = TRUE) 
```

Make a big VAF data.frame

```{r}
vaf <- lapply(vaf_files, function(file) 
  readr::read_tsv(file) %>%
    dplyr::select("mutation_id", "vaf")
)
names(vaf) <- caller_names
vaf_df <- dplyr::bind_rows(vaf, .id = "caller") 

ggplot2::ggplot(vaf_df, ggplot2::aes(x = vaf, color = caller)) +
  ggplot2::geom_density() + 
  ggplot2::theme_classic() + 
  ggplot2::xlab("VAF") + 
  ggplot2::ylab("Density") 


# Make a mutation ID list object from this
mutation_ids <- lapply(vaf, function(df) dplyr::select(df, mutation_id) %>% 
                         dplyr::pull(mutation_id))
```

Make a big tmb data.frame

```{r}
tmb <- lapply(tmb_files, readr::read_tsv)
names(tmb) <- caller_names
tmb_df <- dplyr::bind_rows(tmb, .id = "caller") 
```

Make a big genomic region data.frame

```{r}
region_annot <- lapply(region_annot_files, readr::read_tsv)
names(region_annot) <- caller_names
region_annot_df <- dplyr::bind_rows(region_annot, .id = "caller") 
```

## UpsettR

```{r}
ggplot2::ggplot(dplyr::distinct(vaf_df, mutation_id, caller), ggplot2::aes(x = caller)) +
  ggplot2::geom_bar() +
  ggupset::scale_x_upset()
```

## Venn Diagram

```{r}
overlap <- VennDiagram::calculate.overlap(mutation_ids)
ggplot2::ggplot(vaf_df)
```

## Base Changes 

```{r}

```

## VAF distributions

```{r}
vaf_df %>% 
  ggplot2::ggplot(ggplot2::aes(x = caller, y = vaf, fill = caller)) + 
  ggplot2::geom_violin() + 
  ggplot2::theme_classic() + 
  colorblindr::scale_fill_OkabeIto()
```

## TMB distributions

```{r}
tmb_df %>% 
  ggplot2::ggplot(ggplot2::aes(x = caller, y = tmb, fill = caller)) + 
  ggplot2::geom_violin() + 
  ggplot2::theme_classic() + 
  colorblindr::scale_fill_OkabeIto()
```

## VAF correlations

```{r}
vaf_df %>% 
  tidyr::spread(key = "caller", value = "vaf", drop = TRUE)


  ggplot2::ggplot(ggplot2::aes(x = vaf, y = vaf)) + 
  ggplot2::geom_point() + 
  ggplot2::theme_classic() + 
  colorblindr::scale_fill_OkabeIto() + 
  ggplot2::facet_wrap(~caller)
``` 

## TMB correlations

```{r}

```

## Genomic regions 

```{r}
region_annot_df %>% 
  dplyr::group_by(type, caller) %>% 
  dplyr::summarize(count = dplyr::n()) %>%
  ggplot2::ggplot(ggplot2::aes(x = type, y = count)) + 
  ggplot2::theme_classic() + 
  ggplot2::geom_bar(position = "dodge", stat = "identity",
        ggplot2::aes(fill = caller)) + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1)) +
  ggplot2::xlab("") +
  ggplot2::ylab("Count") +
  colorblindr::scale_fill_OkabeIto()
```

## Session Info

```{r}
sessionInfo()
```
