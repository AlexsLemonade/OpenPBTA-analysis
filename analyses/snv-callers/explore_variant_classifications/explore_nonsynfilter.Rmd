---
title: "Explore impact of Non Synonymous Filters"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2020
---

### Summary of Findings:

As far as the TMB comparisons go, it doesn't matter if we use `Variant_Classification` filters or not. 
They are highly correlated no matter what and the same general TCGA to PBTA differences seem to persist. 

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/snv-callers/explore_nonsynfilter.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

Read in set up script.

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`
```


On AWS, if both `run_caller_consensus_analysis-tcga.sh` and `run_caller_consensus_analysis-pbta.sh` have been run, you can run this to get the TMB files. 
```
# bash calculate_tmb_no_nonsynfilter.sh
```

## Read in the TMB files

### Read in PBTA data

```{r}
tmb_pbta_no_filter <- data.table::fread(file.path(
  "..",
  "results",
  "no_filter",
  "pbta-snv-mutation-tmb-coding.tsv"
)) %>%
  # This variable is weird when binding but we don't need it for the plot so we'll just remove it.
  dplyr::select(-region_size) %>%
  dplyr::filter(experimental_strategy != "Panel") %>% 
  dplyr::mutate(filter = "no filter")
```

```{r}
tmb_pbta_with_filter <- data.table::fread(file.path(
  "..",
  "results",
  "consensus",
  "pbta-snv-mutation-tmb-coding.tsv"
)) %>%
  # This variable is weird when binding but we don't need it for the plot so we'll just remove it.
  dplyr::select(-region_size) %>%
  dplyr::filter(experimental_strategy != "Panel") %>% 
  dplyr::mutate(filter = "filter")
```

```{r}
tmb_pbta <- dplyr::inner_join(tmb_pbta_no_filter, 
                              dplyr::select(tmb_pbta_with_filter, Tumor_Sample_Barcode, tmb),
                              by = "Tumor_Sample_Barcode", 
                              suffix = c("_no_filter", "_filter"))
```

### Read in TCGA data

```{r}
tmb_tcga_no_filter <- data.table::fread(file.path(
  "..",
  "results",
  "no_filter",
  "tcga-snv-mutation-tmb-coding.tsv"
)) %>%
  dplyr::select(-region_size) %>% 
  dplyr::mutate(filter = "no filter")
```

```{r}
tmb_tcga_with_filter <- data.table::fread(file.path(
  "..",
  "results",
  "consensus",
  "tcga-snv-mutation-tmb-coding.tsv"
)) %>%
  dplyr::select(-region_size) %>% 
  dplyr::mutate(filter = "filter")
```

Join these together. 

```{r}
tmb_tcga <- dplyr::inner_join(tmb_tcga_no_filter, 
                              dplyr::select(tmb_tcga_with_filter, Tumor_Sample_Barcode, tmb),
                              by = "Tumor_Sample_Barcode", 
                              suffix = c("_no_filter", "_filter"))
```

## Does the filter change a participant's TMB?

### Plot PBTA data

```{r}
cor.test(tmb_pbta$tmb_filter, tmb_pbta$tmb_no_filter)
```

```{r}
ggplot2::ggplot(tmb_pbta, ggplot2::aes(x = tmb_no_filter, y = tmb_filter, color = short_histology)) +
 ggplot2::geom_point() +
 ggplot2::xlim(0, 5) + 
 ggplot2::ylim(0, 5) +
 ggplot2::theme_classic() 
```

### Plot TCGA data

```{r}
cor.test(tmb_tcga$tmb_filter, tmb_tcga$tmb_no_filter)
```

```{r}
ggplot2::ggplot(tmb_tcga, ggplot2::aes(x = tmb_no_filter, y = tmb_filter, color = short_histology)) +
 ggplot2::geom_point() +
 ggplot2::xlim(0, 5) + 
 ggplot2::ylim(0, 5) +
 ggplot2::theme_classic() + 
 ggplot2::facet_wrap(~short_histology)
```

## Does the filter affect the TCGA-PBTA comparison change?

```{r}
all_data <- dplyr::bind_rows(list(tcga = tmb_tcga, pbta = tmb_pbta), .id = "dataset") %>%
  dplyr::select(tmb_filter, tmb_no_filter, dataset, Tumor_Sample_Barcode, short_histology) %>% 
  tidyr::gather("filter", "tmb", -Tumor_Sample_Barcode, -dataset, -short_histology)
```

```{r}
ggplot2::ggplot(all_data, ggplot2::aes(x = dataset, y = tmb)) +
 ggforce::geom_sina() +
 ggplot2::theme_classic() + 
 ggplot2::ylim(0, 10) + 
 ggplot2::theme(legend.position = "none") + 
 ggplot2::facet_wrap("filter")
```

## Session Info

```{r}
sessionInfo()
```
