---
title: "GISTIC copy number calls comparison at the gene level"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Chante Bethell for ALSF CCDL
date: 2020
---

This notebook will use the files prepared in `02-GISTIC-tidy-data-prep.Rmd` and stored in this module's `results` directory to compare the copy number calls made by GISTIC to the copy number calls we have prepared in the `analyses/focal-cn-file-preparation` module.

The purpose of this notebook is to compare GISTIC's copy number calls to our copy number calls at a gene level. 

## Usage

This notebook is intended to be run via the command line from the top directory
of the repository as follows:

```
Rscript -e "rmarkdown::render('analyses/compare-gistic/03-GISTIC-gene-level-cn-status-comparison.Rmd', clean = TRUE)"
```

## Set up

```{r}
library(tidyverse)
```

### Functions

```{r}
get_gene_tally <- function(gene_status_df,
                           gene_mapping_df,
                           method = "gistic",
                           biospecimens_included = NULL,
                           genes_included = NULL) {
  # This function takes two data.frames: 1) either an annotated seg file 
  # (method = "exon") from `focal-cn-file-preparation` or the gene status 
  # data.frame from prepare_gene_level_gistic (method = "gistic") and 2) the 
  # peak assignment output of prepare_gene_level_gistic and returns a tally of 
  # copy number status for individual genes
  # 
  # Args:
  #   gene_status_df: either an annotated seg file (set method = "exon") from 
  #                   `focal-cn-file-preparation` or the gene status data.frame 
  #                   from prepare_gene_level_gistic (set method = "gistic")
  #   gene_mapping_df: the peak assignment output of prepare_gene_level_gistic 
  #   method: "gistic" or "exon", see above
  #   biospecimens_included: a vector of biospecimen identifiers to be used
  #                          to filter gene_status_df; intended to be used when
  #                          method = "exon"
  #   genes_included: a vector of gene symbols to be used to filter 
  #                   gene_status_df; intended to be used when method = "exon"
  # 
  # Returns:
  #   gene_tally_df: a data.frame with the following columns
  #                  1. gene: gene symbol
  #                  2. gain: number of gains tallied
  #                  3. loss: number of losses tallied
  #                  4. neutral: number of copy neutral events tallied
  #                  5. detection_peak: all peaks a gene symbol mapped to 
  #                                     via GISTIC, comma-separated
  
  # TODO: error-handling throughout this function could probably be a bit more
  # robust
  if ((method == "exon") & any(c(is.null(biospecimens_included), 
                                 is.null(genes_included)))) {
    stop("The 'exon' method is intended to be used with the 
         biospecimens_included and genes_included arguments")
  }
  
  # If a vector of biospecimen IDs is provided, filter only to those biospecimen
  # ids
  if (!is.null(biospecimens_included)) {
    gene_status_df <- gene_status_df %>%
      filter(Kids_First_Biospecimen_ID %in% biospecimens_included)
  }
  
  # If a vector of genes is provided, filter only to those genes
  if (!is.null(genes_included)) {
    gene_status_df <- gene_status_df %>%
      filter(gene %in% genes_included)
  }
  
  gene_tally_df <- gene_status_df %>%
    # Remove any genes that are "nearest genes." We don't expect them to be *in*
    # the peak and therefore do not expect them to be comparable to the other
    # method that we used.
    filter(str_detect(gene, "\\[", negate = TRUE)) %>%
    # Count the number of times a copy number alteration occurs in an individual
    # gene
    group_by(gene, status) %>%
    tally() %>%
    spread(status, n) %>%
    # Any instances where a copy number alteration is NA are equivalent to a 
    # count of zero
    replace_na(list(loss = 0, 
                    gain = 0))
  
  # In the GISTIC case, missing values in the neutral column are the same as
  # zero counts
  if (method == "gistic") {
    gene_tally_df <- gene_tally_df %>%
      replace_na(list(neutral = 0))
  }
  
  # Because neutral calls are not included in the annotated consensus file,
  # we can assume the number of neutral calls is the number of samples included 
  # minus any alterations (gain + loss)
  if (method == "exon") {
    gene_tally_df <- gene_tally_df %>%
       mutate(neutral = length(biospecimens_included) - (gain + loss))
  }
  
  gene_tally_df %>%
    # Add detection peak information to this data.frame. Peaks can be 
    # overlapping in GISTIC and contain the same gene symbols, so we need to 
    # summarize the detection_peak column
    inner_join(gene_mapping_df %>%
                 select(gene,
                        detection_peak),
               by = "gene") %>%
    group_by(gene, gain, loss, neutral) %>%
    summarize(detection_peak = paste(detection_peak, collapse = ", "))
  
}
```

### Files and Directories

```{r}
# Path to results directory -- this is the input and output directory for this
# notebook
results_dir <- "results"
# Path to our focal CN files directory
focal_dir <- file.path("..", "focal-cn-file-preparation", "results")
# Path to GISTIC results
gistic_dir <- file.path("..", "run-gistic", "results")
```

#### Input

```{r}
# Files related to the entire cohort
cohort_mapping_file <- file.path(results_dir, 
                                 "cohort_gistic_peak_assignment.tsv.gz")
cohort_gene_status <- file.path(results_dir, 
                                "cohort_gistic_gene_cn_status_table.tsv.gz")
cohort_seg_counts <- file.path(gistic_dir, 
                               "pbta-cnv-consensus-gistic",
                               "sample_seg_counts.txt")

# Files related to LGAT samples only
lgat_mapping_file <- file.path(results_dir, 
                               "lgat_gistic_peak_assignment.tsv.gz")
lgat_gene_status <- file.path(results_dir, 
                              "lgat_gistic_gene_cn_status_table.tsv.gz")
lgat_seg_counts <- file.path(gistic_dir, 
                             "pbta-cnv-consensus-lgat-gistic",
                             "sample_seg_counts.txt")

# File generated via the overlapping exons method 
annotated_cn_file <- file.path(focal_dir, 
                               "consensus_seg_annotated_cn_autosomes.tsv.gz")
```

#### Output

```{r}
cohort_exon_file <- file.path(results_dir,
                              "cohort_gene_level_focal_cn_counts.tsv")
cohort_gistic_file <- file.path(results_dir,
                                "cohort_gene_level_gistic_cn_counts.tsv")
lgat_exon_file <- file.path(results_dir,
                            "lgat_gene_level_focal_cn_counts.tsv")
lgat_gistic_file <- file.path(results_dir,
                              "lgat_gene_level_gistic_cn_counts.tsv")
```

## Read in files

```{r}
# Read in the gene level files prepared in `02-GISTIC-tidy-data-prep.Rmd`
cohort_gene_mapping <- read_tsv(cohort_mapping_file)
cohort_gene_level_calls <- read_tsv(cohort_gene_status)
lgat_gene_mapping <- read_tsv(lgat_mapping_file)
lgat_gene_level_calls <- read_tsv(lgat_gene_status)

# Get the biospecimen identifiers for samples that were included in the GISTIC
# run
all_ids_in_consensus <- read_tsv(cohort_seg_counts) %>%
  filter(included == "yes") %>%
  pull(`sample`)

lgat_ids_in_consensus <- read_tsv(lgat_seg_counts) %>%
  filter(included == "yes") %>%
  pull(`sample`)

# Read in the consensus focal CN calls file and rename gene and biospecimen
# columns
consensus_focal_cn_calls <- read_tsv(annotated_cn_file) %>%
  rename(gene = gene_symbol,
         Kids_First_Biospecimen_ID = biospecimen_id)
```

## Count copy number alterations

### Entire cohort

```{r}
cohort_gistic_tally <- get_gene_tally(gene_status_df = cohort_gene_level_calls,
                                      gene_mapping_df = cohort_gene_mapping,
                                      method = "gistic") %>%
  write_tsv(cohort_gistic_file)
cohort_exon_tally <- get_gene_tally(gene_status_df = consensus_focal_cn_calls,
                                    gene_mapping_df = cohort_gene_mapping,
                                    method = "exon",
                                    biospecimens_included = all_ids_in_consensus,
                                    genes_included = cohort_gistic_tally$gene) %>%
  write_tsv(cohort_exon_file)
```

### LGAT only

```{r}
lgat_gistic_tally <- get_gene_tally(gene_status_df = lgat_gene_level_calls,
                                      gene_mapping_df = lgat_gene_mapping,
                                      method = "gistic") %>%
  write_tsv(lgat_gistic_file)
lgat_exon_tally <- get_gene_tally(gene_status_df = consensus_focal_cn_calls,
                                    gene_mapping_df = lgat_gene_mapping,
                                    method = "exon",
                                    biospecimens_included = lgat_ids_in_consensus,
                                    genes_included = lgat_gistic_tally$gene) %>%
  write_tsv(lgat_exon_file)
```

## Session Info

```{r}
sessionInfo()
```


