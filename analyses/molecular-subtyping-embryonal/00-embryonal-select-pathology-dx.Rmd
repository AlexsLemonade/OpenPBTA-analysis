---
title: "Select pathology diagnoses for inclusion"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Chante Bethell for ALSF CCDL
date: 2020
---

Code for this notebooked was adapted from the `analyses/molecular-subtyping-HGG/00-HGG-select-pathology-dx.Rmd`(https://github.com/AlexsLemonade/OpenPBTA-analysis/blob/f65c803706d9c1eea7f2892cb8b638f3d47d15c6/analyses/molecular-subtyping-HGG/00-HGG-select-pathology-dx.Rmd) notebook.

## Background

Originally, we subtyped tumors in this module if the specimen satisfied one of the following criteria:

1. An RNA-seq biospecimen sample includes a _TTYH1_ fusion (5' partner) [per this comment](https://github.com/AlexsLemonade/OpenPBTA-analysis/pull/401#issuecomment-573669727).
2. Any sample with "Embryonal tumor" in the `broad_histology` column of the metadata `pbta-histologies.tsv` that is not labeled "Medulloblastoma" or "Atypical Teratoid Rhabdoid Tumor (ATRT)" in `pathology_diagnosis` or `integrated_diagnosis` columns [per this comment](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/251#issuecomment-568220913).

In an upcoming release, `integrated_diagnosis`, which can be updated as the result of subtyping, will be used to populate the `broad_histology` column (see [#748](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/748)).
Thus, molecular subtyping modules need to be upstream of `broad_histology` and use the `pathology_diagnosis` and `pathology_free_text_diagnosis` fields.

Filtering on the basis of `broad_histology == Embryonal tumor` is more straightforward than using the pathology diagnosis fields, so we include this notebook to put together the terms in `pathology_diagnosis` and `pathology_free_text_diagnosis`.

We will use the 2016 WHO Classification as our guide ([Louis et al. _Acta Neuropathol._ doi: 10.1007/s00401-016-1545-1](10.1007/s00401-016-1545-1)) and take a look at the current version of the histology file (`release-v17-20200908`).

## Set up

```{r}
library(tidyverse)
```

### Directories and files

We're going to tie this to a specific release.

```{r}
data_dir <- file.path("..", "..", "data", "release-v17-20200908")
histologies_file <- file.path(data_dir, "pbta-histologies.tsv")
```

We're going to save the pathology diagnosis information we'll use to generate the subset files in a directory `hgg-subset`.

```{r}
output_dir <- "subset-files"
output_file <- file.path(output_dir, 
                         "embryonal_subtyping_path_dx_strings.json")
```

## Read in data

```{r}
histologies_df <- read_tsv(histologies_file)
```

## Explore the pathology diagnoses

### `broad_histology == Embryonal tumor`

In the current histologies file, if we filter based on `broad_histology` as we did originally, and drop medulloblastoma and ATRT samples using the pathology diagnosis labels, what is left in the pathology diagnosis fields?
Note that some of the `broad_histology` values will have been altered based on earlier subtyping efforts.

```{r}
histologies_df %>%
  filter(
    str_detect(str_to_lower(pathology_diagnosis), "neuroblastoma") |
      pathology_diagnosis == "Supratentorial or Spinal Cord PNET"
  ) %>%
  count(pathology_diagnosis) %>%
  arrange(desc(n))
```

For the most part, this is as we would expect given the 2016 WHO classifications.
There is an ependymoma sample and a high-grade glioma sample that should probably be excluded.

Let's take a look at the free text field.

```{r}
histologies_df %>% 
  filter(
    str_detect(str_to_lower(pathology_diagnosis), "neuroblastoma") |
      pathology_diagnosis == "Supratentorial or Spinal Cord PNET"
  ) %>%
  group_by(pathology_free_text_diagnosis) %>%
  tally() %>%
  arrange(desc(n))
```

No medulloblastoma or ATRT samples here.

## Pathology diagnosis strings for inclusion

These are the terms that we'll collapse together with `|` to detect strings in the `pathology_diagnosis` column.
 
```{r}
path_dx_terms <- c(
  "supratentorial or spinal cord pnet"
) # "neuroblastoma" will also need to be detect in the `pathology_diagnosis` column, but the logic around it is a bit more complex so we will handle this term specifically when we filter
```

These are the terms that we'll collapse together with `|` to detect strings in the `pathology_free_text_diagnosis` column.

```{r}
free_text_dx_terms <- c(
  "embryonal tumor with multilayer rosettes, ros (who grade iv)",
  "embryonal tumor, nos, congenital type",
  "ependymoblastoma",
  "medullooepithelioma"
)
```

Let's take a look at a first attempt using these terms as described above.

```{r}
filtered_on_dx_df <- histologies_df %>%
  filter(str_detect(str_to_lower(pathology_diagnosis), 
                    paste0(path_dx_terms, collapse = "|")) |
           pathology_diagnosis == "Other" &&
           str_detect(str_to_lower(pathology_free_text_diagnosis), 
                      paste0(free_text_dx_terms, collapse = "|")) |
           (str_detect(str_to_lower(pathology_diagnosis), "neuroblastoma") & !(str_detect(str_to_lower(primary_site), "other locations nos")) & !(str_detect(str_to_lower(pathology_free_text_diagnosis), "peripheral")))) %>%
  select(Kids_First_Biospecimen_ID, 
         sample_id, 
         Kids_First_Participant_ID,
         pathology_diagnosis,
         pathology_free_text_diagnosis,
         integrated_diagnosis,
         primary_site,
         broad_histology)
filtered_on_dx_df
```

Let's tally the values in `pathology_diagnosis` in this data frame.

```{r}
filtered_on_dx_df %>%
  count(pathology_diagnosis) %>%
  arrange(desc(n))
```

We know we need to drop medulloblastoma and ATRT samples.
We can also exclude LGG and neurofibroma samples on the basis of the values in `pathology_diagnosis`.

```{r}
exclude_path_dx_terms <- c("medulloblastoma",
                           "atypical teratoid rhabdoid tumor (atrt)",
                           "low-grade glioma/astrocytoma",
                           "neurofibroma/plexiform;other")
```

### Save the strings we'll use downstream

Create a list with the strings we'll use for inclusion and exclusion.

```{r}
terms_list <- list(include_path_dx = path_dx_terms,
                   include_free_text = free_text_dx_terms,
                   exclude_path_dx = exclude_path_dx_terms)
```

Save this list as JSON.

```{r}
writeLines(jsonlite::prettify(jsonlite::toJSON(terms_list)), output_file)
```

## Session Info

```{r}
sessionInfo()
```