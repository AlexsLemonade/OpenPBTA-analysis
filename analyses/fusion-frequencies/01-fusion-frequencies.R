

# Create output dir ------------------------------------------------------------

# Detect the ".git" folder -- this will in the project root directory.
# Use this as the root directory to ensure proper sourcing of functions no
# matter where this is called from
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
setwd(root_dir)

# Set path to results, plots, and subset files directories
data_dir <- file.path(root_dir, "data")
module_dir <- file.path(root_dir, "analyses", "fusion-frequencies")
results_dir <- file.path(module_dir, "results")

# Source function
source(file.path(module_dir,"utils","freq_counts.R"))

# Create results folder if it doesn't exist
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

# Read fusion, independent sample list, and histology data ------------------------
message('Read data...')
htl_df <- read_tsv(file.path(data_dir,'histologies.tsv'), guess_max = 100000,
                   col_types = cols(.default = col_guess()))
# assert no Kids_First_Biospecimen_ID or Kids_First_Participant_ID is NA
stopifnot(identical(
  sum(is.na(select(htl_df, Kids_First_Biospecimen_ID,
                   Kids_First_Participant_ID))),
  as.integer(0)))

fusion_df <- read_tsv(file.path(root_dir,
  'analyses/fusion_filtering/results/pbta-fusion-putative-oncogenic.tsv'))
# assert all records have Sample
stopifnot(identical(sum(is.na(fusion_df$Sample)), as.integer(0)))

# primary independent sample data frame
primary_indp_sdf <- read_tsv(file.path(
  root_dir,
  'analyses/independent-samples/results/independent-specimens.wgs.primary.tsv'),
  col_types = cols(
    .default = col_guess()))

# relapse independent samples
relapse_indp_sdf <- read_tsv(file.path(
  root_dir,
  'analyses/independent-samples/results/independent-specimens.wgs.relapse.tsv'),
  col_types = cols(
    .default = col_guess()))

#efo cancer_group mappings
efo_mondo_cg_df <- read_tsv(file.path(data_dir,'efo-mondo-map.tsv'),
                            col_types = cols(.default = col_guess())) %>%
  distinct()
# efo_mondo_cg_df$cancer_group[
#   !efo_mondo_cg_df$cancer_group %in% htl_df$cancer_group]

# assert all cancer_groups are not NA
stopifnot(identical(sum(is.na(efo_mondo_cg_df$cancer_group)), as.integer(0)))
# assert all cancer_groups are unique.
# result SNV table is left joined by cancer_groups
stopifnot(identical(length(unique(efo_mondo_cg_df$cancer_group)),
                    nrow(efo_mondo_cg_df)))

# ensg hugo rmtl mappings
ensg_hugo_rmtl_df <- read_tsv(file.path(data_dir,'ensg-hugo-rmtl-v1-mapping.tsv'),
                              col_types = cols(.default = col_guess())) %>%
  distinct()
# assert all ensg_ids and gene_symbols are not NA
stopifnot(identical(sum(is.na(ensg_hugo_rmtl_df$ensg_id)), as.integer(0)))
stopifnot(identical(sum(is.na(ensg_hugo_rmtl_df$gene_symbol)), as.integer(0)))
# assert all ensg_id are unique
# result SNV table is left joined by ensg_id
stopifnot(identical(length(unique(ensg_hugo_rmtl_df$ensg_id)),
                    nrow(ensg_hugo_rmtl_df)))



# Subset independent samples in histology table --------------------------------
message('Prepare data...')
# td = tumor descriptor
td_htl_dfs <- list(
  primary_htl_df = htl_df %>%
    filter(Kids_First_Biospecimen_ID %in%
             primary_indp_sdf$Kids_First_Biospecimen_ID),
  
  relapse_htl_df = htl_df %>%
    filter(Kids_First_Biospecimen_ID %in%
             relapse_indp_sdf$Kids_First_Biospecimen_ID),
  
  overall_htl_df = htl_df %>%
    filter(sample_type == 'Tumor')
)

# keep only samples with non-NA cancer_group and cohort
# add cancer_group_cohort column
td_htl_dfs <- lapply(td_htl_dfs, function(x) {
  # assert all Kids_First_Biospecimen_IDs are unique
  stopifnot(identical(nrow(x), length(unique(x$Kids_First_Biospecimen_ID))))
  
  fx <- filter(x, !is.na(cancer_group), !is.na(cohort))
  fx <- mutate(
    fx, cancer_group_cohort = paste(cancer_group, cohort, sep = '___'))
  return(fx)
})



# Subset tumor samples and used columns in MAF table ---------------------------
tumor_kfbids <- htl_df %>%
  filter(sample_type == 'Tumor') %>%
  pull(Kids_First_Biospecimen_ID)

fusion_df <- fusion_df  %>%
  # We want to keep track of the gene symbols for each sample-fusion pair
  dplyr::select(Sample,
                Kids_First_Participant_ID, 
                FusionName, 
                Gene1A, 
                Gene1B, 
                Gene2A, 
                Gene2B, 
                Fusion_Type,
                DomainRetainedGene1A,
                DomainRetainedGene1B,
                reciprocal_exists,
                ends_with("anno")) %>%
  mutate(Alt_ID=paste(FusionName, Fusion_Type),sep="_") %>%
  rename("Kids_First_Biospecimen_ID"="Sample",
         "Kinase_domain_retained_Gene1A" = "DomainRetainedGene1A",
         "Kinase_domain_retained_Gene1B" = "DomainRetainedGene1B",
         "Reciprocal_exists" = "reciprocal_exists")%>%
  # replace NA to "" in columns that have NA
  replace_na(list("Kinase_domain_retained_Gene1A"="",
                  "Kinase_domain_retained_Gene1B"="",
                  "Gene1A_anno"="",
                  "Gene1B_anno"="",
                  "Gene2A_anno"="",
                  "Gene2B_anno"="",
                  "Fusion_anno"=""))%>%
  # We want a single column that contains the gene symbols
  tidyr::gather(Gene1A, Gene1B, Gene2A, Gene2B,
                key = gene_position, value = gene_symbol) %>%
  filter(!is.na(gene_symbol))


rm(tumor_kfbids)
suppressMessages(gc(reset = TRUE))



# Compute mutation frequencies -------------------------------------------------
message('Compute mutation frequencies...')
cancer_group_cohort_summary_df <- get_cg_cs_tbl(td_htl_dfs$overall_htl_df)

# nf = n_samples filtered
nf_cancer_group_cohort_summary_df <- cancer_group_cohort_summary_df %>%
  filter(n_samples >= 5)

# Run get_cg_ch_mut_freq_tbl() per cancer_group and cohort
fus_freq_tbl_list <- lapply(
  1:nrow(nf_cancer_group_cohort_summary_df),
  function(i) {
    cgcs_row <- nf_cancer_group_cohort_summary_df[i, ]
    stopifnot(identical(nrow(cgcs_row), as.integer(1)))
    stopifnot(identical(length(cgcs_row$cohort_list), as.integer(1)))
    stopifnot(is.character(cgcs_row$cohort_list[[1]]))
    
    c_cancer_group <- cgcs_row$cancer_group
    c_cohorts <- cgcs_row$cohort_list[[1]]
    stopifnot(identical(paste(c_cohorts, collapse = '&'), cgcs_row$cohort))
    message(paste(c_cancer_group, cgcs_row$cohort))
    
    # Call function for each cohort and cancer_group
    res_df <- get_cg_ch_mut_freq_tbl(
      fusion_df, td_htl_dfs$overall_htl_df, td_htl_dfs$primary_htl_df,
      td_htl_dfs$relapse_htl_df, c_cancer_group, c_cohorts) %>%
      # if Alt_ID has no counts delete the row
      filter(!is.na(Total_alterations))
    
    if ( nrow(res_df) != 0 ){
    # merge fusion dataframe with the counts and frequencies in each cancer_group
    # - per cohort 
    # - per primary samples in cohort
    # - per relapse samples in cohort
    fusion_df <- fusion_df %>% 
      select(-Kids_First_Biospecimen_ID,-Kids_First_Participant_ID) %>%
      unique() %>%
      inner_join(res_df,by="Alt_ID") 
    
    return(fusion_df)
    }
  }
)

m_fus_freq_tbl <- bind_rows(fus_freq_tbl_list) %>%
  distinct()

m_fus_freq_tbl <- m_fus_freq_tbl %>%
  mutate(Dataset = if_else(Dataset == 'PBTA&GMKF&TARGET',
                           true = 'PedOT', false = Dataset))%>%
  # replace NA to "" in columns that have NA
  replace_na(list("Kinase_domain_retained_Gene1A"="",
                  "Kinase_domain_retained_Gene1B"="",
                  "Reciprocal_exists"="",
                  "Gene1A_anno"="",
                  "Gene1B_anno"="",
                  "Gene2A_anno"="",
                  "Gene2B_anno"="",
                  "Fusion_anno"="")
  )

stopifnot(identical(sum(is.na(m_fus_freq_tbl)), as.integer(0)))

             


# Add EFO, MONDO, and RMTL to the output table ---------------------------------
ann_efo_mondo_cg_df <- efo_mondo_cg_df %>%
  rename(Disease = cancer_group, EFO = efo_code, MONDO = mondo_code)

m_fus_freq_tbl <- m_fus_freq_tbl %>%
  left_join(ann_efo_mondo_cg_df, by = 'Disease') %>%
  replace_na(list(EFO = '', MONDO = ''))

# asert all rmtl NAs have version NAs, vice versa
stopifnot(identical(is.na(ensg_hugo_rmtl_df$rmtl),
                    is.na(ensg_hugo_rmtl_df$version)))
ann_ensg_hugo_rmtl_df <- ensg_hugo_rmtl_df %>%
  filter(!is.na(rmtl), !is.na(version)) %>%
  mutate(RMTL = paste0(rmtl, ' (', version, ')')) %>%
  select(ensg_id, RMTL,gene_symbol) %>%
  rename(Gene_Ensembl_ID = ensg_id) 

m_fus_freq_tbl <- m_fus_freq_tbl %>%
  left_join(ann_ensg_hugo_rmtl_df, by = "gene_symbol") %>%
  replace_na(list(RMTL = '',
                  Gene_Ensembl_ID = ''))
stopifnot(identical(sum(is.na(m_fus_freq_tbl)), as.integer(0)))


# Add additional gene annotations ---------------------------------------------------
message('Retrieve Gene_full_name and Protein_RefSeq_ID from mygene.info...')
ens_gids <- ensg_hugo_rmtl_df$ensg_id[which(ensg_hugo_rmtl_df$gene_symbol %in%
                                              fusion_df$gene_symbol)]
ens_gids <- ens_gids[!is.na(ens_gids)]

mg_qres_list <- mygene::queryMany(
  ens_gids, scopes = 'ensembl.gene', fields = c('refseq', 'name'),
  species = 'human', returnall = TRUE, return.as = 'DataFrame')

mg_qres_df <- as_tibble(
  mg_qres_list$response[, c('query', 'notfound', 'name', 'refseq.protein')]) %>%
  replace_na(list(notfound = FALSE)) %>%
  filter(!notfound) %>%
  group_by(query) %>%
  summarise(name = paste(unique(name), collapse = ', '),
            refseq_protein = collapse_rp_lists(refseq.protein)) %>%
  rename(Gene = query, Gene_full_name = name,
         Protein_RefSeq_ID = refseq_protein)

# add additional fields to MAF df
m_fus_freq_tbl <- m_fus_freq_tbl %>%
  left_join(mg_qres_df, by = c('Gene_Ensembl_ID'='Gene')) %>%
  replace_na(list(Gene_Ensembl_ID='',
                  Gene_full_name=''))

suppressMessages(gc(reset = TRUE))


m_fus_freq_tbl <- m_fus_freq_tbl %>%
  select(gene_symbol, RMTL, Gene_Ensembl_ID,
         Gene_full_name, FusionName,
         Dataset, Disease, EFO, MONDO, Fusion_Type,
         Total_alterations_Over_Patients_in_dataset,
         Frequency_in_overall_dataset,
         Total_primary_tumors_mutated_Over_Primary_tumors_in_dataset,
         Frequency_in_primary_tumors,
         Total_relapse_tumors_mutated_Over_Relapse_tumors_in_dataset,
         Frequency_in_relapse_tumors) %>%
  rename(
         Gene_Symbol = gene_symbol)


# assert all rows are unique
# stopifnot(identical(nrow(m_fus_freq_tbl),
#                     sum(sapply(fus_freq_tbl_list, nrow))))

write_tsv(m_fus_freq_tbl,
          file.path(results_dir, 'putative-oncogene-fusion-annotated-freq.tsv'))

jsonlite::write_json(
  m_fus_freq_tbl,
  file.path(results_dir, 'putative-oncogene-fusion-annotated-freq.json'))
