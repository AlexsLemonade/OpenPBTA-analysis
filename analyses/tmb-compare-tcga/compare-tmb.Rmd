---
title: "Tumor Mutation Burden Comparison with TCGA data"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---

#### Purpose

Plot the consensus tumor mutation burden statistics for PBTA in comparison to TCGA brain-related data. 

#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/tmb-compare-tcga/compare-tmb.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

```{r}
# magrittr pipe
`%>%` <- dplyr::`%>%`

# Load in these functions so we can use `maf_to_granges`
source(file.path("..", "snv-callers", "util", "tmb_functions.R"))
```

Declare names of input and output directories.

```{r}
data_dir <- file.path("..", "..", "data")
scratch_dir <- file.path("..", "..", "scratch")
results_dir <- "results"
plots_dir <- "plots"
```

Create output directories for this analysis. 

```{r}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Custom function for plotting the TMB. 

Function for making a combined CDF plot for TMB. 
This plotting function was adapted from the [`breaks_cdf_plot` function in the 
`chromosomal-instability`](https://github.com/AlexsLemonade/OpenPBTA-analysis/blob/b1b73fe321a97fa82d85c86d20bd85635aabba25/analyses/chromosomal-instability/util/chr-break-plot.R#L120)

```{r}
tmb_cdf_plot <- function(tmb_df, plot_title) {
  # Given a data.frame of TMB data, plot it as a CDF plot and save it as a png. 
  #
  # Args:
  #   tmb_df: a chromosomal breaks density file path where each sample is
  #                 a row with `samples` and `breaks_count` columns. 
  #   plot_title: to be used for the ggplot2::ggtitle and what it will be saved 
  #                as a png as.
  
  cdf_plot <- tmb_df %>%
    as.data.frame() %>%
    dplyr::mutate(short_histology = tools::toTitleCase(short_histology)) %>%
    # Only plot histologies groups with more than `min_samples` number of samples
    dplyr::group_by(short_histology, add = TRUE) %>%
    # Only keep groups with this amount of samples
    dplyr::filter(dplyr::n() > 5) %>%
    # Calculate histology group mean
    dplyr::mutate(
      hist_mean = mean(tmb),
      hist_rank = rank(tmb, ties.method = "first") / dplyr::n(),
      sample_size = paste0("n = ", dplyr::n())
    ) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(short_histology = reorder(short_histology, hist_mean)) %>%
    # Now we will plot these as cummulative distribution plots
    ggplot2::ggplot(ggplot2::aes(
      x = hist_rank,
      y = tmb,
      color = datasets
    )) +
    ggplot2::geom_point() +
    # Add summary line for mean
    ggplot2::geom_segment(
      x = 0, xend = 1, color = "grey",
      ggplot2::aes(y = hist_mean, yend = hist_mean)
    ) +
    # Separate by histology
    ggplot2::facet_wrap(~ short_histology + sample_size, nrow = 1, strip.position = "bottom") +
    ggplot2::theme_classic() +
    ggplot2::xlab("") +
    ggplot2::ylab("TMB") +
    # Transform to log10 make non-log y-axis labels
    ggplot2::scale_y_continuous(trans = "log1p", breaks = c(0, 1, 3, 10, 30)) +
    ggplot2::scale_x_continuous(limits = c(-0.2, 1.2), breaks = c()) +
    # Making it pretty
    ggplot2::theme(legend.position = "none") +
    ggplot2::theme(
      axis.text.x = ggplot2::element_blank(),
      axis.ticks.x = ggplot2::element_blank(),
      strip.placement = "outside",
      strip.text = ggplot2::element_text(size = 10, angle = 90, hjust = 1),
      strip.background = ggplot2::element_rect(fill = NA, color = NA)
    ) +
    ggplot2::ggtitle(plot_title)

  # Save as a PNG
  ggplot2::ggsave(filename = file.path(plots_dir, paste0("tmb-cdf-", plot_title, ".png")), 
                  plot = cdf_plot, 
                  width = 10, 
                  height = 7.5)
}
```

## Set up consensus data

Read in the consensus TMB file. 

```{r include=FALSE}
# TODO: update if the consensus file gets updated in a future data release
tmb_pbta <- data.table::fread(file.path("..", 
                                        "snv-callers",
                                        "results",
                                        "consensus", 
                                        "pbta-snv-mutation-tmb-coding.tsv"))
```


```{r include=FALSE}
# TODO: update if the consensus file gets updated in a future data release
tmb_tcga <- data.table::fread(file.path("..", 
                                        "snv-callers",
                                        "results",
                                        "consensus",
                                        "tcga-snv-mutation-tmb-coding.tsv"))
```

## Plot the TMB as a CDF plot

Combine both TMB data.frames into one. 

```{r}
tmb_df <- dplyr::bind_rows(list(
  pbta = tmb_pbta,
  tcga = tmb_tcga),
  .id = "datasets")
```

Plot as CDF. 

```{r}
tmb_cdf_plot(tmb_df, plot_title = "")
```

Print from png so rendering is smoother
![TMB Plot](./plots/tmb_tcga_and_pbta_cdf_plot.png)

## Session Info

```{r}
sessionInfo()
```
