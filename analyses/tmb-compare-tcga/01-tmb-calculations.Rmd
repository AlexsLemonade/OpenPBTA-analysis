---
title: "Tumor Mutation Burden"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: C. Savonen for ALSF CCDL
date: 2019
---


#### Usage

To run this from the command line, use:
```
Rscript -e "rmarkdown::render('analyses/tmb-calculations/01-tmb-calculations.Rmd', 
                              clean = TRUE)"
```

_This assumes you are in the top directory of the repository._

## Setup

#### Packages and functions

```{r}
if (!("TCGAbiolinks" %in% installed.packages())) {
  install.packages("TCGAbiolinks")
}
# magrittr pipe
`%>%` <- dplyr::`%>%`


source(file.path("..", "snv-callers", "util", "wrangle_functions.R"))
```

Declare names of output directories.

```{r}
data_dir <- file.path("..", "..", "data")
scratch_dir <- file.path("..", "..", "scratch")
results_dir <- "results"
plots_dir <- "plots"
```

Create output directories in this analysis folder if they weren't made 

```{r}
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

## Read in data

Download and read in the consensus MAF file. 

```{r}
# Declare file path for consensus file
consensus_file <- file.path(data_dir, "snv-consensus", "consensus_mutation_tmb.tsv")

# If this file hasn't been downloaded, download and unzip it.
if (!file.exists(consensus_file)) {
# Download the file
download.file("https://open-pbta.s3.amazonaws.com/data/snv-consensus/snv-consensus_1112019.zip", 
              destfile = file.path(data_dir, "snv-consensus_1112019.zip"))

# Get the files in this zip file
unzip(file.path(data_dir, "snv-consensus_1112019.zip"),
      exdir = data_dir)
}
```

Read in the consensus MAF file. 

```{r}
# Read in the file
tmb <- data.table::fread(consensus_file)
```

Read in the regions for the PBTA data to used for calculating TMB for TCGA data. 

```{r}
# Set up BED region files for TMB calculations
wgs_bed <- readr::read_tsv(opt$bed_wgs, col_names = FALSE)

# Calculate size of genome surveyed
wgs_genome_size <- sum(wgs_bed[, 3] - wgs_bed[, 2])

# Filter out mutations for WXS that are outside of these BED regions.
vaf_df <- wxs_bed_filter(vaf_df, wxs_bed_file = opt$bed_wgs)

```

```{r}
gbm_maf <- TCGAbiolinks::GDCquery_Maf("GBM", pipelines = "mutect")
lgg_maf <- TCGAbiolinks::GDCquery_Maf("LGG", pipelines = "mutect")
```

```{r}
tmb %>% 
  ggplot2::ggplot(ggplot2::aes(x = short_histology, y = tmb)) + 
  ggplot2::geom_jitter(ggplot2::aes(color = short_histology)) + 
  ggplot2::theme_classic() + 
  ggplot2::ylab("Number of Mutations per Mb") +
  ggplot2::xlab("") +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, hjust = 1), 
                 legend.position = "none") +
  ggplot2::stat_summary(fun = "mean", geom = "crossbar",
                        width = .5, color = "black")
```

## Session Info

```{r}
sessionInfo()
```
