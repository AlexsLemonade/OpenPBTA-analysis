---
title: "Plot scores for TP53 inactivation"
output: html_notebook
---

### Description
This script uses the tp53 inactivation from the classifer
and plots the distribution of tp53 status for both stranded and polya.
Additional barplots also visualize distribution for samples with high
tp53 inactivation without tp53 mutations/losses.


Read in scores from tp53-nf1-classifier and tp53 status file used for the evaluation
```{r}

#rootdir
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
analyses_dir<-file.path(root_dir,"analyses","tp53_nf1_score")
data_dir<-file.path(root_dir,"data")

library("ggpubr")
library("ggthemes")
library("tidyverse")
score_stranded_df<-read_tsv(file.path(analyses_dir,"results","score_status_stranded.tsv")) %>% dplyr::select("TP53_SCORE","tp53_status","sample_id","Kids_First_Biospecimen_ID","Kids_First_Participant_ID") %>% unique()

score_stranded_long<-reshape2::melt(score_stranded_df,id=c("tp53_status","sample_id","Kids_First_Biospecimen_ID","Kids_First_Participant_ID")) 
score_stranded_long$tp53_status<-factor(score_stranded_long$tp53_status)

score_polya_df<-read_tsv(file.path(analyses_dir,"results","score_status_polya.tsv")) %>% dplyr::select("TP53_SCORE","tp53_status","sample_id","Kids_First_Biospecimen_ID","Kids_First_Participant_ID") %>% unique()

score_polya_long<-reshape2::melt(score_polya_df,id=c("tp53_status","sample_id","Kids_First_Biospecimen_ID","Kids_First_Participant_ID")) 
score_polya_long$tp53_status<-factor(score_polya_long$tp53_status)


histology<-read_tsv(file.path(data_dir,"release-v16-20200320","pbta-histologies.tsv"))

tp53_status<-read_tsv(file.path(analyses_dir,"results","TP53_NF1_snv_alteration.tsv")) %>%
  # select only tp53
  dplyr::filter(Hugo_Symbol=="TP53") %>%
  dplyr::left_join(histology,by=c("Tumor_Sample_Barcode"="Kids_First_Biospecimen_ID"))
```

Boxplots for score distribution according to the tp53 inactivation scores
```{r}
ggplot(score_stranded_long)+ geom_boxplot(aes(x=tp53_status,y = value))+stat_compare_means(aes(x=tp53_status,y = value))+ggtitle("stranded")+theme_bw()
ggplot(score_polya_long)+ geom_boxplot(aes(x=tp53_status,y = value))+stat_compare_means(aes(x=tp53_status,y = value))+ggtitle("polya")+theme_bw()
```

Get boxplot for SNV versus loss TP53 
```{r}
tp53_mutant_status_score<-score_stranded_df %>%
  dplyr::filter(tp53_status==1) %>%
  dplyr::left_join(tp53_status,by=c("sample_id","Kids_First_Participant_ID"))
 
ggplot(tp53_mutant_status_score)+ geom_boxplot(aes(x=Variant_Classification ,y = TP53_SCORE))+stat_compare_means(aes(x=Variant_Classification ,y = TP53_SCORE))+theme_bw()+ggtitle("Distribution of scores across abberations")+theme(axis.text.x = element_text(angle=60))
```


Bar plot for broad histology distribution for top 250 sample with
high tp53 inactivation score and no identified TP53 abberations in
SNV or CNV
```{r}
# select samples that have no tp53 mutation/losses but have high tp53 inactivation score 
score_stranded_df_non_mutanat_ordered <- score_stranded_df %>%
  # desc to get top TP53 non mutant samples with high scores
  dplyr::arrange(desc(TP53_SCORE)) %>%
  # Kids_First_Biospecimen_ID in the scores are NA because of no matching SNV samples
  dplyr::filter(!is.na(Kids_First_Biospecimen_ID),
                # select for TP53 non mutant samples
                tp53_status == 0) %>%
  head(250) %>%
  dplyr::left_join(histology,by=c("sample_id","Kids_First_Biospecimen_ID","Kids_First_Participant_ID"))

# barplots for broad_histology
ggplot(score_stranded_df_non_mutanat_ordered)+geom_bar(aes(x=broad_histology))+theme(axis.text.x = element_text(angle=90))+coord_flip()+ylab("count")+xlab("broad_histology")+theme_bw()+ggtitle("Distribution of broad histology of TP53 non-mutant samples with high scores  ")

```

SNV in other genes for samples where no TP53 mutation or CNV loss 
was found but has high tp53 inactivation score
```{r}
# snv calls
snv_df <- data.table::fread(file.path(data_dir,
                                      "pbta-snv-consensus-mutation.maf.tsv.gz"),
                            select = c("Chromosome",
                                       "Start_Position",
                                       "End_Position",
                                       "Strand",
                                       "Variant_Classification",
                                       "Tumor_Sample_Barcode",
                                       "Hugo_Symbol",
                                       "HGVSp_Short"),
                            data.table = FALSE)

snv_df_goi <-snv_df %>% dplyr::filter(Hugo_Symbol !="TP53") %>%
  dplyr::left_join(histology[,c("Kids_First_Biospecimen_ID","sample_id")],by=c("Tumor_Sample_Barcode"="Kids_First_Biospecimen_ID")) 

score_stranded_df_non_mutanat_ordered_snv <- score_stranded_df_non_mutanat_ordered %>%
  dplyr::left_join(snv_df_goi,by=c("sample_id")) %>%
  dplyr::filter(Variant_Classification %in% c("Missense_Mutation",
                                              "Splice_Site",
                                              "Nonsense_Mutation",
                                              "Frame_Shift_Del",
                                              "In_Frame_Del",
                                              "Frame_Shift_Ins",
                                              "Splice_Region" )) %>%
  dplyr::group_by(Hugo_Symbol) %>%
  tally() %>%
  dplyr::arrange(desc(n)) %>%
  dplyr::filter(n>=5) %>%
  dplyr::mutate(
    Hugo_Symbol = forcats::fct_relevel(Hugo_Symbol, .$Hugo_Symbol)
  )

# barplot for snvs
ggplot(score_stranded_df_non_mutanat_ordered_snv)+geom_col(aes(x=Hugo_Symbol,y=n))+theme(axis.text.x = element_text(angle=90))+coord_flip()+ylab("count")+xlab("broad_histology")+theme_bw()+ggtitle("Distribution of mutated genes in TP53 non-mutant samples with high scores ")


```


