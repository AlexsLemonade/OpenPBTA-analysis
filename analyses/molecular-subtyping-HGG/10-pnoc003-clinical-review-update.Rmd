---
title: "Update clinically reviewed subtype for PNOC003 samples"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Krutika Gaonkar for D3b
---

As part of molecular-subtype-HGG analysis we assign a HGG or DMG subtype from looking for K28M histone variants, in this notebook we are identifying samples which have differences between the clinically reviewed subtype and subtype from molecular-subtype-HGG module in PNOC003 and update
those for the OpenPBTA subtyping module results

Adding information from the original [issue](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/751) added by @jharenza 
 
**UPDATE 2020-10-05** 
Below is a double-reviewed (by Cassie Kline and myself) table of histone mutations found in the specified patient tumor per the TGEN genomic reports. 

Kids_First_Participant_ID | H3 Status | tumor_descriptor
-- | -- | --
PT_M23Q0DC3 | H3F3A K28M | Initial CNS Tumor
PT_9GKVQ9QS | H3F3A K28M | Initial CNS Tumor
PT_KBFM551M | H3 WT | Initial CNS Tumor
PT_KBFM551M | no report | Progressive   Disease Post-Mortem
PT_V1HNAC2Q | H3F3A K28M | Initial CNS Tumor
PT_NK8A49X5 | H3F3A K28M | Initial CNS Tumor
PT_NK8A49X5 | H3F3A K28M | Progressive
PT_KZ56XHJT | H3F3A K28M | Initial CNS Tumor
PT_KZ56XHJT | H3F3A K28M | Progressive
PT_KZ56XHJT | no report | Progressive   Disease Post-Mortem
PT_QA9WJ679 | H3F3A K28M | Initial CNS Tumor
PT_WGVEF96B | H3F3A K28M | Initial CNS Tumor
PT_HGM20MW7 | H3F3A K28M | Initial CNS Tumor
PT_0MXPTTM3 | H3 WT | Initial CNS Tumor
PT_M9XXJ4GR | H3F3A K28M | Initial CNS Tumor
PT_KTRJ8TFY | H3F3A K28M | Initial CNS Tumor
PT_KTRJ8TFY | no report | Progressive   Disease Post-Mortem
PT_1E3E6GMF | H3F3A K28M | Initial CNS Tumor
PT_VPEMAQBN | HIST1H3B K28M | Initial CNS Tumor
PT_7P6J57H3 | H3F3A K28M | Initial CNS Tumor
PT_C5FKRB1P | H3 WT | Initial CNS Tumor
PT_CSKHQB16 | HIST1H3B K28M | Initial CNS Tumor
PT_1AAYYGGY | H3F3A K28M | Initial CNS Tumor
PT_NWYSD53S | H3F3A K28M | Initial CNS Tumor
PT_8P368R5B | No report | Initial CNS Tumor
PT_C9YDTZPA | H3F3A K28M | Initial CNS Tumor
PT_KAQMYFYB | H3F3A K28M | Initial CNS Tumor
PT_Y74CVASJ | H3F3A K28M | Initial CNS Tumor
PT_W5GP3F6B | H3F3A K28M | Initial CNS Tumor
PT_A06JR0E5 | H3F3A K28M | Initial CNS Tumor
PT_EN2RN5Y1 | H3F3A K28M | Initial CNS Tumor
PT_DMAF1J4A | H3F3A K28M | Initial CNS Tumor
PT_RYMG3M91 | H3F3A K28M | Initial CNS Tumor
PT_RE6AXQM1 | H3F3A K28M | Initial CNS Tumor
PT_G16VK7FR | HIST1H3B K28M | Initial CNS Tumor
PT_1YQH5NSH | H3F3A K28M | Initial CNS Tumor


```{r}
library("tidyverse")

# clinical pbta histology
clinical <- read_tsv("../../data/pbta-histologies.tsv") %>%
  # keep only Tumor
  dplyr::filter(sample_type == "Tumor",
                # in v17 we only had solid tissues as part of subtyping
                # will need remove for v18 
                composition == "Solid Tissue") 
  
# subtyping from molecular-subtype-HGG
subtype <- read_tsv("results/HGG_molecular_subtype.tsv") %>%  
  # ids to match
  left_join(clinical[,c("Kids_First_Participant_ID",
                        "Kids_First_Biospecimen_ID",
                        # need tumor_descriptor to match to clinical review
                        "tumor_descriptor",
                        # will update Notes as well so added those here
                        "Notes")],by=c("Kids_First_Biospecimen_ID_DNA"="Kids_First_Biospecimen_ID",
                                       "Kids_First_Participant_ID")) %>%
  # removing Kids_First_Biospecimen_ID to only match on Kids_First_Participant_ID and
  # tumor descriptor values
  dplyr::select(-Kids_First_Biospecimen_ID_DNA,
                Kids_First_Biospecimen_ID_RNA)



# clinical review file for PNOC003 
pnoc003_review <- read_tsv("input/pnoc003_clinical_review.tsv") 

```

Identify pnoc003 samples that have differences between clinical review subtype
and molecular subtype from histone variant mutation status

```{r}
diff_subtype <- subtype %>% left_join(pnoc003_review,by=c("Kids_First_Participant_ID","tumor_descriptor")) %>% 
  dplyr::filter(
    # checking for samples where clinically reviewed subtype is H3 WT
    # but molecular subtype is not HGG
    (grepl("H3 WT",.$`H3 Status`) & !grepl("HGG",molecular_subtype)) |
    # checking for samples where clinically reviewed subtype is H3 K28M
    # but molecular subtype is not DMG H3 K28
    (grepl("K28M",.$`H3 Status`) & !grepl("DMG, H3 K28",molecular_subtype)) | 
    # checking for samples were clinical review was not found  
    grepl("no report",.$`H3 Status`) )  %>%
  dplyr::select(Kids_First_Participant_ID,
                sample_id,
                `H3 Status`,
                molecular_subtype,
                tumor_descriptor)

diff_subtype

```

Counts in each type of differences to identify how many samples already 
have subtyping updated from molecular-subtype-HGG module and how many
samples need molecular subtype updated from clinical review

```{r}

diff_subtype %>% 
  group_by(`H3 Status`,molecular_subtype) %>%
  tally()

```


Seems like 3 sample (WXS from PT_NK8A49X5, PT_QA9WJ679, PT_WGVEF96B) molecular subtype 
need to be updated and Notes columns for these samples will be updated to capture this 
information

```{r}
subtype_clinical_review_df <- subtype %>%
  # matching only on "Kids_First_Participant_ID","tumor_descriptor"
  left_join(pnoc003_review,by=c("Kids_First_Participant_ID","tumor_descriptor")) %>% 
  dplyr::mutate(
    Notes =  case_when(
      
      (grepl("H3 WT",.$`H3 Status`) & !grepl("HGG",molecular_subtype)) 
      ~ paste(Notes,"Updated to HGG, H3 wildtype from clinical review",sep=","),
      (grepl("K28M",.$`H3 Status`) & !grepl("DMG, H3 K28",molecular_subtype)) 
      ~ paste(Notes,"Updated to DMG, H3 K28 from clinical review", sep=","),
      TRUE ~ Notes
    ),
    molecular_subtype =  case_when(
      (grepl("H3 WT",.$`H3 Status`) & grepl("HGG",molecular_subtype)) |
        (grepl("K28M",.$`H3 Status`) & grepl("DMG, H3 K28",molecular_subtype)) 
      ~ molecular_subtype,
      (grepl("H3 WT",.$`H3 Status`) & !grepl("HGG",molecular_subtype)) ~ 
        gsub("DMG, H3 K28","HGG, H3 wildtype",molecular_subtype),
      (grepl("K28M",.$`H3 Status`) & !grepl("DMG, H3 K28",molecular_subtype)) ~ 
        gsub("HGG, H3 wildtype","DMG, H3 K28",molecular_subtype)
    )
  ) %>%
  write_tsv("results/HGG_molecular_subtype-clinical-review-update.tsv")
  
```

