---
title: "Select pathology diagnoses for inclusion"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Jaclyn Taroni for ALSF CCDL
date: 2020
---

## Background

Originally, we subtyped tumors in this module if the specimen satisfied one of the following criteria:

1. A defining lesion was identified in the SNV consensus file (H3 K28M or G35R/V)
2. The `short_histology` was `HGAT`.

In an upcoming release, `integrated_diagnosis`, which can be updated as the result of subtyping, will be used to populate the `short_histology` (see [#748](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/748)).
Thus, molecular subtyping modules need to be upstream of `short_histology` and use the `pathology_diagnosis` and `pathology_free_text_diagnosis` fields.
This change for this module is tracked in [#754](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/754).

Filtering on the basis of `short_histology == HGAT` is more straightforward than using the pathology diagnosis fields, so we include this notebook to put together the terms in `pathology_diagnosis` and `pathology_free_text_diagnosis`.

We will use the 2016 WHO Classification as our guide ([Louis et al. _Acta Neuropathol._ doi: 10.1007/s00401-016-1545-1](10.1007/s00401-016-1545-1)) and take a look at the current version of the histology file (`release-v17-20200908`).

## Set up

```{r}
library(tidyverse)
```

### Directories and files

We're going to tie this to a specific release.

```{r}
data_dir <- file.path("..", "..", "data", "release-v17-20200908")
histologies_file <- file.path(data_dir, "pbta-histologies.tsv")
```

We're going to save the pathology diagnosis information we'll use to generate the subset files in a directory `hgg-subset`.

```{r}
output_dir <- "hgg-subset"
output_file <- file.path(output_dir, 
                         "hgg_subtyping_path_dx_strings.json")
```

## Read in data

```{r}
histologies_df <- read_tsv(histologies_file)
```

## Explore the pathology diagnoses

### `short_histology == HGAT`

In the current histologies file, if we filter based on `short_histology` as we did originally, what is in the pathology diagnosis fields?
Note that some of these values will have been altered based on earlier subtyping efforts.
(That's why we're doing this!)

```{r}
histologies_df %>% 
  filter(short_histology == "HGAT") %>%
  group_by(pathology_diagnosis) %>%
  tally() %>%
  arrange(desc(n))
```

For the most part, this is as we would expect given the 2016 WHO classifications. 
In an initial round of subtyping, PNET specimens were reclassified (see [this comment on #609](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/609#issuecomment-602821376)).

Let's take a look at the free text field.

```{r}
histologies_df %>% 
  filter(short_histology == "HGAT") %>%
  group_by(pathology_free_text_diagnosis) %>%
  tally() %>%
  arrange(desc(n))
```

As we might expect from a free text field, this is a lot less uniform.

## Pathology diagnosis strings for inclusion

These are the terms that we'll collapse together with `|` to detect strings in the `pathology_diagnosis` column.

```{r}
path_dx_terms <- c(
  "High-grade glioma/astrocytoma",
  "Diffuse Astrocytoma",
  "Anaplastic Astrocytoma",
  "Diffuse intrinsic pontine glioma",
  "Diffuse midline glioma",
  "Diffuse Astrocytoma",
  "DIPG", 
  "High grade glioma"
)
```

These are the terms that we'll collapse together with `|` to detect strings in the `pathology_free_text_diagnosis` column.

```{r}
free_text_dx_terms <- c(
  "high grade glioma",
  "high-grade glioma",
  "hgg",
  "anaplastic astrocytoma",
  "glioblastoma",
  "diffuse midline glioma",
  "diffuse astrocytoma",
  "dipg",
  "gbm",
  "anaplastic pilocytic astrocytoma",
  "anaplastic gliomatosis cerebri",
  "anaplastic pleomorphic xanthoastrocytoma"
)
```

Let's take a look at a first attempt using these terms as described above.

```{r}
filtered_on_dx_df <- histologies_df %>%
  filter(str_detect(pathology_diagnosis, 
                    paste0(path_dx_terms, collapse = "|")) | 
           str_detect(pathology_free_text_diagnosis, 
                     paste0(free_text_dx_terms, collapse = "|"))) %>%
  select(Kids_First_Biospecimen_ID, 
         sample_id, 
         Kids_First_Participant_ID,
         pathology_diagnosis,
         pathology_free_text_diagnosis,
         integrated_diagnosis, 
         short_histology)

filtered_on_dx_df
```

Let's tally the values in `pathology_diagnosis` in this data frame.

```{r}
filtered_on_dx_df %>%
  group_by(pathology_diagnosis) %>%
  tally() %>%
  arrange(desc(n))
```

Why are there low-grade glioma samples included?

```{r}
filtered_on_dx_df %>%
  filter(pathology_diagnosis == "Low-grade glioma/astrocytoma (WHO grade I/II)")
```

We can exclude LGG samples on the basis of the values in `pathology_diagnosis`, too.

```{r}
exclude_path_dx_terms <- c("Low-grade glioma/astrocytoma")
```

### Save the strings we'll use downstream

Create a list with the strings we'll use for inclusion and exclusion.

```{r}
terms_list <- list(include_path_dx = path_dx_terms,
                   include_free_text = free_text_dx_terms,
                   exclude_path_dx = exclude_path_dx_terms)
```

Save this list as JSON.

```{r}
writeLines(jsonlite::toJSON(terms_list, pretty = TRUE), output_file)
```

## Session Info

```{r}
sessionInfo()
```

