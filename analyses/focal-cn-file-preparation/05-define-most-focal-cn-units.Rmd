---
title: "Find most focal recurrent copy number units"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Chante Bethell for ALSF CCDL
date: 2020
params:
  is_ci: FALSE
---

This notebook defines the most focal recurrent copy number units by separating out entire chromsome arm losses and gains.

## Usage

This notebook is intended to be run from the command line with the following (assumes you are in the root directory of the repository):

```
Rscript -e "rmarkdown::render('analyses/focal-cn-file-preparation/05-define-most-focal-cn-units.Rmd', clean = TRUE)"
```

## Set up

### Libraries and functions

```{r}
library(tidyverse)
```

### Files and directories

```{r}
results_dir <- "results"

# Define a logical object for running in CI
running_in_ci <- params$is_ci
```

### Read in files

```{r}
# Read in the file with consensus CN status data and the UCSC cytoband data --
# generated in `03-add-cytoband-status-consensus.Rmd`
consensus_seg_cytoband_status_df <-
  read_tsv(file.path("results", "consensus_seg_with_ucsc_cytoband_status.tsv.gz"))

# Read in the annotated CN file (without the UCSC data)
consensus_seg_autosomes_df <-
  read_tsv(file.path(results_dir, "consensus_seg_annotated_cn_autosomes.tsv.gz"))
```

## Define most focal units

### First, we want find entire chromosome arm losses/gains.

```{r}
consensus_seg_cytoband_status_df <-
  consensus_seg_cytoband_status_df %>%
  select(chromosome_arm,
         dominant_status,
         cytoband,
         Kids_First_Biospecimen_ID)

arm_status_count <- consensus_seg_cytoband_status_df %>%
  # Count the amount og times each arm has a specific `dominant_status` value
  count(chromosome_arm, dominant_status) %>%
  # Spread the data -- each row represents a unique chromosome arm
  spread(dominant_status, n) %>%
  select(-c("uncallable", "unstable")) %>%
  replace_na(list(
    gain = 0,
    loss = 0,
    neutral = 0
  )) %>%
  group_by(chromosome_arm) %>%
  # The logic here is to define the arm status based on the majority of calls
  # in the chromosome arm -- if the number of calls for a specific status is
  # responsible for more than 50% of the total calls in that arm, then it is
  # used to define the arm status
  mutate(
    arm_dominant = case_when(
      gain > (0.49 * (gain + loss + neutral)) ~ "arm_gain",
      loss > (0.49 * (gain + loss + neutral)) ~ "arm_loss",
      neutral > (0.49 * (gain + loss + neutral)) ~ "arm_neutral",
      TRUE ~ "uncallable"
    )
  ) %>%
  select(c("chromosome_arm", "arm_dominant"))

# Display table
arm_status_count
```

### Next we want to use the annotated CN data to define the cytoband gains/losses 

We want to include cytoband and gene level calls for chromosome arms that have not been defined as a gain or loss.

```{r}
# These are the chromosome arms that have not been defined as gain or loss --
# we want to define their cytoband/gene level status
neutral_arm_status_df <- arm_status_count %>%
  filter(arm_dominant == "arm_neutral")

# Filter the annotated CN data to include only these chromosome arms
consensus_seg_autosomes_df_develop <- consensus_seg_autosomes_df %>%
  select(biospecimen_id, gene_symbol, cytoband, status) %>%
  mutate(chromosome_arm = gsub("(p|q).*", "\\1", cytoband)) %>%
  filter(chromosome_arm %in% neutral_arm_status_df$chromosome_arm)

# Now count the cytoband level calls (for each status call) and define
# the cytoband as that status if more than 50% of the total counts are
# for that particular status
cytoband_status_count <- consensus_seg_autosomes_df_develop %>%
  count(cytoband, status) %>%
  # Spread the data -- each row represents a unique chromosome arm
  spread(status, n) %>%
  replace_na(list(
    gain = 0,
    loss = 0,
    amplification = 0
  )) %>%
  group_by(cytoband) %>%
  # The logic here is to define the arm status based on the majority of calls
  # in the cytoband -- if the number of calls for a specific status is
  # responsible for more than 50% of the total calls in that cytoband, then it is
  # used to define the cytoband status
  mutate(
    cytoband_dominant = case_when(
      gain > (0.49 * (gain + loss + amplification)) ~ "cytoband_gain",
      loss > (0.49 * (gain + loss + amplification)) ~ "cytoband_loss",
      amplification > (0.49 * (gain + loss + amplification)) ~ "cytoband_amplification",
      TRUE ~ "cytoband_neutral"
    )
  ) %>%
  select(c("cytoband", "cytoband_dominant"))

# These are the cytobands that have not been defined as gain or loss --
# we want to define their gene level status
neutral_cytoband_status_df <- cytoband_status_count %>%
  filter(cytoband_dominant == "cytoband_neutral")

# Display table
cytoband_status_count
```

### Now we want to use the annotated CN data to define the gene level gains/losses 

```{r}
# Filter the annotated CN data to include only these cytobands
consensus_seg_autosomes_df_develop <- consensus_seg_autosomes_df %>%
  select(biospecimen_id, gene_symbol, cytoband, status) %>%
  filter(cytoband %in% neutral_cytoband_status_df$cytoband)

if (!(running_in_ci)) {
# Now count the gene level calls (for each status call) and define
# the gene as that status if more than 50% of the total counts are
# for that particular status
gene_status_count <- consensus_seg_autosomes_df_develop %>%
  count(gene_symbol, status) %>%
  # Spread the data -- each row represents a unique chromosome arm
  spread(status, n) %>%
  replace_na(list(
    gain = 0,
    loss = 0,
    amplification = 0
  )) %>%
  group_by(gene_symbol) %>%
  # The logic here is to define the gene level status based on the majority of calls
  # in the gene -- if the number of calls for a specific status is
  # responsible for more than 50% of the total calls in that gene, then it is
  # used to define the gene status
  mutate(
    gene_dominant = case_when(
      gain > (0.49 * (gain + loss + amplification)) ~ "gene_gain",
      loss > (0.49 * (gain + loss + amplification)) ~ "gene_loss",
      amplification > (0.49 * (gain + loss + amplification)) ~ "gene_amplification",
      TRUE ~ "gene_neutral"
    )
  ) %>%
  select(c("gene_symbol", "gene_dominant"))

# Display table
gene_status_count
}
```

## Combine arm, cytoband, and gene level status data

```{r}
if (!(running_in_ci)) {
  final_df <- consensus_seg_autosomes_df %>%
    mutate(chromosome_arm = gsub("(p|q).*", "\\1", cytoband)) %>%
    left_join(arm_status_count, by = "chromosome_arm") %>%
    left_join(cytoband_status_count, by = "cytoband") %>%
    left_join(gene_status_count, by = "gene_symbol")
} else {
  final_df <- consensus_seg_autosomes_df %>%
    mutate(chromosome_arm = gsub("(p|q).*", "\\1", cytoband)) %>%
    left_join(arm_status_count, by = "chromosome_arm") %>%
    left_join(cytoband_status_count, by = "cytoband")
}

# Write final table to file
write_tsv(final_df, file.path(results_dir, "consensus_seg_most_focal_cn_status.tsv.gz"))
```

## Session Info

```{r}
sessionInfo()
```

