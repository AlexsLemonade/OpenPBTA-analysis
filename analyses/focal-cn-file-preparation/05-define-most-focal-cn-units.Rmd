---
title: "Find most focal recurrent copy number units"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Chante Bethell and Candace Savonen for ALSF CCDL
date: 2020
---

This notebook defines the most focal recurrent copy number units by removing focal changes that are within entire chromosome arm losses and gains.
_Most focal_ here meaning:

- If a chromosome arm is not clearly defined as a gain or loss (and is callable) we look to define the cytoband level status
- If a cytoband is not clearly defined as a gain or loss (and is callable) we then look to define the gene-level status

## Usage

This notebook is intended to be run from the command line with the following (assumes you are in the root directory of the repository):

```
Rscript -e "rmarkdown::render('analyses/focal-cn-file-preparation/05-define-most-focal-cn-units.Rmd', clean = TRUE)"
```

### Cutoffs: 

```{r}
# The percentage of calls a particular status needs to be
# above to be called the majority status -- the decision
# for a cutoff of 90% here was made to ensure that the status
# is not only the majority status but it is also significantly
# called more than the other status values in the region
percent_threshold <- 0.9

# The percentage threshold for determining if enough of a region
# (arm, cytoband, or gene) is callable to determine its status --
# the decision for a cutoff of 50% here was made as it seems reasonable
# to expect a region to be more than 50% callable for a dominant status
# call to be made
uncallable_threshold <- 0.5
```

## Set up

### Libraries and functions

```{r}
library(tidyverse)
```

### Custom Function

```{r}
status_majority_caller <- function(status_df,
                                   region_variable,
                                   status_column_name,
                                   id_column_name,
                                   percent_threshold_val,
                                   uncallable_threshold_val = uncallable_threshold) {
  # Given a data.frame with cytoband/gene-level copy number status data,
  # find the dominant status of the cytoband/gene region by calculating
  # the percentages of the region that each call represents.
  #
  # Args:
  #   status_df: data.frame with cytoband/gene-level copy number status data
  #   region_variable: string of the column name/region to calculate copy number
  #                    status percentages for
  #   status_column_name: string of the column name that holds the relevant copy
  #                       number status data
  #   id_column_name: string of the column name that holds the sample id values
  #   percent_threshold_val: What percent of calls a particular status needs to be
  #                      above to be called the majority.
  #   uncallable_threshold_val: a threshold for determining if enough of a region is
  #                         callable to determine its status.
  #
  # Return:
  #   status_count: data.frame with percentage values for each unique status in
  #                 each unique region (arm/cytoband/gene) and the dominant
  #                 status for that region
  
  # Tidyeval for these columns
  region_sym <- rlang::sym(region_variable)
  status_sym <- rlang::sym(status_column_name)
  id_sym <- rlang::sym(id_column_name)

  # Format the data and group it
  status_df <- status_df %>%
    # Keep only the columns we need
    select(!!id_sym, !!region_sym, !!status_sym) %>%
    # Group by status, sample, and region
    group_by(!!id_sym, !!region_sym, !!status_sym) %>%
    # Get a total count of each s
    summarize(status_n = n())

  # Getting total counts by region
  region_total_df <- status_df %>%
    # Group by region and for each sample
    group_by(!!region_sym, !!id_sym) %>%
    # Get totals
    summarize(total = sum(status_n))

  # Calculate percent by using the region totals
  status_percent_df <- status_df %>%
    ungroup() %>%
    # Tack on the by region totals
    inner_join(region_total_df, 
               by = c(region_variable, id_column_name)) %>%
    # Bring back our region variable as its own column
    mutate(percent = status_n / total, 
           # We will rename this as percent since these percents now
           status_column_name := paste0("percent_", !!status_sym)) %>%
    # Don't need these columns now
    select(-status_n, -total) %>%
    # Spread to individual columns
    spread(status_column_name, percent) %>%
    # Turn NAs into 0s
    replace_na(list(
      percent_gain = 0,
      percent_loss = 0,
      percent_neutral = 0,
      percent_amplification = 0,
      percent_uncallable = 0,
      percent_unstable = 0
    ))

  # The logic here is to define the region status based on the majority of calls
  # in the region -- if the number of calls for a specific status is
  # responsible for more than `percent_threshold` value of the total calls in that
  # region, then it is used to define the region's status (exception is for the
  # uncallable status where we define the region as uncallable when more than the
  # `uncallable_threshold` of the calls in that region are uncallable)
  if ((region_variable == "chromosome_arm") | (region_variable == "gene_symbol")) {
    status_percent_df <- status_percent_df %>%
      mutate(
        dominant_status = case_when(
          percent_gain > percent_threshold_val ~ "gain",
          percent_loss > percent_threshold_val ~ "loss",
          percent_amplification > percent_threshold_val ~ "amplification",
          TRUE ~ "neutral"
        )
      )
  } else if (region_variable == "cytoband") {
    status_percent_df <- status_percent_df %>%
      mutate(
        dominant_status = case_when(
          percent_uncallable > uncallable_threshold_val ~ "uncallable",
          percent_gain > percent_threshold_val ~ "gain",
          percent_loss > percent_threshold_val ~ "loss",
          percent_neutral > percent_threshold_val ~ "neutral",
          TRUE ~ "unstable"
        )
      )
  }

  return(status_percent_df)
}
```

```{r}
plot_dominant_status_calls <- function(status_count_df) {
  # TODO: Update this documentation to reflect the select `starts_with` stategy.
  # Given a data.frame with the percentage values for each region and the
  # dominant status for that region, plot the dominant status call on the
  # x-axis with the percentage values on the y-axis.
  #
  # Args:
  #   status_count_df: data.frame with percentage values for each unique status
  #                    in each unique region (arm/cytoband/gene) and the
  #                    dominant status for that region
  # Return:
  #   status_plot: plot representing the dominant status call on the x-axis and
  #                the percentage values on the y-axis
status_count_df %>%
    # Remove the columns we don't want to plot
    select(starts_with("percent_"), dominant_status) %>%
    ungroup() %>%
    # Gather the data.frame to have columns and values in the format of
    # our status call, the percentage of total calls that status call is
    # responisble for, and the dominant status call made based on the
    # percentage value
    gather(status, percent, -dominant_status) %>%
    # Plot our focal status values on the x-axis and the percentage values
    # on the y-axis
    ggplot(ggplot2::aes(
      x = status,
      y = percent
    )) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggforce::geom_sina(alpha = .2) +
    # Facet wrap around each dominant status value
    facet_wrap(~ dominant_status)
}
```


### Files and directories

```{r}
results_dir <- "results"
```

### Read in files

Read in cytoband status file and format it for what we will need in this notebook. 

```{r}
# Read in the file with consensus CN status data and the UCSC cytoband data --
# generated in `03-add-cytoband-status-consensus.Rmd`
consensus_seg_cytoband_status_df <-
  read_tsv(file.path("results", "consensus_seg_with_ucsc_cytoband_status.tsv.gz")) %>%
  # Need this to not have `chr`
  mutate(
    chr = gsub("chr", "", chr),
    cytoband = paste0(chr, cytoband)
  ) %>%
  select(
    chromosome_arm,
    # Distinguish this dominant status that is based on cytobands, from the status
    dominant_cytoband_status = dominant_status,
    cytoband,
    Kids_First_Biospecimen_ID
  )
```

Read in the chromosome-level and gene-level data. 

```{r}
# Read in the annotated CN file (without the UCSC data)
consensus_seg_autosomes_df <-
  read_tsv(file.path(results_dir, "consensus_seg_annotated_cn_autosomes.tsv.gz"))
```

Joining the gene-level, cytoband-level, and arm-level data into one data frame.

```{r}
combined_status_df <- consensus_seg_autosomes_df %>%
  inner_join(
    consensus_seg_cytoband_status_df,
    by = c("biospecimen_id" = "Kids_First_Biospecimen_ID", "cytoband")
  )
```

## Define most focal units

### Determine chromosome arm status

```{r}
# Use our custom function to make the status calls
arm_status_count <- status_majority_caller(
  combined_status_df,
  "chromosome_arm",
  "status",
  "biospecimen_id",
  percent_threshold
)

# Display table
arm_status_count %>%
  group_by(dominant_status)
```

These are the chromosome arms that have not been defined as gain or loss -- we want to define their cytoband/gene-level status

```{r}
# Let's get a vector of the neutral arms
neutral_arms <- arm_status_count %>%
  filter(dominant_status == "neutral") %>%
  dplyr::pull("chromosome_arm")
```

### Determine cytoband status

We want to include cytoband and gene-level calls for chromosome arms that have not been defined as a gain or loss.

```{r}
# Filter the annotated CN data to include only neutral chromosome arms
neutral_status_arm_df <- combined_status_df %>%
  filter(chromosome_arm %in% neutral_arms)
```

Making cytoband-level majority calls. 

```{r}
# Now count the cytoband level calls (for each status call) and define
# the cytoband as that status if more than 50% of the total counts are
# for that particular status
cytoband_status_count <- status_majority_caller(
  neutral_status_arm_df,
  "cytoband",
  "dominant_cytoband_status",
  "biospecimen_id",
  percent_threshold
) %>%
  # Add on a chromosome column we can match to chromosome arms later
  mutate(chromosome_arm = gsub("(p|q).*", "\\1", cytoband))

# Display table
cytoband_status_count %>%
  group_by(dominant_status)
```

### Determine gene-level status

```{r}
# These are the cytobands that have not been defined as gain or loss --
# we want to define their gene-level status
neutral_cytobands <- cytoband_status_count %>%
  filter(dominant_status %in% c("unstable", "NA")) %>%
  dplyr::pull("cytoband")

# Filter the annotated CN data to include only these cytobands
neutral_status_cytoband_df <- combined_status_df %>%
  filter(cytoband %in% neutral_cytobands)
```

```{r}
# Now count the gene-level calls (for each status call) and define
# the gene as that status if more than 50% of the total counts are
# for that particular status
gene_status_count <- status_majority_caller(
  neutral_status_cytoband_df,
  "gene_symbol",
  "status",
  "biospecimen_id",
  percent_threshold
) %>%
  # Tack on a cyoband column so we can match by that later
  left_join(
    select(neutral_status_cytoband_df, gene_symbol, cytoband) %>%
      # Only keep distinct gene - cytoband matches
      distinct(),
    # Join by gene_symbol
    by = "gene_symbol"
  )

# Display table
gene_status_count
```

## Plot calls

Plot the final dominant status call on the x-axis and the percent of each status on the y-axis.

### Plot chromosome arm status calls

```{r}
# Run `plot_dominant_status_calls` function for the chromosome arm calls
plot_dominant_status_calls(
  arm_status_count
)
```

### Plot cytoband status calls

```{r fig.width = 10}
# Run `plot_dominant_status_calls` function for the cytoband calls
plot_dominant_status_calls(
  cytoband_status_count
)
```

### Plot gene status calls

```{r}
plot_dominant_status_calls(
  gene_status_count
)
```

## Combine arm, cytoband, and gene-level status data

```{r}
# For each of the datasets we're joining, we'll only keep these columns:
cols_to_keep <- c("biospecimen_id", "dominant_status")

# Combine the arm, cytoband, and gene status count data
combined_status_count_df <- arm_status_count %>%
  # Only keep these columns
  select(cols_to_keep, chromosome_arm) %>%
  # Join on the cytoband statuses
  inner_join(cytoband_status_count %>%
    select(cols_to_keep, cytoband, chromosome_arm),
  by = c("biospecimen_id", "chromosome_arm"),
  suffix = c(".arm", ".cytoband")
  ) %>%
  # Join on the gene statuses
  inner_join(gene_status_count %>%
    select(cols_to_keep, cytoband, gene_symbol),
  by = c("biospecimen_id", "cytoband"),
  suffix = c(".arm", ".gene")
  ) %>%
  # Rename so we know this is the gene symbol based dominant_status
  rename(
    dominant_status.gene = dominant_status,
    Kids_First_Biospecimen_ID = biospecimen_id
  ) # Keep this consistent with the other datasets

# Display combined status counts table
combined_status_count_df

arm_status_count


cytoband_status_count
```

## Transform data into long format

```{r}
final_long_status_df <- combined_status_count_df %>%
  # Gather statuses into one column
  gather(
    region_type,
    status,
    -Kids_First_Biospecimen_ID,
    -chromosome_arm,
    -cytoband,
    -gene_symbol
  ) %>%
  # Get rid of `dominant_status` prefix
  mutate(region_type = gsub("dominant_status.", "", region_type))

# Print out preview
final_long_status_df
```

## Write to a TSV file 

```{r}
# Write final long status table to file
write_tsv(
  final_long_status_df,
  file.path(results_dir, "consensus_seg_most_focal_cn_status.tsv.gz")
)

# Display final long status table
final_long_status_df %>%
  arrange(region_type)
```

## Session Info

```{r}
sessionInfo()
```
