---
title: "Find most focal recurrent copy number units"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Chante Bethell and Candace Savonen for ALSF CCDL
date: 2020
---

This notebook defines the most focal recurrent copy number units by removing focal changes that are within entire chromosome arm losses and gains.
_Most focal_ here meaning:

- If a chromosome arm is not clearly defined as a gain or loss (and is callable) we look to define the cytoband level status
- If a cytoband is not clearly defined as a gain or loss (and is callable) we then look to define the gene-level status

## Usage

This notebook is intended to be run from the command line with the following (assumes you are in the root directory of the repository):

```
Rscript -e "rmarkdown::render('analyses/focal-cn-file-preparation/05-define-most-focal-cn-units.Rmd', clean = TRUE)"
```

### Cutoffs: 

```{r}
# The fraction of calls a particular status needs to be
# above to be called the majority status -- the decision
# for a cutoff of 90% here was made to ensure that the status
# is not only the majority status but it is also significantly
# called more than the other status values in the region
status_threshold <- 0.9

# The fraction threshold for determining if enough of a region
# (arm, cytoband, or gene) is callable to determine its status --
# the decision for a cutoff of 50% here was made as it seems reasonable
# to expect a region to be more than 50% callable for a dominant status
# call to be made
uncallable_threshold <- 0.5
```

## Set up

### Libraries and functions

```{r}
library(tidyverse)
```

### Files and directories

```{r}
results_dir <- "results"
```

### Read in files

Read in cytoband status file and format it for what we will need in this notebook. 

```{r}
# Read in the file with consensus CN status data and the UCSC cytoband data --
# generated in `03-add-cytoband-status-consensus.Rmd`
consensus_seg_cytoband_status_df <-
  read_tsv(file.path("results", "consensus_seg_with_ucsc_cytoband_status.tsv.gz")) %>%
  # Need this to not have `chr`
  mutate(
    chr = gsub("chr", "", chr),
    cytoband = paste0(chr, cytoband)
  ) %>%
  select(
    chromosome_arm,
    # Distinguish this dominant status that is based on cytobands, from the status
    dominant_cytoband_status = dominant_status,
    cytoband,
    Kids_First_Biospecimen_ID,
    band_length,
    gain_fraction,
    loss_fraction,
    callable_fraction
  )
```

Read in the gene-level data. 

```{r}
# Read in the annotated gene level CN file
consensus_seg_autosomes_df <-
  read_tsv(file.path(results_dir, "consensus_seg_annotated_cn_autosomes.tsv.gz"))
```

## Define most focal units

### Determine chromosome arm status

```{r}
# Use our custom function to make the arm status calls
consensus_seg_arm_status <- consensus_seg_cytoband_status_df %>%
    # Group by biospecimen ID and region
    group_by(Kids_First_Biospecimen_ID, chromosome_arm) %>%
    # Summarize the weighted means for each status
    summarize(
      loss_fraction = weighted.mean(loss_fraction, band_length),
      gain_fraction = weighted.mean(gain_fraction, band_length),
      callable_fraction = weighted.mean(callable_fraction, band_length)
    ) %>%
    # Define dominant status based the weighted means meeting a status
    # threshold
    mutate(
      dominant_arm_status = case_when(
        callable_fraction < (1 - uncallable_threshold) ~ "uncallable",
        loss_fraction > status_threshold ~ "loss",
        gain_fraction > status_threshold ~ "gain",
        loss_fraction + gain_fraction > status_threshold ~ "unstable",
        TRUE ~ "neutral"
      )
    )

# Display table
consensus_seg_arm_status
```

### Determine cytoband status

We want to include cytoband and gene-level calls for chromosome arms that have not been defined as a gain or loss to make the cytoband-level majority calls.

```{r}
# Now count the cytoband level calls (for each status call) and define
# the cytoband as that status if more than the `status_threshold` fraction
# value of the total counts are for that particular status
consensus_seg_cytoband_status <-
  consensus_seg_cytoband_status_df %>%
  left_join(
    consensus_seg_arm_status,
    by = c(
      "Kids_First_Biospecimen_ID",
      "chromosome_arm"
    )
  ) %>%
  mutate(
    dominant_cytoband_status = case_when(
      callable_fraction.x < (1 - uncallable_threshold) ~ "uncallable",
      loss_fraction.x > status_threshold ~ "loss",
      gain_fraction.x > status_threshold ~ "gain",
      loss_fraction.x + gain_fraction.x > status_threshold ~ "unstable",
      TRUE ~ "neutral"
    )
  ) %>%
  # Filter the annotated CN data to include only neutral chromosome arms and disagreements
  filter(
    dominant_arm_status %in% c("neutral", "uncallable", "unstable") |
      (
        dominant_cytoband_status != dominant_arm_status &
          # bands that disagree with arm, but are not neutral (or uncallable)
          !(dominant_cytoband_status %in% c("neutral", "uncallable", "unstable"))
      )
  ) %>%
  select(
    Kids_First_Biospecimen_ID,
    cytoband,
    loss_fraction = loss_fraction.x,
    gain_fraction = gain_fraction.x,
    callable_fraction = callable_fraction.x,
    dominant_cytoband_status
  )

# Display table
consensus_seg_cytoband_status
```

### Determine gene-level status

```{r}
# Now create a data.frame with the gene-level status calls for the
# neutral, uncallable, and unstable cytoband-level calls
consensus_seg_gene_status <- consensus_seg_autosomes_df %>%
  # Create a cytoband column that keeps only the first half of the ranges
  # for joining purposes
  mutate(cytoband_no_ranges = gsub("-.*", "\\1", cytoband)) %>%
  left_join(
    consensus_seg_cytoband_status_df,
    by = c(
      "biospecimen_id" = "Kids_First_Biospecimen_ID",
      "cytoband_no_ranges" = "cytoband"
    )
  ) %>%
  # Filter the annotated CN data to include only neutral cytobands and disagreements
  filter(
    dominant_cytoband_status %in% c("neutral", "uncallable", "unstable") |
      (status != dominant_cytoband_status &
         # bands that disagree with arm, but are not neutral (or uncallable)
         !(status %in% c("neutral", "uncallable", "unstable")
      ))
    ) %>%
  select(
    Kids_First_Biospecimen_ID = biospecimen_id,
    gene_symbol,
    loss_fraction,
    gain_fraction,
    callable_fraction,
    status
  )

# Display table
consensus_seg_gene_status
```

## Combine arm, cytoband, and gene-level status data

```{r}
# Rename each the dominant status columns of the data.frames
# to be uniform for the binding rows step and filter out "neutral" calls
consensus_seg_arm_status <- consensus_seg_arm_status %>%
  filter(!(dominant_arm_status == "neutral")) %>%
  rename(dominant_status = dominant_arm_status)
consensus_seg_cytoband_status <- consensus_seg_cytoband_status %>%
  filter(!(dominant_cytoband_status == "neutral")) %>%
  rename(dominant_status = dominant_cytoband_status)
# There are no "neutral" calls at the gene level so we do not need to filter
# out those calls here
consensus_seg_gene_status <- consensus_seg_gene_status %>%
  rename(dominant_status = status)

# For each of the datasets we're joining, we'll only keep these columns:
cols_to_keep <- c("Kids_First_Biospecimen_ID", "dominant_status")
```

Combine into one long data frame

```{r}
# Combine the arm, cytoband, and gene status count data
final_df <- bind_rows(
  arm = select(consensus_seg_arm_status,
               cols_to_keep,
               region = chromosome_arm),
  cytoband = select(consensus_seg_cytoband_status,
                    cols_to_keep,
                    region = cytoband),
  gene = select(consensus_seg_gene_status,
                cols_to_keep,
                region = gene_symbol),
  .id = "region_type"
) %>%
  # Reorder columns more sensibly
  select(Kids_First_Biospecimen_ID,
         status = dominant_status,
         region,
         region_type)

# Print out preview
final_df
```

## Write to a TSV file 

```{r}
# Write final long status table to file
write_tsv(
  final_df,
  file.path(results_dir, "consensus_seg_most_focal_cn_status.tsv.gz")
)

# Display final long status table
final_df %>%
  arrange(region_type)
```

## Session Info

```{r}
sessionInfo()
```
