---
title: "Find most focal recurrent copy number units"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Chante Bethell and Candace Savonen for ALSF CCDL
date: 2020
params:
  is_ci: FALSE
---

This notebook defines the most focal recurrent copy number units by removing focal changes that are within entire chromosome arm losses and gains.
_Most focal_ here meaning:

- If a chromosome arm is not clearly defined as a gain or loss (and is callable) we look to define the cytoband level status
- If a cytoband is not clearly defined as a gain or loss (and is callable) we then look to define the gene-level status

## Usage

This notebook is intended to be run from the command line with the following (assumes you are in the root directory of the repository):

```
Rscript -e "rmarkdown::render('analyses/focal-cn-file-preparation/05-define-most-focal-cn-units.Rmd', clean = TRUE, params=list(is_ci = ${IS_CI}))"
```

### Cutoffs: 

```{r}
# The fraction of calls a particular status needs to be
# above to be called the majority status -- the decision
# for a cutoff of 90% here was made to ensure that the status
# is not only the majority status but it is also significantly
# called more than the other status values in the region
status_threshold <- 0.9

# The fraction threshold for determining if enough of a region
# (arm, cytoband, or gene) is callable to determine its status --
# the decision for a cutoff of 50% here was made as it seems reasonable
# to expect a region to be more than 50% callable for a dominant status
# call to be made
uncallable_threshold <- 0.5
```

## Set up

### Libraries and functions

```{r}
library(tidyverse)
```

### Custom Function

```{r}
status_majority_caller <- function(status_df,
                                   region_variable,
                                   status_threshold_val,
                                   uncallable_threshold_val = uncallable_threshold) {
  # Given a data.frame with cytoband/gene-level copy number status data,
  # find the dominant status of the cytoband/gene region by calculating
  # the status fractions for each region.
  #
  # Args:
  #   status_df: data.frame with cytoband/gene-level copy number status data
  #   region_variable: the column name/region to calculate copy number
  #                    status percentages for
  #   status_threshold_val: What percent of calls a particular status needs to be
  #                      above to be called the majority.
  #   uncallable_threshold_val: a threshold for determining if enough of a region is
  #                         callable to determine its status.
  #
  # Return:
  #   status_count: data.frame with weighted mean fraction values for each
  #                 unique status in each unique region (arm/cytoband/gene)
  #                  and the dominant status for that region

  # Tidyeval for these columns
  region_sym <- rlang::sym(region_variable)
  
  
  status_df <- status_df %>%
    # Group by biospecimen ID and region
    group_by(Kids_First_Biospecimen_ID, !!region_sym) %>%
    # Summarize the weighted means for each status
    summarize(
      loss_fraction = weighted.mean(loss_fraction, band_length),
      gain_fraction = weighted.mean(gain_fraction, band_length),
      callable_fraction = weighted.mean(callable_fraction, band_length)
    ) %>%
    # Define dominant status based the weighted means meeting a status
    # threshold
    mutate(
      dominant_status = case_when(
        callable_fraction < (1 - uncallable_threshold_val) ~ "uncallable",
        loss_fraction > status_threshold_val ~ "loss",
        gain_fraction > status_threshold_val ~ "gain",
        loss_fraction + gain_fraction > status_threshold_val ~ "unstable",
        TRUE ~ "neutral"
      )
    )
  
  return(status_df)
}
```

The section below is commented out for development purposes.
The changes made to the above function means that the function below should also be adapted.
```{r}
# plot_dominant_status_calls <- function(status_count_df) {
#   # Given a data.frame with the fraction values for each region and the
#   # dominant status for that region, plot the dominant status call on the
#   # x-axis with the fraction values from each column that ends with `_fraction`
#   # on the y-axis.
#   #
#   # Args:
#   #   status_count_df: data.frame with fraction values for each unique status
#   #                    in a unique region (arm/cytoband/gene) and the
#   #                    dominant status for that region
#   # Return:
#   #   status_plot: plot representing the dominant status call on the x-axis and
#   #                the fraction values on the y-axis
#   status_count_df %>%
#     ungroup() %>%
#     # Remove the columns we don't want to plot
#     select(ends_with("_fraction"), dominant_status) %>%
#     # Gather the data.frame to have columns and values in the format of
#     # our status call, the fraction of total calls that status call is
#     # responsible for, and the dominant status call made based on the
#     # fraction value
#     gather(status, fraction, -dominant_status) %>%
#     # Plot our focal status values on the x-axis and the fraction values
#     # on the y-axis
#     ggplot(ggplot2::aes(
#       x = dominant_status,
#       y = fraction
#     )) +
#     theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#     geom_jitter(alpha = .2)
# }
```


### Files and directories

```{r}
results_dir <- "results"

# Define a logical object for running in CI
running_in_ci <- params$is_ci
```

### Read in files

Read in cytoband status file and format it for what we will need in this notebook. 

```{r}
# Read in the file with consensus CN status data and the UCSC cytoband data --
# generated in `03-add-cytoband-status-consensus.Rmd`
consensus_seg_cytoband_status_df <-
  read_tsv(file.path("results", "consensus_seg_with_ucsc_cytoband_status.tsv.gz")) %>%
  # Need this to not have `chr`
  mutate(
    chr = gsub("chr", "", chr),
    cytoband = paste0(chr, cytoband)
  ) %>%
  select(
    chromosome_arm,
    # Distinguish this dominant status that is based on cytobands, from the status
    dominant_cytoband_status = dominant_status,
    cytoband,
    Kids_First_Biospecimen_ID,
    band_length,
    gain_fraction,
    loss_fraction,
    callable_fraction
  )
```

Read in the gene-level data. 

```{r}
# Read in the annotated gene level CN file
consensus_seg_autosomes_df <-
  read_tsv(file.path(results_dir, "consensus_seg_annotated_cn_autosomes.tsv.gz"))
```

## Define most focal units

### Determine chromosome arm status

```{r}
# Use our custom function to make the arm status calls
arm_status_count <- status_majority_caller(
  consensus_seg_cytoband_status_df,
  "chromosome_arm",
  status_threshold
)

# Display table
arm_status_count %>%
  group_by(dominant_status)
```

These are the chromosome arms that have not been defined as gain or loss -- we want to define their cytoband/gene-level status

```{r}
# Let's get a vector of the neutral arms
neutral_arms <- arm_status_count %>%
  filter(dominant_status == "neutral") %>%
  dplyr::pull("chromosome_arm")
```

### Determine cytoband status

We want to include cytoband and gene-level calls for chromosome arms that have not been defined as a gain or loss to make the cytoband-level majority calls.

```{r}
# Now count the cytoband level calls (for each status call) and define
# the cytoband as that status if more than 90% of the total counts are
# for that particular status
cytoband_status_count <- consensus_seg_cytoband_status_df %>%
  # Filter the annotated CN data to include only neutral chromosome arms
  filter(chromosome_arm %in% neutral_arms) %>%
  select(
    Kids_First_Biospecimen_ID,
    cytoband,
    loss_fraction,
    gain_fraction,
    callable_fraction,
    dominant_status = dominant_cytoband_status
  ) %>%
  mutate(
    dominant_status = case_when(
      callable_fraction < (1 - uncallable_threshold) ~ "uncallable",
      loss_fraction > status_threshold ~ "loss",
      gain_fraction > status_threshold ~ "gain",
      loss_fraction + gain_fraction > status_threshold ~ "unstable",
      TRUE ~ "neutral"
    )
  )

# Display table
cytoband_status_count %>%
  group_by(dominant_status)
```

### Determine gene-level status

```{r}
# These are the cytobands that have not been defined as gain or loss --
# we want to define their gene-level status
neutral_cytobands <- cytoband_status_count %>%
  filter(dominant_status %in% c("unstable", "neutral")) %>%
  dplyr::pull("cytoband")

# Filter the annotated CN data to include only these cytobands
neutral_status_cytoband_df <- consensus_seg_cytoband_status_df %>%
  filter(cytoband %in% neutral_cytobands)

# Join gene-level data
combined_neutral_status_cytoband_df <- neutral_status_cytoband_df %>%
  left_join(
    consensus_seg_autosomes_df,
    by = c("Kids_First_Biospecimen_ID" = "biospecimen_id", "cytoband")
  )
```

```{r}
if (!(running_in_ci)) {
  # Now count the gene-level calls (for each status call) and define
  # the gene as that status if more than 50% of the total counts are
  # for that particular status
  gene_status_count <- status_majority_caller(
    combined_neutral_status_cytoband_df,
    "gene_symbol",
    status_threshold
  )

  # Display table
  gene_status_count
}
```

## Plot calls

Plot the final dominant status call on the x-axis and the fraction of each status on the y-axis.

### Plot chromosome arm status calls

```{r}
# Run `plot_dominant_status_calls` function for the chromosome arm calls
# plot_dominant_status_calls(
#   arm_status_count
# )
```

### Plot cytoband status calls

```{r}
# Run `plot_dominant_status_calls` function for the cytoband calls
# plot_dominant_status_calls(
#   cytoband_status_count
# )
```

### Plot gene status calls

```{r}
# if (!(running_in_ci)) {
#   # Run `plot_dominant_status_calls` function for the gene-level calls
#   plot_dominant_status_calls(gene_status_count)
# }
```

## Combine arm, cytoband, and gene-level status data

```{r}
# For each of the datasets we're joining, we'll only keep these columns:
cols_to_keep <- c("Kids_First_Biospecimen_ID", "dominant_status")
```

Combine into one long data frame

```{r}
if (!(running_in_ci)) {
  # Combine the arm, cytoband, and gene status count data
  final_df <- bind_rows(
    arm = select(arm_status_count,
      cols_to_keep,
      region = chromosome_arm
    ),
    cytoband = select(cytoband_status_count,
      cols_to_keep,
      region = cytoband
    ),
    gene = select(gene_status_count,
      cols_to_keep,
      region = gene_symbol
    ),
    .id = "region_type"
  ) %>%
    # Reorder columns more sensibly
    select(
      Kids_First_Biospecimen_ID,
      status = dominant_status,
      region,
      region_type
    )
} else {
  # Combine the arm and cytoband status count data
  final_df <- bind_rows(
    arm = select(arm_status_count,
      cols_to_keep,
      region = chromosome_arm
    ),
    cytoband = select(cytoband_status_count,
      cols_to_keep,
      region = cytoband
    ),
    .id = "region_type"
  ) %>%
    # Reorder columns more sensibly
    select(
      Kids_First_Biospecimen_ID,
      status = dominant_status,
      region,
      region_type
    )
}

# Print out preview
final_df
```

## Write to a TSV file 

```{r}
# Write final long status table to file
write_tsv(
  final_df,
  file.path(results_dir, "consensus_seg_most_focal_cn_status.tsv.gz")
)

# Display final long status table
final_df %>%
  arrange(region_type)
```

## Session Info

```{r}
sessionInfo()
```
