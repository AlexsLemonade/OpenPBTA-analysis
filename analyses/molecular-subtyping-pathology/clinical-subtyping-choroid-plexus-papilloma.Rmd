---
title: "Recode harmonized diagnosis using WHO 2016 CNS subtypes"
output: 
  html_notebook:
    toc: true
    toc_float: true
author: K Gaonkar D3b 
date: 2021
---

We will be updating harmonized diagnosis as per [WHO 2016 CNS subtypes](https://link.springer.com/content/pdf/10.1007/s00401-016-1545-1.pdf). 
based of information gathered from the pathology report as discussed 
 -for choroid plexus papilloma: [#997](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/9967).

## Set Up

### Libraries

```{r}
library(tidyverse)
```

### Input

```{r}
data_dir <- file.path("..", "..", "data")
histologies_file <- file.path(data_dir, "pbta-histologies.tsv")

```

### Output

```{r}
results_dir <- "results"
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
choroid_plexus_papilloma_file <- file.path(results_dir, "choroid_plexus_papilloma_tumor_subtypes.tsv")
```

## Read in data

```{r}
histologies_df <- readr::read_tsv(histologies_file, guess_max = 10000)
```

## Recode `harmonized_diagnosis`, `broad_histology`, and `short_histology`

```{r}
recode_list <- jsonlite::fromJSON(
  file.path("input", 
            "recode.json")
)

get_subtype <- function(histologies_df,recode_list){
  subtype_df <- histologies_df %>%
    # Subset to relevant ID and disease labels column
    select(Kids_First_Biospecimen_ID,
           Kids_First_Participant_ID,
           sample_id,
           pathology_diagnosis,
           pathology_free_text_diagnosis,
           broad_histology,
           short_histology,
           harmonized_diagnosis) %>%
    # For convenience, let's add a column where pathology_free_text_diagnosis
    # is all lower case out of an abundance of caution
    mutate(pathology_free_text_dx_lower = str_to_lower(pathology_free_text_diagnosis))%>%
    filter(
      # gather Choroid plexus papilloma samples
      pathology_diagnosis == recode_list$pathology_diagnosis,
      # Filter to samples with "term" in pathology free text
      str_detect(pathology_free_text_dx_lower,
                   recode_list$path_free_text_dx_search)) %>%
    mutate(
      # recode harmonized diagnosis
      harmonized_diagnosis = recode_list$harmonized_diagnosis,
      #recode broad histology
      broad_histology = recode_list$broad_histology,
      #recode short histology
      short_histology = recode_list$short_histology
    ) %>%
    # Drop column we added for convenience
    select(-pathology_free_text_dx_lower) 
  
return(subtype_df)
}
```

### Atypical choroid plexus papilloma
If `pathology_diagnosis == Choroid plexus papilloma` and `pathology_free_text_diagnosis` contains "atypical", then annotate as below:

pathology_diagnosis | subtyping module | pathology_free_text_diagnosis | broad_histology | short_histology | harmonized_diagnosis
-- | -- | -- | -- | -- | --
Choroid plexus papilloma | NA | if contains "atypical" | Choroid plexus tumor | Choroid plexus tumor | Atypical choroid plexus papilloma


```{r}
atypical_df <- get_subtype(histologies_df, recode_list$`Atypical choroid plexus papilloma`)
```

### Write to file

```{r}
write_tsv(atypical_df, choroid_plexus_papilloma_file)
```

## Session Info

```{r}
sessionInfo()
```

