---
title: "Distribution of samples across cancer types"
output:
  html_notebook: 
    toc: true
    toc_float: true
---


Chante Bethell - CCDL 

This notebook addresses [issue #5](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/5) in the OpenPBTA-analysis. 
The distribution of samples by cancer type is determined and visually represented below. 

## Load in libraries and functions. Read in dataset files.  

```{r echo=TRUE, message=FALSE, warning=FALSE}

# Load/install packages. This will be removed once a Dockerfile is established.
source("00-install-packages.R")

# magrittr pipe
`%>%` <- dplyr::`%>%`

# Function to filter dataset based on primary_site of disease, while arranging
# the cancer types in order of descending expression.
location_fn <- function(location) {
  brain_location %>%
    dplyr::arrange(desc(n)) %>%
    dplyr::filter(stringr::str_detect(primary_site, location))
}

# Function to pad x with NA's
na_pad <- function(x, len) {
  x[1:len]
}

# Function to make a padded data.frame
make_padded_data_frame <- function(l, ...) {
  maxlen <- max(sapply(l, length))
  data.frame(lapply(l, na_pad, len = maxlen), ...)
}

# Create directories to hold the output.
if (!dir.exists("results")) {
  dir.create("results")
}
if (!dir.exists("plots")) {
  dir.create("plots")
}

# Read in dataset
df2 <- data.frame(readr::read_tsv(
  file.path("..", "..", "data",
            "2019-07-26-pbta-histologies - 2019-07-26-including-germline.tsv"
  )
))
```

## Filter the dataset.

```{r}
# Remove na's
df2 <- df2 %>%
  dplyr::filter(!is.na(disease_type_new))

# data.frame with the count of each unique cancer type expression
disease_expression <- df2 %>%
  dplyr::group_by(disease_type_new) %>%
  dplyr::filter(!is.na(disease_type_new)) %>%
  dplyr::count() %>%
  dplyr::arrange(desc(n)) %>%
  dplyr::rename(count = n)

# Calculate the total count of the dataset
sum_count <- sum(disease_expression$count)

# Create a percent variable
disease_expression <- disease_expression %>%
  dplyr::mutate(percent = (count / sum_count))

# Format the percent values to include %
disease_expression$percent <-
  formattable::percent(disease_expression$percent)

# Reorder the columns to be displayed in descending order by count on the plot
disease_expression$disease_type_new <- with(disease_expression,
                                            reorder(disease_type_new,-count))

```


**Create a table of `disease.type` with each corresponding sample count and percentage.**

```{r}
disease_expression_table <-
  knitr::kable(disease_expression, booktabs = TRUE) %>%
  kableExtra::kable_styling(
    bootstrap_options = "condensed",
    full_width = FALSE,
    font_size = 8
  )
disease_expression_table  
```


A table displaying the cancer types across the unique primary sites is produced by the `pbta-analysis-5.R` script.   
This table can be found at `file.path("..", "results", "primary_sites_table.pdf")`.



## Plot sample distribution across cancer types

```{r, fig.width = 18, fig.height = 14}
# Create a bar plot of sample distribution across cancer types
gg_types <- disease_expression %>%
  ggplot2::ggplot(aes(x = disease_type_new, y = count, fill = count)) +
  ggplot2::geom_col() +
  ggplot2::theme_bw() +
  ggplot2::labs(x = "Cancer Types", y = "Count",
                title = "Sample Distribution Across Cancer Types") +
  ggplot2::scale_y_continuous(breaks = seq(0, 500, by = 100)) +
  ggplot2::theme(axis.text.x = element_text(
    angle = 75,
    hjust = 1,
    size = 8
  ),
  panel.grid = element_blank()) +
  ggplot2::geom_text(nudge_y = 6.5, size = 2,
                     aes(label = paste0(disease_expression$percent)))

gg_types 
```

## Treemap 

**Create a treemap to represent the broad histology, short histology, and cancer types, respectively.**
*Cancer types will be replaced by molecular subtypes after the completion of the relevant analysis.*

```{r, fig.width = 20, fig.height = 18}
# Create a colorblind-friendly color vector
color <- colorblindr::palette_OkabeIto

sun_df <- df2 %>%
  dplyr::select(broad_histology, short_histology, disease_type_new) %>%
  dplyr::filter(!is.na(disease_type_new)) %>%
  dplyr::filter(!is.na(broad_histology)) %>%
  dplyr::filter(!is.na(short_histology)) %>%
  dplyr::group_by(broad_histology)

sun_df_sub <-
  sun_df[, c("broad_histology", "short_histology", "disease_type_new")]
sun_df_sub$nodes <-
  paste0(sun_df_sub[[1]], ",", sun_df_sub[[2]], ",", sun_df_sub[[3]])

# Make node patterns
names(sun_df_sub) <- c("level1", "level2", "level3", "nodes")

# Sum each unique combination
counts <- sun_df_sub %>%
  dplyr::group_by(nodes) %>%
  dplyr::summarise(size = n())

counts <- counts[!grepl("^NA-", counts$nodes),]

# Create final data.frame prepped for treemap and sunburst functions?
final <- merge(sun_df_sub, counts, all.x = T)
col_order <- c("level1", "level2", "level3", "size", "nodes")
final <- final[, col_order]
final$nodes <- NULL

tm <-
  treemap::treemap(
    final,
    index = c("level1", "level2", "level3"),
    vSize = "size",
    vColor = color,
    draw = TRUE
  )
```
**Would this plot be a good addition to the first figure?**  
The interactive treemap can be found [here](https://cbethell.github.io/histology-pie-data/histology-treemap.html).

## Sunburst plot

**Let's take look at the sund2b sunburst plot.**
The color scheme used is colorblind-friendly, but limited.   
I produced the same plot but with a different color scheme (which is also colorblind-friendly).  
This plot can be accessed by running the shiny application located at `file.path("..", "scripts", "histology-app.R")`.

```{r}
tmnest <-
  d3r::d3_nest(tm$tm[, c("level1", "level2", "level3", "vSize")],
               value_cols = c("vSize"))
sun_plot <-
  sunburstR::sunburst(
    data = tmnest,
    valueField = "vSize",
    count = TRUE,
    sumNodes = FALSE,
    colors = color
  )
p <- sunburstR::sund2b(tmnest, colors = color, valueField = "vSize")
p
```

**Does this plot seem to represent the data accurately?**

## Session Info 

```{r}
sessionInfo()
```

