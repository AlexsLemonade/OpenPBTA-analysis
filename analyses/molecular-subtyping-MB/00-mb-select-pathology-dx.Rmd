---
title: "Select pathology diagnoses for inclusion"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Candace Savonen for ALSF CCDL
date: 2020
---

## Background

In an upcoming release, `integrated_diagnosis`, which can be updated as the result of subtyping, will be used to populate the `short_histology` column (see [#748](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/748)).
Thus, molecular subtyping modules need to be upstream of `short_histology` and use the `pathology_diagnosis` and `pathology_free_text_diagnosis` fields.

This change for this module is tracked in [#756](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/756).
 
_As of v17 release, this is pretty straightforward for Medulloblastoma samples:_  

- `short_histology`, `integrated_diagnosis` and `pathology_diagnosis` are fairly in agreement as far as which samples are `Medulloblastoma`  
- Most but not all of these samples have `medulloblastoma` some place in `pathology_free_text_diagnosis`, but a couple have `PNET`.   
- There are no samples currently classified as `short_histology == "Other"` that have `medulloblastoma` as a part of `pathology_free_text_diagnosis`.


<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Background](#background)
- [Set up](#set-up)
- [Read in data](#read-in-data)
- [Explore the pathology diagnoses](#explore-the-pathology-diagnoses)
- [Pathology diagnosis strings for inclusion](#pathology-diagnosis-strings-for-inclusion)
- [Any `Other` samples that should be included based on `pathology_free_text_diagnosis`](#any-other-samples-that-should-be-included-based-on-pathology_free_text_diagnosis)
- [Subset to Medulloblastoma based on `pathology_diagnosis`](#subset-to-medulloblastoma-based-on-pathology_diagnosis)
- [Session Info](#session-info)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->


## Set up

```{r}
library(tidyverse)
```

```{r}
data_dir <- file.path("..", "..", "data")
histologies_file <- file.path(data_dir, "pbta-histologies.tsv")
```

We're going to save the pathology diagnosis information we'll use to generate the subset files in a directory `input`.

```{r}
output_dir <- "input"
output_file <- file.path(output_dir, 
                         "subset-mb-clinical.tsv")
```

## Read in data

```{r}
histologies_df <- read_tsv(histologies_file)
```

## Explore the pathology diagnoses

How do `short_histology`, `integrated_diagnosis`, and `pathology_diagnosis` line up for `Medulloblastoma` biospecimens? 

```{r}
histologies_df %>% 
  filter(short_histology == "Medulloblastoma" | integrated_diagnosis == "Medulloblastoma" | pathology_diagnosis == "Medulloblastoma") %>%
  group_by(short_histology, integrated_diagnosis, pathology_diagnosis, experimental_strategy) %>%
  tally()
```

Looks like there are two samples that will be added in by using `pathology_diagnosis`. 

Let's take a look at the free text field.

```{r}
histologies_df %>% 
  filter(short_histology == "Medulloblastoma") %>%
  group_by(pathology_free_text_diagnosis) %>%
  tally() %>%
  arrange(desc(n))
```

This is not as uniform, but that's to be expected. 
There are a couple `pnet` samples in here according to this field, but we will rely on the other field's labels instead. 

## Pathology diagnosis strings for inclusion

Ignoring the `pnet` samples, in general we can include any samples that have `medulloblastoma` in the `pathology_free_text_diagnosis` field. 
We can add more terms to this later if needed. 

```{r}
free_text_dx_terms <- c(
  "medulloblastoma"
)

# Collapse with | so we can use with grep
free_text_dx_terms <- paste0(free_text_dx_terms, collapse = "|")
```

## Any `Other` samples that should be included based on `pathology_free_text_diagnosis`

```{r}
other_mb_biospecimens <- histologies_df %>% 
  filter(short_histology == "Other", 
         grepl(free_text_dx_terms, pathology_free_text_diagnosis)) %>% 
  pull(Kids_First_Biospecimen_ID)

other_mb_biospecimens
```

There's no samples in `Other` that need to be added at this time, but if they do later, we can add them to the filter statements in the next section. 

## Subset to Medulloblastoma based on `pathology_diagnosis`

We will subset these biospecimens based on the `pathology_diagnosis`. 

```{r}
filtered_on_dx_df <- histologies_df %>%
  filter(pathology_diagnosis == "Medulloblastoma") %>% # Can add `Kids_First_Biospecimen_ID %in% other_mb_biospecimens` statement here if "Other" samples show up. 
  readr::write_tsv(output_file)
```

## Session Info

```{r}
sessionInfo()
```
