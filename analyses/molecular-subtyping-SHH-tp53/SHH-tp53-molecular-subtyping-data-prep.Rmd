---
title: "SHH TP53 Molecular Subtyping"
output: 
  html_notebook:
    toc: TRUE
    toc_float: TRUE
author: Candace Savonen for ALSF CCDL
date: 2019
---

This notebook [molecularly subtypes Medulloblastoma samples into their TP53 status](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/247). 

# Usage

This notebook is intended to be run via the command line from the top directory
of the repository as follows:

`Rscript -e "rmarkdown::render('analyses/molecular-subtyping-SHH-tp53/SHH-tp53-molecular-subtyping-data-prep.Rmd', clean = TRUE)"`

# Set Up

```{r}
# Get `magrittr` pipe
`%>%` <- dplyr::`%>%`
```

## Directories and Files

```{r}
# File path to data directory
data_dir <- file.path("..", "..", "data")

# File path to results directory
results_dir <- "results"

if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}
```

## Read in the data

Read in metadata and isolate to medulloblastoma samples.

```{r}
metadata <-
  readr::read_tsv(file.path(data_dir, "pbta-histologies.tsv")) %>% 
  dplyr::filter(disease_type_new == "Medulloblastoma") 

# Check summary of subtypes here
summary(as.factor(metadata$molecular_subtype))
```

Propagate the `molecular_subtype` labels to biospecimens of the same `sample_id`.
First make a key of molecular subtype to `sample_id`.

```{r}
key_df <- metadata %>% 
  dplyr::filter(!is.na(molecular_subtype)) %>% 
  dplyr::select(molecular_subtype, sample_id)

# Make into list form so it can be used in dplyr::recode
key <- key_df$molecular_subtype
names(key) <- key_df$sample_id
```

Recode and filter to all `sample_id`s that are `SHH`.

```{r}
metadata <- metadata %>% 
  dplyr::mutate(molecular_subtype = dplyr::recode(sample_id, !!!key, .default = "NA")) %>%
  dplyr::filter(molecular_subtype == "SHH")

# Check summary after recoding
summary(as.factor(metadata$molecular_subtype))
```

Read in the SNV consensus calls. 

```{r}
snv_df <-
  # Read in the consensus file
  data.table::fread(file.path(data_dir, "pbta-snv-consensus-mutation.maf.tsv.gz"), 
                    data.table = FALSE) %>% 
  # Filter to only Medulloblastoma samples
  dplyr::filter(Tumor_Sample_Barcode %in% metadata$Kids_First_Biospecimen_ID)
```

## Identify TP53 SNVs.

```{r}
tp53_mut <- snv_df %>%
  # Filter to only SNV's in TP53 gene
  dplyr::filter(Hugo_Symbol == "TP53") %>%
  dplyr::group_by(Tumor_Sample_Barcode) %>% 
  dplyr::summarize(num_TP53_mutation = dplyr::n())
```

Add other sample identifiers to this information.

```{r}
tp53_mut <- tp53_mut %>% 
  dplyr::right_join(dplyr::select(metadata, "Kids_First_Participant_ID", "sample_id", "Kids_First_Biospecimen_ID"),
                    by = c("Tumor_Sample_Barcode" = "Kids_First_Biospecimen_ID")) %>% 
  # Rearrange columns for more easily readable table
  dplyr::select(Kids_First_Participant_ID, sample_id, Tumor_Sample_Barcode,	num_TP53_mutation) %>% 
  dplyr::mutate(TP53_mutation = dplyr::case_when(
    is.na(num_TP53_mutation) ~ "No", 
    num_TP53_mutation > 0 ~ "Yes")) %>% 
  dplyr::select(-num_TP53_mutation)

# Print out this table
tp53_mut 
```

# Session Info

```{r}
sessionInfo()
```
