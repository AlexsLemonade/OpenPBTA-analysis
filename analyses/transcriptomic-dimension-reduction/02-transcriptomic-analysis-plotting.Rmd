---
title: "Unsupervised Analysis of Transcriptomic Differences - Plotting"
author: Chante Bethell for CCDL 2019
output:
  html_notebook:
    toc: true
    toc_float: true
---

This notebook is the second part of an analysis that demonstrate samples in the 
PBTA cluster by cancer type using dimensionality reduction techniques,
[Principal Component Analysis](https://www.rdocumentation.org/packages/stats/versions/3.6.0/topics/prcomp) (PCA), 
[t-Distributed Stochastic Neighbor Embedding](https://cran.r-project.org/web/packages/Rtsne/Rtsne.pdf) (t-SNE), 
and [Uniform Manifold Approximation and Projection](https://cran.r-project.org/web/packages/umap/vignettes/umap.html) (UMAP).

This notebook focuses on plotting the dimension reduction score data. 

It addresses [issue #9](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/9)
in the Open-PBTA analysis repository. 

## Summary of Findings:

Upon plotting the dimension reduction scores produced by each of the three 
unique techniques mentioned above, it was noticed that there may be batch 
effects present.

- The `experimental_strategy` variable within the metadata may be useful in 
  correcting said batch effects. 
- The value in the `experimental_strategy` column for all of the 
  `Kids_First_Biospecimen_ID`'s in the expression data is equal to `RNA-Seq`. 
  Matching the `Kids_First_Biospecimen_ID` with `Kids_First_Participant_ID`
  gives the true method of sequencing. 

## Output Files:
- `analyses/transcriptomic-dimension-reduction/plots/meta_grid_kallisto_type.pdf`
- `analyses/transcriptomic-dimension-reduction/plots/meta_grid_rsem_type.pdf`

# Usage

This script is intended to be run via the command line from the top directory of the repository as follows: 
```
Rscript -e "rmarkdown::render('analyses/transcriptomic-dimension-reduction/02-transcriptomic-analysis-plotting.Rmd', clean = TRUE)"
```

# Set Up

Assign functions. 
```{r}
# magrittr pipe
`%>%` <- dplyr::`%>%`

plot_dimension_reduction <-
  function(aligned_scores_df, point_color) {
    # Given a data.frame that contains the scores of a dimension reduction
    # analysis and the information we want from the metadata, make a scatterplot.
    #
    # Args:
    #   dimension_reduction_df: data.frame containing dimension reduction scores, and
    #              relative information from the metadata
    #   point_color: the variable whose information will be used to color
    #                the points on the plot
    #
    # Returns:
    #   dimension_reduction_plot: the plot representing the dimension reduction
    #                             scores in the given data.frame, using the values
    #                             in `point_color` as symbols to color the points

    # transform the strings in `point_color` into symbols for plotting
    color_sym <- rlang::sym(point_color)

    dimension_reduction_plot <- ggplot2::ggplot(
      aligned_scores_df,
      ggplot2::aes(
        x = aligned_scores_df[, 1],
        y = aligned_scores_df[, 2],
        color = !!color_sym
      )
    ) +
      ggplot2::geom_point(size = 0.5)

    return(dimension_reduction_plot)
    
  }
```

Assign name of the output directories.
```{r}
# Assign names of output directories
results_dir <- "results"
plots_dir <- "plots"

# Create directory to hold the output.
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

Read in the tsv files containing the dimension reduction scores aligned with 
the metadata, which were produced in `01-transcriptomic-analysis-prep.R`.
```{r}
rsem_pca_aligned_df <-
  data.frame(readr::read_tsv(file.path(
    results_dir, "rsem_pca_scores_aligned.tsv"
  )))
rsem_tsne_aligned_df <-
  data.frame(readr::read_tsv(file.path(
    results_dir, "rsem_tsne_scores_aligned.tsv"
  )))
rsem_umap_aligned_df <-
  data.frame(readr::read_tsv(file.path(
    results_dir, "rsem_umap_scores_aligned.tsv"
  )))

kallisto_pca_aligned_df <-
  data.frame(readr::read_tsv(file.path(
    results_dir, "kallisto_pca_scores_aligned.tsv"
  )))
kallisto_tsne_aligned_df <-
  data.frame(readr::read_tsv(file.path(
    results_dir, "kallisto_tsne_scores_aligned.tsv"
  )))
kallisto_umap_aligned_df <-
  data.frame(readr::read_tsv(file.path(
    results_dir, "kallisto_umap_scores_aligned.tsv"
  )))
```


# Plot 

## RSEM Plots Grid
The grid of plots below shows the dimension reductions scores for the RSEM 
expression data, colored by tumor type.  
These plots seem to suggest the presence of batch effects, which is likely due 
to the need for normalization across the two batches of RNA-Seq preparation 
(poly-A selection versus ribosomal depletion).
This can be further determined using the `experimental_strategy` column of the
metadata to attempt to correct batch effects. 

```{r, fig.width = 10, fig.height = 20}
# Run the `plot_dimension_reduction` function to plot each set of dimension
# reduction scores
rsem_pca_plot <-
  plot_dimension_reduction(rsem_pca_aligned_df, "disease_type_new")
rsem_tsne_plot <-
  plot_dimension_reduction(rsem_tsne_aligned_df, "disease_type_new")
rsem_umap_plot <-
  plot_dimension_reduction(rsem_umap_aligned_df, "disease_type_new")

# Extract the legend from one of the plots
legend_a <- cowplot::get_legend(
  rsem_umap_plot +
    ggplot2::theme(
      legend.direction = "vertical",
      legend.position = c(0.05, 0.40),
      legend.key.width = ggplot2::unit(0.1, "cm"),
      text = ggplot2::element_text(size = 9)
    )
)
# Plot grid with RSEM data colored by cancer type
rsem_grid <- cowplot::plot_grid(
  rsem_pca_plot + ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "PC1", y = "PC2") +
    ggplot2::ggtitle("Cancer Types (RSEM)"),
  rsem_tsne_plot + ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "t-SNE1", y = "t-SNE2"),
  rsem_umap_plot + ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "UMAP1", y = "UMAP2"),
  labels = "AUTO",
  align = "vh",
  axis = "b",
  ncol = 1,
  nrow = 7
)

# Add the legend to the cowplot
rsem_grid <-
  cowplot::plot_grid(rsem_grid, legend_a, rel_heights = c(2, .2))

# Save plot grid
ggplot2::ggsave(
  file.path("plots", "meta_grid_rsem_type.pdf"),
  rsem_grid,
  width = 12,
  height = 18
)

# Display the plot grid
rsem_grid
```
## Kallisto Plots Grid
The grid of plots below shows the dimension reductions scores for the Kallisto 
expression data, colored by tumor type.  
These plots seem to suggest the presence of batch effects, which is likely due 
to the need for normalization across the two batches of RNA-Seq preparation 
(poly-A selection versus ribosomal depletion).
This can be further determined using the `experimental_strategy` column of the
metadata to attempt to correct batch effects. 

```{r, fig.width = 10, fig.height = 20}
# Run the `plot_dimension_reduction` function to plot each set of dimension
# reduction scores
kallisto_pca_plot <-
  plot_dimension_reduction(kallisto_pca_aligned_df, "disease_type_new")
kallisto_tsne_plot <-
  plot_dimension_reduction(kallisto_tsne_aligned_df, "disease_type_new")
kallisto_umap_plot <-
  plot_dimension_reduction(kallisto_umap_aligned_df, "disease_type_new")

# Extract the legend from one of the plots
legend_b <- cowplot::get_legend(
  kallisto_umap_plot +
    ggplot2::theme(
      legend.direction = "vertical",
      legend.position = c(0.05, 0.40),
      legend.key.width = ggplot2::unit(0.1, "cm"),
      text = ggplot2::element_text(size = 9)
    )
)
# Plot grid with Kallisto data colored by cancer type
kallisto_grid <- cowplot::plot_grid(
  kallisto_pca_plot + ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "PC1", y = "PC2") +
    ggplot2::ggtitle("Cancer Types (Kallisto)"),
  kallisto_tsne_plot + ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "t-SNE1", y = "t-SNE2"),
  kallisto_umap_plot + ggplot2::theme(legend.position = "none") +
    ggplot2::labs(x = "UMAP1", y = "UMAP2"),
  labels = "AUTO",
  align = "vh",
  axis = "b",
  ncol = 1,
  nrow = 7
)

# Add the legend to the cowplot
kallisto_grid <-
  cowplot::plot_grid(kallisto_grid, legend_b, rel_heights = c(2, .2))

# Save plot grid
ggplot2::ggsave(
  file.path("plots", "meta_grid_kallisto_type.pdf"),
  kallisto_grid,
  width = 12,
  height = 18
)

# Display the plot grid
kallisto_grid
```

# Session Info
```{r}
sessionInfo()
```

