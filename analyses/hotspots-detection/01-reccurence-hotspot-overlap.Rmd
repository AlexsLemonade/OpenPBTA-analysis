---
title: "Recurrent gene hotspots"
output: html_notebook
params:
  db_file:
    label: "all callers db"
    value: scratch/snv_db.sqlite
    input: file
  cancer_hotspot_file:
    label: "MSKCC cancer hotspot file"
    value: input/hotspots_v2.xls
    input: file  
  gene_list :
    label: gene table with gene type annotation 
    value: ../fusion_filtering/references/genelistreference.txt 
    input: file  
---

In this notebook we will use look at recurrence and hotspots in OpenPBTA snv

Recurrence:

- Filter Variant_Classification ='Missense_Mutation|Splice_Region|In_Frame_Del|Frame_Shift_Del|Splice_Site|Splice_Region|Nonsense_Mutation|Nonstop_Mutation|In_Frame_Ins|Frameshift_Ins',
- Filter IMPACT ='HIGH|MODERATE'
- Filter given gene list from fusion_filtering/reference/genelistreference.txt 
- Count reoccurence per Hugo_Symbol+Protein_position+DOMAINS+type

Hotspots:
-Protein_position overlaps MSKCC cancer hotspot database



## Setup
```{r}
library("tidyverse")

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
data_dir <- file.path(root_dir, "data")
mskcc_cancer_hotspot_file <- params$cancer_hotspot_file
internal_hotspot_file <- params$internal_hotspot_file

results_dir <- file.path(root_dir,
                         "analyses",
                         "hotspots-detection",
                         "results")

if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

```

## Cancer hotspot files
```{r}

# Cancer database
hotspot_database_2017_snv <- readxl::read_xls(mskcc_cancer_hotspot_file,sheet = 1) 
hotspot_database_2017_indel <- readxl::read_xls(mskcc_cancer_hotspot_file,sheet = 2)

hotspot_database <- bind_rows( hotspot_database_2017_snv, hotspot_database_2017_indel) %>%
  dplyr::select("Amino_Acid_Position","Hugo_Symbol") %>%
  dplyr::mutate(hotspot_database="MSKCC") %>%
  unique()

```

## Gene table for reccurence checks
```{r}
gene_table <- read_tsv("../fusion_filtering/references/genelistreference.txt")%>%
  dplyr::rename(Hugo_Symbol=Gene_Symbol) %>%
  dplyr::select(Hugo_Symbol,type)

```

## Read database 
```{r}

db_file <- file.path(root_dir, params$db_file)

# Start up connection
con <- DBI::dbConnect(RSQLite::SQLite(), db_file,path = ":memory:")

```

## Designate caller tables from SQL file
```{r}
strelka <- dplyr::tbl(con, "strelka")
mutect <- dplyr::tbl(con, "mutect")
vardict <- dplyr::tbl(con, "vardict")
lancet <- dplyr::tbl(con, "lancet") 	

```

## Subset maf per caller
```{r}
source ("utils/prepMaf.R")
strelka_subset<-prepMaf(strelka, gene_table = gene_table) %>%
       mutate(caller="strelka")	
mutect_subset<-prepMaf(mutect, gene_table = gene_table) %>%
	mutate(caller="mutect")
vardict_subset<-prepMaf(vardict, gene_table = gene_table) %>%
	mutate(caller="vardict")
lancet_subset<-prepMaf(lancet, gene_table = gene_table) %>%
	mutate(caller="lancet")

# combine
combined_maf_subsets <-bind_rows(strelka_subset,
mutect_subset,
vardict_subset,
lancet_subset)

# save for future runs
saveRDS(combined_maf_subsets, "results/combined_maf_subsets.RDS")

	      
```

## Recurrence in filtered snv calls
```{r}

calls_recurrence <- combined_maf_subsets %>%
    left_join(gene_table,by="Hugo_Symbol") %>%
  group_by(Chromosome,Start_Position,End_Position,
           Amino_Acid_Position,Hugo_Symbol,
           Tumor_Sample_Barcode) %>%
  summarise(type=toString(type)) %>%
    count(Chromosome,Start_Position,End_Position,Amino_Acid_Position,Hugo_Symbol,type,sort = TRUE) %>%
  dplyr::filter( grepl("Oncogene|TumorSuppressorGene",type)) %>%
  dplyr::filter(n>2)


```


## Merge hotspot annotation to recurrence table and save fot strelka
```{r}
calls_recurrence <- calls_recurrence %>%
	left_join(hotspot_database,by=c("Amino_Acid_Position","Hugo_Symbol"))%>%
	write_tsv(file.path(results_dir,"snv_recurrence.tsv"))
		  
```


```{r}
DBI::dbDisconnect(con)
```

