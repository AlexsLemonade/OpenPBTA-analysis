---
title: "Recurrent gene hotspots"
output: html_notebook
params:
  db_file:
    label: "all callers db"
    value: scratch/snv_db.sqlite
    input: file
  cancer_hotspot_file:
    label: "MSKCC cancer hotspot file"
    value: input/hotspots_v2.xls
    input: file  
  gene_list :
    label: gene table with gene type annotation 
    value: ../fusion_filtering/references/genelistreference.txt 
    input: file  
---

In this notebook we will use look at recurrence and hotspots in OpenPBTA snv

Recurrence:

- Filter Variant_Classification ='Missense_Mutation|Splice_Region|In_Frame_Del|Frame_Shift_Del|Splice_Site|Splice_Region|Nonsense_Mutation|Nonstop_Mutation|In_Frame_Ins|Frameshift_Ins',
- Filter IMPACT ='HIGH|MODERATE'
- Filter given gene list from fusion_filtering/reference/genelistreference.txt 
- Count reoccurence per Hugo_Symbol+Protein_position+DOMAINS+type

Hotspots:
Protein_position overlaps MSKCC cancer hotspot database



## Setup
```{r}
library("tidyverse")

root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
data_dir <- file.path(root_dir, "data")
mskcc_cancer_hotspot_file <- params$cancer_hotspot_file
internal_hotspot_file <- params$internal_hotspot_file

results_dir <- file.path(root_dir,
                         "analyses",
                         "hotspot-detection",
                         "results")

if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

```

## Cancer hotspot files
```{r}

# Cancer database
hotspot_database_2017_snv <- readxl::read_xls(mskcc_cancer_hotspot_file,sheet = 1) 
hotspot_database_2017_indel <- readxl::read_xls(mskcc_cancer_hotspot_file,sheet = 2) 
```

## Gene table for reccurence checks
```{r}
gene_table <- read_tsv("../fusion_filtering/references/genelistreference.txt")%>%
  rename(Hugo_Symbol=Gene_Symbol) %>%
  select(Hugo_Symbol,type) %>%
  filter(grepl("Oncogene|TumorSuppressorGene",type))

```

## Read database 
```{r}

db_file <- file.path(root_dir, params$db_file)

# Start up connection
con <- DBI::dbConnect(RSQLite::SQLite(), db_file,path = ":memory:")

```


## Recurrence per caller
```{r}
source ("utils/recurrent-count.R")
combined_recurrence<-getRecurrentStatus(con, gene_table = gene_table) 

```

## Merge hotspot annotation to recurrence table and save fot strelka
```{r}
combined_recurrence %>%
    dplyr::mutate(
      Amino_Acid_Position = 
        # strip protein length
        gsub("/.*","",Protein_position)
    ) %>%
    dplyr::mutate(
      hotspot = case_when(
        Amino_Acid_Position %in% 
          # if overlaps the hotspot snv Amino_Acid_Position 
          hotspot_database_2017_snv$Amino_Acid_Position &
          Hugo_Symbol %in% hotspot_database_2017_snv$Hugo_Symbol ~ "Yes",
        Amino_Acid_Position %in% 
          # if overlaps the hotspot snv Amino_Acid_Position 
          hotspot_database_2017_indel$Amino_Acid_Position &
          Hugo_Symbol %in%  hotspot_database_2017_indel$Hugo_Symbol~ "Yes"
      )
    ) %>%
  write_tsv(file.path(results_dir,"snv_recurrence.tsv"))


```


```{r}
DBI::dbDisconnect(con)
```

