---
title: "Circos Plots Examples for Visualizing SV and CNV data"
output:   
  html_notebook: 
    toc: true
    toc_float: true
author: Candace Savonen for ALSF - CCDL
date: 2020
---

This notebook shows examples of how to use the circos_map_plot function for 
mapping data that corresponds to chromosomal coordinates.

### Usage

This notebook can be run via the command line from the top directory of the 
repository as follows:

```
Rscript -e "rmarkdown::render('analyses/chromosomal-instability/01b-visulization-cnv-sv.Rmd', 
                              clean = TRUE)"
```

### Set Up

```{r}
# Set seed so heatmaps turn out the same
set.seed(2020)

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

Read in the custom functions needed for this analysis. 

```{r}
source(file.path("util", "circos-plots.R"))
```

### Directories and Files

```{r}
# Path to data directory
data_dir <- file.path("..", "..", "data")
scratch_dir <- file.path("..", "..", "scratch")
sv_vcf <- 
# Path to output directory
plots_dir <- "plots"

# Path to tumor type plots output directory
hist_plots_dir <- file.path(plots_dir, "tumor-type")

# Create the hist_plots_dir  if it does not exist
if (!dir.exists(hist_plots_dir)) {
  dir.create(hist_plots_dir, recursive = TRUE)
}
```

```{r}

```

### Read in data 

Set up metadata

```{r}
# Read in the metadata
metadata <- readr::read_tsv(file.path(data_dir, "pbta-histologies.tsv"))
```

Load in the previously formatted breakpoint data. 

```{r}
breaks_list <- readr::read_rds(file.path("breakpoint-data", "breaks_lists.RDS"))
```

Read in the CNV data. 

```{r}
cnv_df <- data.table::fread(
  file.path(data_dir, "pbta-cnv-cnvkit.seg.gz"), data.table = FALSE) 
```

Read in the formatted SV data. 

```{r}
# Get the file names for the 
sv_files <- list.files(file.path(scratch_dir, "sv-vcf"), 
                       pattern = "_withoutYandM.tsv", 
                       full.names = TRUE)

# Read in each of the sample's files
sv_data <- lapply(sv_files, function(sv_file){
                  readr::read_tsv(sv_file, 
                                  # Set default as character
                                  col_types = readr::cols(.default = "c"))
})

# Name the dataset by their biospecimen ID
names(sv_data) <- gsub("_withoutYandM.tsv", "", stringr::word(sv_files, sep = "/", 5))

# Collapse into one data.frame
sv_df <- dplyr::bind_rows(sv_data, .id = "biospecimen_id")
```

Example uses of `circos_map_plot`

```{r}
circos_map_plot(df = breaks_list$sv_breaks,
                add_track = FALSE,
                samples_col = "samples",
                sample_names = "all",
                chr_col = "chrom",
                start_col = "coord",
                end_col =  "coord",
                y_val = NULL,
                track_height = .15,
                type = "rect",
                colour_key = "svclass", 
                palette = "YlGnBu") 
```

### Session Info

```{r}
sessionInfo()
```

