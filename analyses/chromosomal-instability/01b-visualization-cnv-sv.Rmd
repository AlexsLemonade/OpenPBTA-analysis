---
title: "Circos Plots Examples for Visualizing SV and CNV data"
output:   
  html_notebook: 
    toc: true
    toc_float: true
author: Candace Savonen for ALSF - CCDL
date: 2020
---

This notebook shows examples of how to use the circos_map_plot function for 
mapping data that corresponds to chromosomal coordinates.

### Usage

This notebook can be run via the command line from the top directory of the 
repository as follows:

```
Rscript -e "rmarkdown::render('analyses/chromosomal-instability/01b-visulization-cnv-sv.Rmd', 
                              clean = TRUE)"
```

### Set Up

```{r}
# Set seed so heatmaps turn out the same
set.seed(2020)

# Magrittr pipe
`%>%` <- dplyr::`%>%`
```

Read in the custom functions needed for this analysis. 

```{r}
source(file.path("util", "circos-plots.R"))
```

### Directories and Files

```{r}
# Path to data directory
data_dir <- file.path("..", "..", "data")
scratch_dir <- file.path("..", "..", "scratch")
sv_vcf_dir <- file.path(scratch_dir, "sv-vcf")

# Path to output directory
plots_dir <- "plots"

# Path to tumor type plots output directory
hist_plots_dir <- file.path(plots_dir, "tumor-type")

# Create the hist_plots_dir  if it does not exist
if (!dir.exists(hist_plots_dir)) {
  dir.create(hist_plots_dir, recursive = TRUE)
}
```

Run the SV process script if its output folder doesn't exist. 

```{r}
if (!dir.exists(sv_vcf_dir)) {
  source(file.path("..", "sv-analysis", "01-process-sv-file.R"))
}
```

### Read in data 

Set up metadata

```{r}
# Read in the metadata
metadata <- readr::read_tsv(file.path(data_dir, "pbta-histologies.tsv"))
```

Read in the CNV data. 

```{r}
cnv_df <- data.table::fread(
  file.path(data_dir, "pbta-cnv-cnvkit.seg.gz"), data.table = FALSE) 
```

Make a translocation data.frame. 

```{r}
sv_df <- data.table::fread(
  file.path(data_dir, "pbta-sv-manta.tsv.gz"), data.table = FALSE)
```

Make a translocation data.frame. 

```{r}
transloc_df <- sv_df %>% 
  dplyr::filter(SV.type == "BND") %>% 
  dplyr::mutate(match_id = substr(ID, 0,  nchar(ID) -2), 
                pair_num = substr(ID, nchar(ID),  nchar(ID))) %>% 
  dplyr::select(biospecimen_id = Kids.First.Biospecimen.ID.Tumor, 
                chrom = SV.chrom, 
                start = SV.start, 
                end = SV.end, 
                widht = SV.length, 
                match_id, 
                pair_num)

transloc_df  <- transloc_df %>% 
  dplyr::filter(pair_num == 0) %>% 
  dplyr::inner_join(filter(transloc_df, pair_num == 1), by = "match_id", 
                    suffix = c("1", "2"))
```

## Example uses of `circos_map_plot`

**Example 1** making a Circos plot that is color-coded circos by a factor.

```{r}
# Let's make a variable that specifies whether the data is a deletion or amplication. 
cnv_df <- cnv_df %>% 
  dplyr::mutate(direction = dplyr::case_when(seg.mean < 0 ~ "del", 
                                             seg.mean > 0 ~ "amp", 
                                             seg.mean == 0 ~"neutral"), 
                direction = as.factor(direction))
```

Create a Circos plot for a single sample.
For that same sample, let's add the translocations. 

```{r}
circos_map_plot(df = cnv_df, 
                add_track = FALSE,
                samples_col = "ID",
                sample_names = "BS_007JTNB8",
                chr_col = "chrom",
                start_col = "loc.start",
                end_col =  "loc.end",
                y_val = "copy.num",
                track_height = .15,
                type = "line",
                colour_key = "direction",
                palette = "YlGnBu") 

# Now add the translocation bit. 
circos_map_transloc(transloc_df, 
                    add_track = FALSE, # We change this to true to add on to our already existing plot
                    sample_names = "BS_007JTNB8",
                    samples_col = "biospecimen_id1",
                    chr_col_1 = "chrom1",
                    chr_col_2 = "chrom2",
                    start_col_1 = "start1",
                    start_col_2 = "start2",
                    end_col_1 =  "end1",
                    end_col_2 =  "end2")
```

### Session Info

```{r}
sessionInfo()
```

