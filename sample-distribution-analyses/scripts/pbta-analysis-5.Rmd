---
title: "Distribution of samples across cancer types"
output:
  html_notebook: 
    toc: true
    toc_float: true
---


Chante Bethell - CCDL 

This notebook addresses [issue #5](https://github.com/AlexsLemonade/OpenPBTA-analysis/issues/5) in the OpenPBTA-analysis. 
The distribution of samples by cancer type is determined and visually represented below. 

## Load in libraries and functions. Read in dataset files.  

```{r echo=TRUE, message=FALSE, warning=FALSE}

# Load/install packages. This will be removed once a Dockerfile is established. 
source(file.path("..", "scripts", "install-packages.R"))

# magrittr pipe
`%>%` <- dplyr::`%>%`

# Function to filter dataset based on primary_site of disease, while arranging the cancer types in order of descending expression
location_fn <- function(location) {
  brain_location %>%
    arrange(desc(n)) %>%
    filter(str_detect(primary_site, location))
}

# Function to pad x with NA's
na.pad <- function(x, len){
  x[1:len]
}

# Function to make a padded data.frame
makePaddedDataFrame <- function(l, ...){
  maxlen <- max(sapply(l, length))
  data.frame(lapply(l, na.pad, len = maxlen), ...)
}

# Create directories to hold the output.
if (!dir.exists("../results")) {
  dir.create("../results")
}
if (!dir.exists("../plots")) {
  dir.create("../plots")
}

df2 <- data.frame(read_tsv(file.path("..", "data", "2019-07-26-pbta-histologies - 2019-07-26-including-germline.tsv")))
```

## Filter the dataset.

```{r}
# Remove na's 
df2 <- df2 %>%
  filter(!is.na(disease_type_new))

# data.frame with the count of each unique cancer type expression 
disease.expression <- df2 %>%
  group_by(disease_type_new) %>%
  filter(!is.na(disease_type_new)) %>%
  count() %>%
  arrange(desc(n)) %>%
  rename(count = n)

# Calculate the total count of the dataset 
sum.count <- sum(disease.expression$count)

# Create a percent variable 
disease.expression <- disease.expression %>%
  mutate(percent = (count/sum.count))

disease.expression$percent <- percent(disease.expression$percent)
disease.expression$disease_type_new <- with(disease.expression, reorder(disease_type_new, -count))

```


**Create a table of `disease.type` with each corresponding sample count and percentage.**

```{r}

disease.expression.table <- kable(disease.expression, booktabs = TRUE) %>%
  kable_styling(bootstrap_options = "condensed", 
                full_width = FALSE, font_size = 8) 
disease.expression.table  
```


A table displaying the cancer types across the unique primary sites is produced by the `pbta-analysis-5.R` script.   
This table can be found at `file.path("..", "results", "primary_sites_table.pdf")`.



## Plot sample distribution across cancer types

```{r, fig.width = 18, fig.height = 14}

gg.types <- disease.expression %>%
  ggplot(aes(x = disease_type_new, y = count, fill = count)) + 
  geom_col() +
  theme_bw() +
  labs(x = "Cancer Types", y = "Count", 
       title = "Sample Distribution Across Cancer Types") +
  scale_y_continuous(breaks = seq(0, 500, by = 100)) + 
  theme(axis.text.x = element_text(angle = 75, hjust =1, size = 8), 
        panel.grid = element_blank()) +
  geom_text(nudge_y = 6.5, size = 2, 
            aes(label = paste0(disease.expression$percent)))

gg.types 

```

## Treemap 

**Create a treemap to represent the broad histology, short histology, and cancer types, respectively.**
*Cancer types will be replaced by molecular subtypes after the completion of the relevant analysis.*

```{r, fig.width = 18, fig.height = 14}
color <- colorblindr::palette_OkabeIto

sun.df <- df2 %>% 
  select(broad_histology, short_histology, disease_type_new) %>%
  filter(!is.na(disease_type_new)) %>%
  filter(!is.na(broad_histology)) %>%
  filter(!is.na(short_histology)) %>%
  group_by(broad_histology)

sun.df.sub <- sun.df[,c("broad_histology", "short_histology", "disease_type_new")]
sun.df.sub$nodes <- paste0(sun.df.sub[[1]], ",", sun.df.sub[[2]], ",", sun.df.sub[[3]])

# Make node patterns
names(sun.df.sub) <- c("level1", "level2", "level3", "nodes")

# Sum each unique combination
counts <- sun.df.sub %>% 
  group_by(nodes) %>%
  dplyr::summarise(size = n())

counts <- counts[!grepl("^NA-", counts$nodes), ]

final <- merge(sun.df.sub, counts, all.x = T)
col.order <- c("level1", "level2", "level3",
               "size", "nodes")
final <- final[, col.order]
final$nodes <- NULL 

tm <- treemap(final, index = c("level1", "level2", "level3"), vSize = "size", vColor = color, draw = TRUE)
tmnest <- d3_nest(tm$tm[, c("level1", "level2", "level3", "vSize")],
                  value_cols = c("vSize"))

```
**Would this plot be a good addition to the first figure?**

## Sunburst plot

**Let's take look at the sund2b sunburst plot.**
The color scheme used is colorblind-friendly, but limited.   
I produced the same plot but with a different color scheme (which is also colorblind-friendly).  
This plot can be accessed by running the shiny application located at `file.path("..", "scripts", "histology-app.R")`.

```{r}
sun.plot <- sunburst(
  data = tmnest,
  valueField = "vSize",
  count = TRUE,
  sumNodes = FALSE,
  colors = color,
  legend = list(w = 280)
)

sun.plot
```

**Does this plot seem to represent the data accurately?**

## Session Info 

```{r}
sessionInfo()
```

