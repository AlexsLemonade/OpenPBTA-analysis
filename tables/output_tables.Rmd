---
title: "Tables output for manuscript"
author: "Run Jin and Stephanie J. Spielman"
date: "2021-2022"
output:
  html_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
library(openxlsx)
```

## Output Tables for OpenPBTA Manuscript

This Rmarkdown generates tables used in the manuscript, including both main text and supplementary material. 

```{r define directories and result files}
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))
working_dir <- file.path(root_dir, "tables")
analyses_dir <- file.path(root_dir, "analyses")
data_dir <- file.path(root_dir, "data", "release-v21-20210820")

results_dir <- file.path(working_dir, "results")
if(!dir.exists(results_dir)){
  dir.create(results_dir, recursive=TRUE)
}


# Define input files
tmb_all_file <- file.path(data_dir, "pbta-snv-consensus-mutation-tmb-all.tsv")
tmb_coding_file <- file.path(data_dir, "pbta-snv-consensus-mutation-tmb-coding.tsv")
mutsigs_file <- file.path(analyses_dir, "mutational-signatures", "results", "deconstructsigs_exposures_merged.tsv")
chromo_file <- file.path(analyses_dir, "chromothripsis", "results", "chromothripsis_summary_per_sample.txt")
tp53_file <- file.path(analyses_dir, "tp53_nf1_score", "results", "tp53_altered_status.tsv")
quantiseq_file <- file.path(analyses_dir, "immune-deconv", "results", "quantiseq_deconv-output.rds")

# define output files and sheet names, when appropriate
table_1_file <- file.path(results_dir, "Table1-molecular-subtypes.tsv")
table_s1_file <- file.path(results_dir, "TableS1-histologies.xlsx")
table_s2_file <- file.path(results_dir, "TableS2-DNA-results-table.xlsx")
table_s3_file <- file.path(results_dir, "TableS3-RNA-results-table.xlsx")
```

## Table 1: Molecular subtypes determined for this project
```{r table 1}
histology_df <- read_tsv(file.path(data_dir, "pbta-histologies.tsv"), guess_max =10000)

histology_df %>%
  # remove rows to not include
  filter(!is.na(pathology_diagnosis),
         !is.na(molecular_subtype),
         !grepl("To be classified", molecular_subtype)) %>%
  # Count broad histology and subtype combinations
  count(broad_histology, molecular_subtype) %>%
  # export
  write_tsv(table_1_file)

```

## Table S1: V21 histologies table

```{r v21 histology as excel}
# Define array of samples that need to be classified 
to_be_classified_samples <- c("BS_3J4T2YYW", "BS_7F07M7JG", "BS_AG0BZN6F", "BS_HZNKSQ17", "BS_V6HKXX1Z", "BS_WP9J88EB", "BS_YYAPSA5P")

histology_df %>% 
  # Update definitions of molecular subtype for TBD samples
  mutate(molecular_subtype = ifelse(
    Kids_First_Biospecimen_ID %in% to_be_classified_samples,
    "MB, To be classified",
    molecular_subtype
  )) %>%
  # prepare for export to an excel
  mutate_all(as.character) %>% 
  replace(is.na(.), "NA") %>%
  # export
  write.xlsx(table_s1_file, overwrite=TRUE)
```

## Table S2: DNA results table
### TMB
```{r s2 DNA results part 1}

# read in tmb all file, select and rename columns
tmb_all <- read_tsv(tmb_all_file) %>%
  select(Tumor_Sample_Barcode, tmb) %>%
  rename(Kids_First_Biospecimen_ID = Tumor_Sample_Barcode) %>% 
  rename(Tmb_all = tmb) 

# read in tmb coding file, select and rename columns
tmb_coding <- read_tsv(tmb_coding_file) %>%
  select(Tumor_Sample_Barcode, tmb) %>%
  rename(Kids_First_Biospecimen_ID = Tumor_Sample_Barcode) %>% 
  rename(Tmb_coding = tmb)

# combine files
tmb_combined <- full_join(tmb_all, tmb_coding) %>%
  mutate_all(as.character) %>% 
  replace(is.na(.), "NA")
```

### CNS mutational signatures
```{r s2 DNA results part 2}
# use the deconstructSigs table, not the sigfit table, for consistency with main text
# for convenience we can load the file deconstructsigs_exposures_merged.tsv which already has full sample information "merged" in _and_ uses the correct Signal RefSig names
cns_mut_list <- read_tsv(mutsigs_file)

cns_signatures <- cns_mut_list %>%
  select(Kids_First_Biospecimen_ID, exposure, signature) %>%
  # label signatures more clearly as RefSig or other
  mutate(signature = ifelse(
    signature == "Other", 
    "Other signatures",
    glue::glue("RefSig_{signature}")
  )) %>%
  spread(signature, exposure) %>%
  # order columns so "Other" is at the end
  select(Kids_First_Biospecimen_ID, contains("RefSig"), everything())

```

### Chromothripsis regions per sample
```{r s2 DNA results part 3}
chromothripsis_region_df <- readr::read_tsv(chromo_file)  

```

### combine S2 table
```{r s2 DNA results combined}
list_s2_table <- list(tumor_mutation_burden = tmb_combined,
                      fitted_cns_mutational_signatures = cns_signatures,
                      chromothripsis_events = chromothripsis_region_df
                     )
write.xlsx(list_s2_table, 
           table_s2_file,
           overwrite=TRUE)
```

## Table S3: RNA results table
### TP53 scores
```{r s3 RNA results table p1}
# get tp53 scores 
tp53_scores <- read_tsv(tp53_file) %>%
  mutate_all(as.character) %>% 
  replace(is.na(.), "NA")
```

### Telomerase scores
```{r s3 RNA results table p2}
# get extend scores file
telomerase_scores_polya_count <-
  read_tsv("../analyses/telomerase-activity-prediction/results/TelomeraseScores_PTBAPolya_counts.txt") %>%
  select(SampleID, NormEXTENDScores) %>% 
  rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                NormEXTENDScores_counts = NormEXTENDScores)

telomerase_scores_polya_fpkm <-
  read_tsv("../analyses/telomerase-activity-prediction/results/TelomeraseScores_PTBAPolya_FPKM.txt") %>%
  select(SampleID, NormEXTENDScores) %>% 
  rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                NormEXTENDScores_fpkm = NormEXTENDScores)

telomerase_scores_polya_combined <- full_join(telomerase_scores_polya_count,
                                              telomerase_scores_polya_fpkm)
  
telomerase_scores_stranded_count <-
  read_tsv("../analyses/telomerase-activity-prediction/results/TelomeraseScores_PTBAStranded_counts.txt") %>%
  select(SampleID, NormEXTENDScores) %>% 
  rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                NormEXTENDScores_counts = NormEXTENDScores)

telomerase_scores_stranded_fpkm <-
  read_tsv("../analyses/telomerase-activity-prediction/results/TelomeraseScores_PTBAStranded_FPKM.txt") %>%
  select(SampleID, NormEXTENDScores) %>% 
  rename(Kids_First_Biospecimen_ID_RNA = SampleID,
                NormEXTENDScores_fpkm = NormEXTENDScores)

telomerase_scores_stranded_combined <- full_join(telomerase_scores_stranded_count,
                                                 telomerase_scores_stranded_fpkm)

telomerase_scores_combined <- bind_rows(telomerase_scores_polya_combined,
                                        telomerase_scores_stranded_combined)  %>%
  mutate_all(as.character) %>% 
  replace(is.na(.), "NA")

```

### Telomerase scores
```{r s3 RNA results table p3}
# get quantiseq immune scores file
quantiseq_immune <- read_rds(quantiseq_file) %>%
  select(sample, score, cell_type) %>% 
  rename(Kids_First_Biospecimen_ID_RNA = sample) %>%
  spread(cell_type, score)
```


### combine and output file
```{r s3 table combine and output}
list_s3_table <- list(tp53_scores = tp53_scores,
                      telomerase_scores = telomerase_scores_combined,
                      quantiseq_immune_deconvolution_fractions = quantiseq_immune
                      )
write.xlsx(list_s3_table, 
           table_s3_file, 
           overwrite=TRUE)

```

### print out session info
```{r}
sessionInfo()
```

